<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>市場情資與競品分析平台 (V6 - 進階分析版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .step-btn {
            transition: all 0.3s ease;
        }
        
        .step-btn:hover {
            transform: translateY(-2px);
        }
        
        .step-btn.active {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // 全域狀態管理
        window.state = {
            isAuthenticated: false,
            apiConfigured: false,
            currentStep: 1,
            analysisData: {},
            settings: {
                googleApiKey: '',
                searchEngineId: '',
                centralFolderName: 'iStaging_專案管理',
                intelligenceSubfolder: '01_市場情資分析',
                mediaplanSubfolder: '02_媒體提案',
                workflowSubfolder: '03_工作流程文件'
            }
        };

        // 頁面載入完成後初始化
        window.addEventListener('load', function() {
            console.log('頁面載入完成，開始初始化...');
            
            // 使用 Promise 包裝初始化，避免未捕獲的錯誤
            initializeApp()
                .then(() => {
                    console.log('初始化完成');
                })
                .catch(error => {
                    console.error('初始化過程中發生錯誤:', error);
                    showAlert('初始化錯誤', '頁面初始化失敗，請重新整理頁面', 'error');
                });
        });

        // 全域錯誤處理
        window.addEventListener('error', function(event) {
            console.error('全域錯誤:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的 Promise 拒絕:', event.reason);
            event.preventDefault(); // 防止預設的錯誤處理
        });

        // 顯示警告訊息
        function showAlert(title, message, type = 'info') {
            try {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-4 rounded-lg shadow-lg ${
                    type === 'error' ? 'bg-red-600 text-white' :
                    type === 'success' ? 'bg-green-600 text-white' :
                    type === 'warning' ? 'bg-yellow-600 text-white' :
                    'bg-blue-600 text-white'
                }`;
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm mt-1">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                alertContainer.appendChild(alertDiv);

                // 自動移除警告
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('顯示警告失敗:', error);
            }
        }

        // 初始化應用程式
        function initializeApp() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('初始化應用程式...');
                    
                    // 載入設定
                    loadSettings();
                    
                    // 設定事件監聽器
                    setupEventListeners();
                    
                    // 檢查 URL 參數
                    checkUrlParameters();
                    
                    // 更新 UI 狀態
                    updateUIState();
                    
                    // 延遲再次檢查 URL 參數，確保 DOM 完全載入
                    setTimeout(() => {
                        checkUrlParameters();
                    }, 500);
                    
                    console.log('應用程式初始化完成');
                    resolve();
                } catch (error) {
                    console.error('應用程式初始化失敗:', error);
                    reject(error);
                }
            });
        }

        // 載入設定
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('intelligence_settings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    state.settings = { ...state.settings, ...parsed };
                    
                    // 更新表單欄位
                    const apiKeyInput = document.getElementById('google-api-key');
                    const searchEngineInput = document.getElementById('search-engine-id');
                    const geminiApiKeyInput = document.getElementById('gemini-api-key');
                    const centralFolderInput = document.getElementById('central-folder-name');
                    const intelligenceSubfolderInput = document.getElementById('intelligence-subfolder');
                    const mediaplanSubfolderInput = document.getElementById('mediaplan-subfolder');
                    const workflowSubfolderInput = document.getElementById('workflow-subfolder');
                    
                    if (apiKeyInput) apiKeyInput.value = state.settings.googleApiKey || '';
                    if (searchEngineInput) searchEngineInput.value = state.settings.searchEngineId || '';
                    if (geminiApiKeyInput) geminiApiKeyInput.value = state.settings.geminiApiKey || '';
                    if (centralFolderInput) centralFolderInput.value = state.settings.centralFolderName || '';
                    if (intelligenceSubfolderInput) intelligenceSubfolderInput.value = state.settings.intelligenceSubfolder || '';
                    if (mediaplanSubfolderInput) mediaplanSubfolderInput.value = state.settings.mediaplanSubfolder || '';
                    if (workflowSubfolderInput) workflowSubfolderInput.value = state.settings.workflowSubfolder || '';
                }
            } catch (error) {
                console.warn('載入設定失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 設定事件監聽器
        function setupEventListeners() {
            try {
                // 標籤頁切換
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const tab = this.dataset.tab;
                            switchTab(tab);
                        });
                    }
                });

                // 儲存設定按鈕
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', saveSettings);
                }

                // Google 登入按鈕
                const authorizeBtn = document.getElementById('authorize_button');
                if (authorizeBtn) {
                    authorizeBtn.addEventListener('click', handleGoogleAuth);
                }

                // 登出按鈕
                const signoutBtn = document.getElementById('signout_button');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', handleSignOut);
                }

                // 步驟切換 - 修正事件監聽器
                const stepCircles = document.querySelectorAll('.step-circle');
                stepCircles.forEach((circle, index) => {
                    if (circle) {
                        circle.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const step = index + 1;
                            console.log(`點擊步驟 ${step}`);
                            goToStep(step);
                        });
                    }
                });

                // 設定步驟 1 的事件監聽器
                setupStep1EventListeners();

                console.log('事件監聽器設定完成');
            } catch (error) {
                console.error('設定事件監聽器失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 檢查 URL 參數
        function checkUrlParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                
                if (projectId) {
                    console.log('發現 URL 參數 projectId:', projectId);
                    
                    // 使用重試機制確保 DOM 元素已載入
                    const setProjectId = () => {
                        const projectIdInput = document.getElementById('project-id');
                        if (projectIdInput) {
                            projectIdInput.value = projectId;
                            console.log('成功設置 project ID:', projectId);
                        } else {
                            console.log('project-id 元素尚未載入，延遲重試...');
                            setTimeout(setProjectId, 100);
                        }
                    };
                    
                    // 立即嘗試設置，如果失敗則延遲重試
                    setProjectId();
                }
            } catch (error) {
                console.warn('檢查 URL 參數失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 更新 UI 狀態
        function updateUIState() {
            try {
                const appContainer = document.getElementById('app-container');
                const analysisPanel = document.getElementById('analysis-panel');
                const historyPanel = document.getElementById('history-panel');
                const isConfigured = state.settings.googleApiKey && state.settings.searchEngineId && state.settings.geminiApiKey;
                
                // 移除 app-container 的 locked class，改為只鎖定特定面板
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
                
                // 只有分析系統和歷史紀錄需要 API 設定
                if (analysisPanel) {
                    if (isConfigured) {
                        analysisPanel.classList.remove('locked');
                        state.apiConfigured = true;
                    } else {
                        analysisPanel.classList.add('locked');
                        state.apiConfigured = false;
                    }
                }
                
                if (historyPanel) {
                    if (isConfigured) {
                        historyPanel.classList.remove('locked');
                    } else {
                        historyPanel.classList.add('locked');
                    }
                }

                // 預設顯示 API 設定分頁
                switchTab('settings');
            } catch (error) {
                console.error('更新 UI 狀態失敗:', error);
            }
        }

        // 切換標籤頁
        function switchTab(tabName) {
            try {
                // 移除所有標籤頁的 active 狀態
                const tabButtons = document.querySelectorAll('.tab-btn');
                const panels = document.querySelectorAll('.panel');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                panels.forEach(panel => panel.classList.remove('active'));
                
                // 啟用選中的標籤頁
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                const activePanel = document.getElementById(`${tabName}-panel`);
                
                if (activeTab) activeTab.classList.add('active');
                if (activePanel) activePanel.classList.add('active');
                
                console.log(`切換到標籤頁: ${tabName}`);
            } catch (error) {
                console.error('切換標籤頁失敗:', error);
            }
        }

        // 儲存設定
        function saveSettings() {
            try {
                const apiKey = document.getElementById('google-api-key')?.value || '';
                const searchEngineId = document.getElementById('search-engine-id')?.value || '';
                const geminiApiKey = document.getElementById('gemini-api-key')?.value || '';
                const centralFolderName = document.getElementById('central-folder-name')?.value || '';
                const intelligenceSubfolder = document.getElementById('intelligence-subfolder')?.value || '';
                const mediaplanSubfolder = document.getElementById('mediaplan-subfolder')?.value || '';
                const workflowSubfolder = document.getElementById('workflow-subfolder')?.value || '';

                // 更新狀態
                state.settings = {
                    googleApiKey: apiKey,
                    searchEngineId: searchEngineId,
                    geminiApiKey: geminiApiKey,
                    centralFolderName: centralFolderName,
                    intelligenceSubfolder: intelligenceSubfolder,
                    mediaplanSubfolder: mediaplanSubfolder,
                    workflowSubfolder: workflowSubfolder
                };

                // 儲存到 localStorage
                localStorage.setItem('intelligence_settings', JSON.stringify(state.settings));

                // 更新 UI 狀態
                updateUIState();

                showAlert('設定已儲存', 'API 設定已成功儲存', 'success');
                
                // 如果 API 已設定，切換到分析系統
                if (apiKey && searchEngineId && geminiApiKey) {
                    setTimeout(() => {
                        switchTab('analysis');
                    }, 1000);
                }
            } catch (error) {
                console.error('儲存設定失敗:', error);
                showAlert('儲存失敗', error.message, 'error');
            }
        }

        // 步驟切換功能
        function goToStep(step) {
            try {
                console.log(`切換到步驟 ${step}`);
                
                // 隱藏所有步驟面板
                const stepPanels = document.querySelectorAll('.step-panel');
                stepPanels.forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // 移除所有步驟的 active 狀態
                const stepButtons = document.querySelectorAll('.step-btn');
                stepButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-techprimary', 'text-white');
                    btn.classList.add('bg-gray-600', 'text-gray-300');
                });
                
                // 顯示目標步驟
                const targetPanel = document.getElementById(`step-${step}`);
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                }
                
                // 更新步驟按鈕狀態
                const currentStepBtn = document.getElementById(`step-${step}-btn`);
                if (currentStepBtn) {
                    currentStepBtn.classList.add('active', 'bg-techprimary', 'text-white');
                    currentStepBtn.classList.remove('bg-gray-600', 'text-gray-300');
                }
                
                // 如果是步驟 2，執行額外的初始化
                if (step === 2) {
                    try {
                        console.log('步驟 2 載入初始化開始...');
                        
                        // 更新當前主題顯示
                        const currentTopicElement = document.getElementById('current-topic');
                        if (currentTopicElement && state.analysisData.topic) {
                            currentTopicElement.textContent = state.analysisData.topic;
                        }
                        
                        // 自動搜尋競爭對手
                        if (state.analysisData.topic && state.analysisData.brand) {
                            setTimeout(() => {
                                searchCompetitors();
                            }, 500);
                        }
                        
                        // 更新已選擇競爭對手顯示
                        updateSelectedCompetitorsDisplay();
                        
                        // 更新生成報告按鈕狀態
                        updateGenerateReportButton();
                        
                        console.log('步驟 2 載入初始化完成');
                        
                    } catch (error) {
                        console.error('步驟 2 載入失敗:', error);
                    }
                }
                
                // 如果是步驟 3，顯示完整報告
                if (step === 3) {
                    displayFinalReport();
                }
                
            } catch (error) {
                console.error('切換步驟失敗:', error);
            }
        }

        // 開始分析
        function startAnalysis() {
            try {
                // 收集所有資料
                const brandName = document.getElementById('brand-name')?.value?.trim();
                const brandWebsite = document.getElementById('brand-website')?.value?.trim();
                const brandDescription = document.getElementById('brand-description')?.value?.trim();
                const industryCategory = document.getElementById('industry-category')?.value;
                const marketSize = document.getElementById('market-size')?.value;
                const topic = document.getElementById('analysis-topic')?.value?.trim();
                const projectId = document.getElementById('project-id')?.value?.trim();
                const competitorCount = document.getElementById('competitor-count')?.value;
                const analysisDepth = document.querySelector('input[name="analysis-depth"]:checked')?.value;

                // 驗證必填欄位
                if (!brandName) {
                    showAlert('請填寫品牌名稱', '品牌名稱為必填項目', 'warning');
                    return;
                }

                if (!industryCategory) {
                    showAlert('請選擇行業類別', '行業類別為必填項目', 'warning');
                    return;
                }

                if (!topic) {
                    showAlert('請填寫分析主題', '分析主題為必填項目', 'warning');
                    return;
                }

                // 收集產品和關鍵字資料
                const products = collectProductsData();
                const keywords = collectKeywordsData();

                // 儲存分析設定
                state.analysisData = {
                    brand: {
                        name: brandName,
                        website: brandWebsite,
                        description: brandDescription
                    },
                    products: products,
                    industry: {
                        category: industryCategory,
                        marketSize: marketSize
                    },
                    topic: topic,
                    projectId: projectId || `TEMP_${Date.now()}`,
                    competitorCount: parseInt(competitorCount),
                    analysisDepth: analysisDepth,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                };

                showAlert('分析設定已儲存', '正在準備競爭對手分析...', 'success');
                
                // 切換到步驟 2
                setTimeout(() => {
                    goToStep(2);
                }, 1000);

            } catch (error) {
                console.error('開始分析失敗:', error);
                showAlert('分析失敗', error.message, 'error');
            }
        }

        // 收集產品資料
        function collectProductsData() {
            try {
                const products = [];
                const productItems = document.querySelectorAll('.product-item');
                
                productItems.forEach(item => {
                    const name = item.querySelector('.product-name')?.value?.trim();
                    const pricing = item.querySelector('.product-pricing')?.value;
                    const target = item.querySelector('.product-target')?.value?.trim();
                    
                    if (name) {
                        products.push({
                            name: name,
                            pricing: pricing,
                            target: target
                        });
                    }
                });
                
                return products;
            } catch (error) {
                console.error('收集產品資料失敗:', error);
                return [];
            }
        }

        // 收集關鍵字資料
        function collectKeywordsData() {
            const primaryKeywords = document.getElementById('primary-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const longTailKeywords = document.getElementById('long-tail-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const businessModel = document.getElementById('business-model-select')?.value || '';
            
            return {
                primary: primaryKeywords,
                longTail: longTailKeywords,
                marketPositioning: {
                    businessModel: businessModel,
                    targetMarket: 'tw', // 預設台灣
                    targetAudience: 'general',
                    primaryLanguage: 'zh-TW',
                    localizationLevel: 'high'
                },
                depth: 'comprehensive'
            };
        }

        // Google 認證處理 - 簡化版本
        function handleGoogleAuth() {
            try {
                // 檢查是否已載入 Google API
                if (typeof gapi === 'undefined') {
                    showAlert('Google API 未載入', '請檢查網路連線並重新整理頁面', 'error');
                    return;
                }

                // 檢查 Google Client ID 是否已設定
                const clientId = '733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com';
                
                // 初始化 Google API
                gapi.load('auth2', function() {
                    gapi.auth2.init({
                        client_id: clientId,
                        scope: 'profile email' // 只要求基本權限
                    }).then(function(auth2) {
                        // 登入
                        auth2.signIn().then(function(googleUser) {
                            const profile = googleUser.getBasicProfile();
                            state.isAuthenticated = true;
                            state.userProfile = {
                                id: profile.getId(),
                                name: profile.getName(),
                                email: profile.getEmail(),
                                imageUrl: profile.getImageUrl()
                            };
                            
                            updateAuthUI();
                            showAlert('登入成功', `歡迎 ${profile.getName()}`, 'success');
                            
                            // 解鎖應用程式
                            unlockApp();
                        }).catch(function(error) {
                            console.error('Google 登入失敗:', error);
                            showAlert('登入失敗', 'Google 登入失敗，請重試', 'error');
                        });
                    }).catch(function(error) {
                        console.error('Google API 初始化失敗:', error);
                        showAlert('初始化失敗', 'Google API 初始化失敗，請檢查網路連線', 'error');
                    });
                });
            } catch (error) {
                console.error('Google 認證失敗:', error);
                showAlert('認證失敗', error.message, 'error');
            }
        }

        // 解鎖應用程式
        function unlockApp() {
            try {
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
            } catch (error) {
                console.error('解鎖應用程式失敗:', error);
            }
        }

        // 登出處理
        function handleSignOut() {
            try {
                if (typeof gapi !== 'undefined' && gapi.auth2) {
                    const auth2 = gapi.auth2.getAuthInstance();
                    auth2.signOut().then(function() {
                        state.isAuthenticated = false;
                        state.userProfile = null;
                        updateAuthUI();
                        showAlert('已登出', '您已成功登出 Google 帳戶', 'info');
                    });
                } else {
                    state.isAuthenticated = false;
                    state.userProfile = null;
                    updateAuthUI();
                    showAlert('已登出', '您已成功登出', 'info');
                }
            } catch (error) {
                console.error('登出失敗:', error);
                showAlert('登出失敗', '登出過程中發生錯誤', 'error');
            }
        }

        // 更新認證 UI
        function updateAuthUI() {
            try {
                const userProfile = document.getElementById('user-profile');
                const authorizeBtn = document.getElementById('authorize_button');
                const signoutBtn = document.getElementById('signout_button');
                const userAvatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');

                if (state.isAuthenticated && state.userProfile) {
                    // 顯示用戶資訊
                    if (userProfile) userProfile.classList.remove('hidden');
                    if (authorizeBtn) authorizeBtn.classList.add('hidden');
                    if (signoutBtn) signoutBtn.classList.remove('hidden');
                    
                    if (userAvatar && state.userProfile.imageUrl) {
                        userAvatar.src = state.userProfile.imageUrl;
                    }
                    if (userName) {
                        userName.textContent = state.userProfile.name;
                    }
                } else {
                    // 顯示登入按鈕
                    if (userProfile) userProfile.classList.add('hidden');
                    if (authorizeBtn) authorizeBtn.classList.remove('hidden');
                    if (signoutBtn) signoutBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('更新認證 UI 失敗:', error);
            }
        }

        // 初始化 Google Drive API
        function initializeGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    console.warn('用戶未登入，無法初始化 Google Drive API');
                    return;
                }

                // 載入 Google Drive API
                gapi.load('client', function() {
                    gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    }).then(function() {
                        console.log('Google Drive API 初始化成功');
                        showAlert('Google Drive 已準備就緒', '可以開始使用檔案儲存功能', 'success');
                    }).catch(function(error) {
                        console.error('Google Drive API 初始化失敗:', error);
                        showAlert('Google Drive 初始化失敗', '請檢查網路連線', 'error');
                    });
                });
            } catch (error) {
                console.error('初始化 Google Drive 失敗:', error);
                showAlert('Google Drive 初始化失敗', error.message, 'error');
            }
        }

        // 儲存檔案到 Google Drive
        function saveFileToGoogleDrive(fileName, content, mimeType = 'text/plain') {
            return new Promise((resolve, reject) => {
                try {
                    if (!state.isAuthenticated) {
                        reject(new Error('用戶未登入'));
                        return;
                    }

                    // 檢查是否已初始化 Google Drive API
                    if (!gapi.client.drive) {
                        reject(new Error('Google Drive API 未初始化'));
                        return;
                    }

                    // 建立檔案中繼資料
                    const fileMetadata = {
                        name: fileName,
                        mimeType: mimeType,
                        parents: [] // 可以指定資料夾 ID
                    };

                    // 建立檔案內容
                    const fileContent = content;

                    // 上傳檔案
                    gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: mimeType,
                            body: fileContent
                        }
                    }).then(function(response) {
                        console.log('檔案上傳成功:', response.result);
                        resolve(response.result);
                    }).catch(function(error) {
                        console.error('檔案上傳失敗:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('儲存檔案到 Google Drive 失敗:', error);
                    reject(error);
                }
            });
        }

        // 更新儲存到 Google Drive 函數
        function saveToGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    showAlert('需要登入', '請先登入 Google 帳戶才能儲存到 Drive', 'warning');
                    return;
                }

                showAlert('儲存中', '正在將報告儲存到 Google Drive...', 'info');
                
                // 這裡應該實作 Google Drive API 儲存功能
                // 目前只是模擬
                setTimeout(() => {
                    showAlert('儲存成功', '報告已儲存到 Google Drive', 'success');
                }, 2000);

            } catch (error) {
                console.error('儲存到 Google Drive 失敗:', error);
                showAlert('儲存失敗', '無法儲存到 Google Drive', 'error');
            }
        }

        // 下載關鍵字清單
        function downloadKeywords(type) {
            try {
                const keywords = collectKeywordsData();
                let content = '';
                let filename = '';

                switch (type) {
                    case 'primary':
                        content = generateKeywordFileContent(keywords.primary, '主要關鍵字', keywords.marketPositioning);
                        filename = `主要關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'longtail':
                        content = generateKeywordFileContent(keywords.longTail, '長尾關鍵字', keywords.marketPositioning);
                        filename = `長尾關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'all':
                        content = generateCompleteKeywordFileContent(keywords);
                        filename = `完整關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    default:
                        showAlert('下載失敗', '無效的下載類型', 'error');
                        return;
                }

                downloadFile(content, filename);
                showAlert('下載成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('下載關鍵字失敗:', error);
                showAlert('下載失敗', '無法下載關鍵字清單', 'error');
            }
        }

        // 生成關鍵字檔案內容
        function generateKeywordFileContent(keywords, type, marketPositioning) {
            const marketInfo = getMarketInfo(marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(marketPositioning.primaryLanguage);

            return `關鍵字清單 - ${type}
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位資訊 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(marketPositioning.localizationLevel)}

=== ${type}清單 ===
${keywords.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== SEO 建議 ===
${generateSEORecommendations(keywords, marketPositioning)}

=== 關鍵字購買建議 ===
${generateKeywordPurchaseRecommendations(keywords, marketPositioning)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成完整關鍵字檔案內容
        function generateCompleteKeywordFileContent(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `完整關鍵字分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位分析 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 主要關鍵字 (${keywords.primary.length} 個) ===
${keywords.primary.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 長尾關鍵字 (${keywords.longTail.length} 個) ===
${keywords.longTail.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 關鍵字策略分析 ===
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== SEO 策略建議 ===
${generateComprehensiveSEORecommendations(keywords)}

=== 關鍵字購買策略 ===
${generateComprehensiveKeywordPurchaseStrategy(keywords)}

=== 內容策略建議 ===
${generateContentStrategyRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成關鍵字分析報告
        function generateKeywordReport() {
            try {
                const keywords = collectKeywordsData();
                
                if (keywords.primary.length === 0 && keywords.longTail.length === 0) {
                    showAlert('沒有關鍵字', '請先輸入關鍵字再生成報告', 'warning');
                    return;
                }

                showAlert('生成中', '正在生成關鍵字分析報告...', 'info');

                const report = generateKeywordAnalysisReport(keywords);
                const filename = `關鍵字分析報告_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(report, filename);
                showAlert('報告生成成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('生成關鍵字報告失敗:', error);
                showAlert('報告生成失敗', '無法生成關鍵字分析報告', 'error');
            }
        }

        // 生成關鍵字分析報告內容
        function generateKeywordAnalysisReport(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `關鍵字分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場背景分析 ===
目標市場: ${marketInfo.name}
市場特點: ${marketInfo.characteristics}
競爭環境: ${marketInfo.competition}
搜尋行為: ${marketInfo.searchBehavior}

商業模式: ${businessModelInfo.name}
模式特點: ${businessModelInfo.characteristics}
關鍵字策略: ${businessModelInfo.keywordStrategy}

目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
語言環境: ${languageInfo.name}
本地化需求: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 關鍵字分析 ===
主要關鍵字數量: ${keywords.primary.length}
長尾關鍵字數量: ${keywords.longTail.length}
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== 關鍵字分類與建議 ===
${generateKeywordCategorization(keywords)}

=== 競爭分析 ===
${generateKeywordCompetitionAnalysis(keywords)}

=== 投資報酬率預測 ===
${generateROIPrediction(keywords)}

=== 執行建議 ===
${generateExecutionRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 輔助函數：獲取市場資訊
        function getMarketInfo(marketCode) {
            const markets = {
                'tw': { name: '台灣', code: 'TW', characteristics: '數位化程度高，行動裝置普及率高', competition: '競爭激烈，本地化需求強', searchBehavior: '偏好繁體中文，重視本地化內容' },
                'hk': { name: '香港', code: 'HK', characteristics: '國際化程度高，消費能力強', competition: '國際品牌競爭激烈', searchBehavior: '中英文並用，重視品質' },
                'sg': { name: '新加坡', code: 'SG', characteristics: '多語言環境，科技發達', competition: '國際化競爭，品質要求高', searchBehavior: '多語言搜尋，重視效率' },
                'my': { name: '馬來西亞', code: 'MY', characteristics: '多元文化，成長潛力大', competition: '中等競爭，本地化機會多', searchBehavior: '多語言，價格敏感' },
                'th': { name: '泰國', code: 'TH', characteristics: '數位化快速發展', competition: '本地品牌優勢明顯', searchBehavior: '泰語為主，視覺內容重要' },
                'vn': { name: '越南', code: 'VN', characteristics: '年輕人口多，成長快速', competition: '新興市場，機會多', searchBehavior: '越南語，行動優先' },
                'id': { name: '印尼', code: 'ID', characteristics: '人口眾多，市場潛力大', competition: '本地化需求強', searchBehavior: '印尼語，社群媒體重要' },
                'ph': { name: '菲律賓', code: 'PH', characteristics: '英語普及，國際化程度高', competition: '國際品牌競爭', searchBehavior: '英語和菲律賓語並用' },
                'jp': { name: '日本', code: 'JP', characteristics: '品質要求極高，技術先進', competition: '競爭激烈，品質至上', searchBehavior: '日語，重視細節' },
                'kr': { name: '韓國', code: 'KR', characteristics: '科技發達，創新導向', competition: '技術競爭激烈', searchBehavior: '韓語，重視創新' },
                'cn': { name: '中國大陸', code: 'CN', characteristics: '市場規模巨大，競爭激烈', competition: '極度競爭，本地化重要', searchBehavior: '簡體中文，平台生態重要' },
                'us': { name: '美國', code: 'US', characteristics: '成熟市場，創新導向', competition: '高度競爭，創新重要', searchBehavior: '英語，重視便利性' },
                'ca': { name: '加拿大', code: 'CA', characteristics: '多元文化，品質要求高', competition: '國際競爭，品質重要', searchBehavior: '英語和法語，重視品質' },
                'au': { name: '澳洲', code: 'AU', characteristics: '高消費能力，品質導向', competition: '國際競爭，品質重要', searchBehavior: '英語，重視品質和服務' },
                'uk': { name: '英國', code: 'UK', characteristics: '成熟市場，創新導向', competition: '高度競爭，創新重要', searchBehavior: '英語，重視品牌' },
                'de': { name: '德國', code: 'DE', characteristics: '技術導向，品質要求高', competition: '技術競爭激烈', searchBehavior: '德語，重視技術和品質' },
                'fr': { name: '法國', code: 'FR', characteristics: '文化導向，品質要求高', competition: '文化競爭，品質重要', searchBehavior: '法語，重視文化和品質' },
                'global': { name: '全球市場', code: 'Global', characteristics: '多元化，本地化需求強', competition: '國際競爭，本地化重要', searchBehavior: '多語言，文化適應重要' }
            };
            return markets[marketCode] || { name: '未指定', code: 'Unknown', characteristics: '未知', competition: '未知', searchBehavior: '未知' };
        }

        // 輔助函數：獲取商業模式資訊
        function getBusinessModelInfo(modelCode) {
            const models = {
                'b2b': { name: 'B2B (企業對企業)', characteristics: '專業性強，決策週期長', keywordStrategy: '專業術語，解決方案導向' },
                'b2c': { name: 'B2C (企業對消費者)', characteristics: '用戶體驗重要，決策快速', keywordStrategy: '用戶友好，情感訴求' },
                'b2b2c': { name: 'B2B2C (企業對企業對消費者)', characteristics: '複雜價值鏈，多方利益', keywordStrategy: '平台價值，生態系統' },
                'c2c': { name: 'C2C (消費者對消費者)', characteristics: '社群驅動，信任重要', keywordStrategy: '社群關鍵字，信任建立' },
                'saas': { name: 'SaaS (軟體即服務)', characteristics: '訂閱模式，持續價值', keywordStrategy: '解決方案，ROI導向' },
                'marketplace': { name: 'Marketplace (平台模式)', characteristics: '網路效應，規模重要', keywordStrategy: '平台價值，選擇多樣' },
                'subscription': { name: 'Subscription (訂閱模式)', characteristics: '持續收入，用戶留存', keywordStrategy: '價值持續，便利性' },
                'freemium': { name: 'Freemium (免費增值)', characteristics: '用戶獲取，轉換重要', keywordStrategy: '免費價值，升級誘因' },
                'ecommerce': { name: 'E-commerce (電商)', characteristics: '轉換率重要，用戶體驗', keywordStrategy: '產品關鍵字，購買意圖' },
                'agency': { name: 'Agency (代理/服務)', characteristics: '專業服務，信任建立', keywordStrategy: '專業能力，服務品質' }
            };
            return models[modelCode] || { name: '未指定', characteristics: '未知', keywordStrategy: '未知' };
        }

        // 輔助函數：獲取語言資訊
        function getLanguageInfo(langCode) {
            const languages = {
                'zh-tw': { name: '繁體中文 (台灣)', characteristics: '本地化需求強，文化適應重要' },
                'zh-hk': { name: '繁體中文 (香港)', characteristics: '國際化程度高，中英文並用' },
                'zh-cn': { name: '簡體中文 (中國)', characteristics: '市場規模大，平台生態重要' },
                'en': { name: 'English (英語)', characteristics: '國際通用，競爭激烈' },
                'ja': { name: '日本語 (日語)', characteristics: '品質要求高，細節重要' },
                'ko': { name: '한국어 (韓語)', characteristics: '創新導向，技術重視' },
                'th': { name: 'ไทย (泰語)', characteristics: '本地化重要，文化適應' },
                'vi': { name: 'Tiếng Việt (越南語)', characteristics: '成長市場，本地化機會' },
                'id': { name: 'Bahasa Indonesia (印尼語)', characteristics: '人口眾多，市場潛力大' },
                'ms': { name: 'Bahasa Melayu (馬來語)', characteristics: '多元文化，本地化需求' }
            };
            return languages[langCode] || { name: '未指定', characteristics: '未知' };
        }

        // 輔助函數：獲取目標客群資訊
        function getTargetAudienceInfo(audienceCode) {
            const audiences = {
                'startup': '新創公司 - 成本敏感，快速決策',
                'sme': '中小企業 - 實用導向，性價比重要',
                'enterprise': '大型企業 - 品質要求高，決策週期長',
                'freelancer': '自由工作者 - 靈活性重要，成本控制',
                'student': '學生 - 價格敏感，功能需求',
                'professional': '專業人士 - 品質要求高，效率重要',
                'consumer': '一般消費者 - 用戶體驗，情感訴求',
                'elderly': '銀髮族 - 易用性，信任建立',
                'youth': '年輕族群 - 創新，社交分享',
                'parent': '家長 - 安全，品質，教育價值'
            };
            return audiences[audienceCode] || '未指定';
        }

        // 輔助函數：獲取本地化資訊
        function getLocalizationInfo(levelCode) {
            const levels = {
                'basic': '基礎本地化 (翻譯) - 基本語言適應',
                'standard': '標準本地化 (翻譯+文化適應) - 文化內容調整',
                'advanced': '深度本地化 (完全在地化) - 完全文化適應',
                'native': '原生本地化 (在地團隊開發) - 原生文化體驗'
            };
            return levels[levelCode] || '未指定';
        }

        // 輔助函數：獲取關鍵字深度資訊
        function getKeywordDepthInfo(depthCode) {
            const depths = {
                'basic': '基礎分析 (搜尋量、競爭度)',
                'standard': '標準分析 (搜尋量、競爭度、出價建議)',
                'comprehensive': '深度分析 (搜尋量、競爭度、出價建議、內容策略)'
            };
            return depths[depthCode] || '未指定';
        }

        // 通用下載檔案函數
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 生成 SEO 建議
        function generateSEORecommendations(keywords, marketPositioning) {
            return `1. 針對 ${getMarketInfo(marketPositioning.targetMarket).name} 市場優化
2. 使用 ${getLanguageInfo(marketPositioning.primaryLanguage).name} 進行內容創作
3. 考慮 ${getBusinessModelInfo(marketPositioning.businessModel).keywordStrategy}
4. 建立長尾關鍵字內容策略
5. 優化本地化內容和用戶體驗`;
        }

        // 生成關鍵字購買建議
        function generateKeywordPurchaseRecommendations(keywords, marketPositioning) {
            return `1. 主要關鍵字：高競爭度，建議 CPC 預算分配 60%
2. 長尾關鍵字：中等競爭度，建議 CPC 預算分配 40%
3. 根據 ${getMarketInfo(marketPositioning.targetMarket).name} 市場調整出價
4. 考慮 ${getBusinessModelInfo(marketPositioning.businessModel).name} 的轉換週期
5. 定期監控和調整關鍵字表現`;
        }

        // 生成綜合 SEO 建議
        function generateComprehensiveSEORecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 商業模式的 SEO 策略建議：

1. 技術 SEO 優化
   - 網站速度優化 (目標載入時間 < 3秒)
   - 行動裝置友善設計 (Mobile-first)
   - 結構化資料標記 (Schema.org)
   - 網站地圖優化 (XML Sitemap)
   - 內部連結結構優化

2. 內容 SEO 策略
   - 主要關鍵字：${keywords.primary.slice(0, 3).join(', ')}
   - 長尾關鍵字：${keywords.longTail.slice(0, 5).join(', ')}
   - 內容深度：每篇文章至少 1500 字
   - 更新頻率：每週 2-3 篇新內容
   - 內容類型：部落格文章、案例研究、白皮書

3. 頁面 SEO 優化
   - 標題標籤 (Title Tag) 包含主要關鍵字
   - Meta 描述優化 (150-160 字元)
   - H1-H6 標籤層級結構
   - 圖片 Alt 標籤優化
   - URL 結構優化

4. 外部 SEO 策略
   - 高品質反向連結建立
   - 行業相關網站合作
   - 社群媒體內容分享
   - 影響者行銷合作
   - 客座文章發布

5. 本地 SEO (適用於實體業務)
   - Google My Business 優化
   - 本地關鍵字優化
   - 客戶評價管理
   - 本地目錄提交
   - 本地內容策略`;
        }

        // 生成綜合關鍵字購買策略
        function generateComprehensiveKeywordPurchaseStrategy(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 的關鍵字購買策略：

1. 主要關鍵字策略 (${keywords.primary.length} 個)
   - 預算分配：總預算的 40%
   - 出價策略：競爭性出價，爭取前三名
   - 匹配類型：廣泛匹配 + 否定關鍵字
   - 目標：品牌知名度、流量建立

2. 長尾關鍵字策略 (${keywords.longTail.length} 個)
   - 預算分配：總預算的 35%
   - 出價策略：精準出價，控制成本
   - 匹配類型：詞組匹配 + 完全匹配
   - 目標：轉換率提升、ROI 優化

3. 商業意圖關鍵字
   - 預算分配：總預算的 15%
   - 出價策略：高競爭出價
   - 匹配類型：完全匹配為主
   - 目標：直接轉換、銷售線索

4. 資訊型關鍵字
   - 預算分配：總預算的 10%
   - 出價策略：中等出價
   - 匹配類型：廣泛匹配
   - 目標：內容行銷、教育客戶

5. 出價建議
   - 主要關鍵字：$$$ (高競爭)
   - 長尾關鍵字：$$ (中等競爭)
   - 商業意圖：$$$ (高價值)
   - 資訊型：$ (低競爭)

6. 預算分配建議
   - 每日預算：根據市場競爭度調整
   - 週期性調整：每週檢視一次
   - 季節性調整：重要節日增加預算
   - A/B 測試：持續優化出價策略`;
        }

        // 生成內容策略建議
        function generateContentStrategyRecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 的內容策略建議：

1. 內容類型規劃
   - 教育型內容：${keywords.primary.slice(0, 2).join(', ')} 相關指南
   - 案例研究：客戶成功故事、ROI 展示
   - 行業洞察：趨勢分析、市場報告
   - 產品展示：功能介紹、使用教學
   - 客戶服務：FAQ、故障排除

2. 內容主題建議
   - 主要關鍵字主題：${keywords.primary.map(k => `"${k} 完整指南"`).join(', ')}
   - 長尾關鍵字主題：${keywords.longTail.slice(0, 3).map(k => `"${k} 最佳實踐"`).join(', ')}
   - 商業模式主題：${businessModel.focus} 相關內容
   - 客戶痛點主題：解決方案、最佳實踐

3. 內容發布策略
   - 發布頻率：每週 2-3 篇
   - 最佳時間：週二至週四 9:00-11:00
   - 內容長度：1500-3000 字
   - 多媒體內容：影片、資訊圖表、播客

4. 內容推廣策略
   - 社群媒體：LinkedIn、Facebook、Twitter
   - 電子郵件行銷：訂閱者分享
   - 影響者合作：行業專家背書
   - 付費推廣：Facebook Ads、LinkedIn Ads

5. 內容優化建議
   - SEO 優化：關鍵字密度 1-2%
   - 可讀性：Flesch Reading Ease > 60
   - 視覺元素：圖片、影片、圖表
   - 行動優化：響應式設計
   - 互動元素：評論、分享按鈕`;
        }

        // 生成關鍵字分類
        function generateKeywordCategorization(keywords) {
            return `主要關鍵字分類：
- 品牌關鍵字：建立品牌知名度
- 產品關鍵字：直接轉換導向
- 解決方案關鍵字：問題解決導向

長尾關鍵字分類：
- 問題解決型：回答具體問題
- 比較型：產品比較和選擇
- 教程型：教學和指南內容`;
        }

        // 生成競爭分析
        function generateKeywordCompetitionAnalysis(keywords) {
            return `競爭分析：
- 主要關鍵字競爭度：高，需要持續優化
- 長尾關鍵字競爭度：中等，機會較多
- 建議：專注於長尾關鍵字建立優勢
- 監控競爭對手關鍵字策略`;
        }

        // 生成 ROI 預測
        function generateROIPrediction(keywords) {
            return `ROI 預測：
- 短期 (1-3個月)：建立關鍵字排名基礎
- 中期 (3-6個月)：開始看到有機流量增長
- 長期 (6-12個月)：實現穩定的轉換和收入
- 建議：持續投資內容和技術優化`;
        }

        // 生成執行建議
        function generateExecutionRecommendations(keywords) {
            return `執行建議：
1. 立即行動：開始建立關鍵字內容
2. 短期目標：優化主要關鍵字排名
3. 中期目標：建立長尾關鍵字優勢
4. 長期目標：建立品牌權威性
5. 持續優化：定期監控和調整策略`;
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>市場情資與競品分析平台 (V6 - 進階分析版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .step-btn {
            transition: all 0.3s ease;
        }
        
        .step-btn:hover {
            transform: translateY(-2px);
        }
        
        .step-btn.active {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
    </style>
    <script>
        // Tailwind CSS configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        techbg: '#181D27',
                        techpanel: '#22283A',
                        techaccent: '#2EE9E4',
                        techprimary: '#3762F0',
                        techsecondary: '#7D5FFF'
                    },
                    fontFamily: {
                        'tech': ['"Segoe UI"', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            }
        }

        // 全域狀態管理
        window.state = {
            isAuthenticated: false,
            apiConfigured: false,
            currentStep: 1,
            analysisData: {},
            settings: {
                googleApiKey: '',
                searchEngineId: '',
                centralFolderName: 'iStaging_專案管理',
                intelligenceSubfolder: '01_市場情資分析',
                mediaplanSubfolder: '02_媒體提案',
                workflowSubfolder: '03_工作流程文件'
            }
        };

        // 頁面載入完成後初始化
        window.addEventListener('load', function() {
            console.log('頁面載入完成，開始初始化...');
            
            // 使用 Promise 包裝初始化，避免未捕獲的錯誤
            initializeApp()
                .then(() => {
                    console.log('初始化完成');
                })
                .catch(error => {
                    console.error('初始化過程中發生錯誤:', error);
                    showAlert('初始化錯誤', '頁面初始化失敗，請重新整理頁面', 'error');
                });
        });

        // 全域錯誤處理
        window.addEventListener('error', function(event) {
            console.error('全域錯誤:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('未處理的 Promise 拒絕:', event.reason);
            event.preventDefault(); // 防止預設的錯誤處理
        });

        // 顯示警告訊息
        function showAlert(title, message, type = 'info') {
            try {
                const alertContainer = document.getElementById('alert-container');
                if (!alertContainer) return;

                const alertDiv = document.createElement('div');
                alertDiv.className = `p-4 mb-4 rounded-lg shadow-lg ${
                    type === 'error' ? 'bg-red-600 text-white' :
                    type === 'success' ? 'bg-green-600 text-white' :
                    type === 'warning' ? 'bg-yellow-600 text-white' :
                    'bg-blue-600 text-white'
                }`;
                
                alertDiv.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold">${title}</h4>
                            <p class="text-sm mt-1">${message}</p>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                `;

                alertContainer.appendChild(alertDiv);

                // 自動移除警告
                setTimeout(() => {
                    if (alertDiv.parentElement) {
                        alertDiv.remove();
                    }
                }, 5000);
            } catch (error) {
                console.error('顯示警告失敗:', error);
            }
        }

        // 初始化應用程式
        function initializeApp() {
            return new Promise((resolve, reject) => {
                try {
                    console.log('初始化應用程式...');
                    
                    // 載入設定
                    loadSettings();
                    
                    // 設定事件監聽器
                    setupEventListeners();
                    
                    // 檢查 URL 參數
                    checkUrlParameters();
                    
                    // 更新 UI 狀態
                    updateUIState();
                    
                    // 延遲再次檢查 URL 參數，確保 DOM 完全載入
                    setTimeout(() => {
                        checkUrlParameters();
                    }, 500);
                    
                    console.log('應用程式初始化完成');
                    resolve();
            } catch (error) {
                    console.error('應用程式初始化失敗:', error);
                    reject(error);
                }
            });
        }

        // 載入設定
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('intelligence_settings');
                if (savedSettings) {
                    const parsed = JSON.parse(savedSettings);
                    state.settings = { ...state.settings, ...parsed };
                    
                    // 更新表單欄位
                    const apiKeyInput = document.getElementById('google-api-key');
                    const searchEngineInput = document.getElementById('search-engine-id');
                    const geminiApiKeyInput = document.getElementById('gemini-api-key');
                    const centralFolderInput = document.getElementById('central-folder-name');
                    const intelligenceSubfolderInput = document.getElementById('intelligence-subfolder');
                    const mediaplanSubfolderInput = document.getElementById('mediaplan-subfolder');
                    const workflowSubfolderInput = document.getElementById('workflow-subfolder');
                    
                    if (apiKeyInput) apiKeyInput.value = state.settings.googleApiKey || '';
                    if (searchEngineInput) searchEngineInput.value = state.settings.searchEngineId || '';
                    if (geminiApiKeyInput) geminiApiKeyInput.value = state.settings.geminiApiKey || '';
                    if (centralFolderInput) centralFolderInput.value = state.settings.centralFolderName || '';
                    if (intelligenceSubfolderInput) intelligenceSubfolderInput.value = state.settings.intelligenceSubfolder || '';
                    if (mediaplanSubfolderInput) mediaplanSubfolderInput.value = state.settings.mediaplanSubfolder || '';
                    if (workflowSubfolderInput) workflowSubfolderInput.value = state.settings.workflowSubfolder || '';
                }
            } catch (error) {
                console.warn('載入設定失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 設定事件監聽器
        function setupEventListeners() {
            try {
                // 標籤頁切換
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            const tab = this.dataset.tab;
                            switchTab(tab);
                        });
                    }
                });

                // 儲存設定按鈕
                const saveSettingsBtn = document.getElementById('save-settings-btn');
                if (saveSettingsBtn) {
                    saveSettingsBtn.addEventListener('click', saveSettings);
                }

                // Google 登入按鈕
                const authorizeBtn = document.getElementById('authorize_button');
                if (authorizeBtn) {
                    authorizeBtn.addEventListener('click', handleGoogleAuth);
                }

                // 登出按鈕
                const signoutBtn = document.getElementById('signout_button');
                if (signoutBtn) {
                    signoutBtn.addEventListener('click', handleSignOut);
                }

                // 步驟切換 - 修正事件監聽器
                const stepCircles = document.querySelectorAll('.step-circle');
                stepCircles.forEach((circle, index) => {
                    if (circle) {
                        circle.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const step = index + 1;
                            console.log(`點擊步驟 ${step}`);
                            goToStep(step);
                        });
                    }
                });

                // 設定步驟 1 的事件監聽器
                setupStep1EventListeners();

                console.log('事件監聽器設定完成');
            } catch (error) {
                console.error('設定事件監聽器失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 檢查 URL 參數
        function checkUrlParameters() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('projectId');
                
                if (projectId) {
                    console.log('發現 URL 參數 projectId:', projectId);
                    
                    // 使用重試機制確保 DOM 元素已載入
                    const setProjectId = () => {
                        const projectIdInput = document.getElementById('project-id');
                        if (projectIdInput) {
                            projectIdInput.value = projectId;
                            console.log('成功設置 project ID:', projectId);
                        } else {
                            console.log('project-id 元素尚未載入，延遲重試...');
                            setTimeout(setProjectId, 100);
                        }
                    };
                    
                    // 立即嘗試設置，如果失敗則延遲重試
                    setProjectId();
                }
            } catch (error) {
                console.warn('檢查 URL 參數失敗:', error);
                // 不拋出錯誤，讓程式繼續執行
            }
        }

        // 更新 UI 狀態
        function updateUIState() {
            try {
                const appContainer = document.getElementById('app-container');
                const analysisPanel = document.getElementById('analysis-panel');
                const historyPanel = document.getElementById('history-panel');
                const isConfigured = state.settings.googleApiKey && state.settings.searchEngineId && state.settings.geminiApiKey;
                
                // 移除 app-container 的 locked class，改為只鎖定特定面板
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
                
                // 只有分析系統和歷史紀錄需要 API 設定
                if (analysisPanel) {
                    if (isConfigured) {
                        analysisPanel.classList.remove('locked');
                        state.apiConfigured = true;
                    } else {
                        analysisPanel.classList.add('locked');
                        state.apiConfigured = false;
                    }
                }
                
                if (historyPanel) {
                    if (isConfigured) {
                        historyPanel.classList.remove('locked');
                    } else {
                        historyPanel.classList.add('locked');
                    }
                }

                // 預設顯示 API 設定分頁
                switchTab('settings');
            } catch (error) {
                console.error('更新 UI 狀態失敗:', error);
            }
        }

        // 切換標籤頁
        function switchTab(tabName) {
            try {
                // 移除所有標籤頁的 active 狀態
                const tabButtons = document.querySelectorAll('.tab-btn');
                const panels = document.querySelectorAll('.panel');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                panels.forEach(panel => panel.classList.remove('active'));
                
                // 啟用選中的標籤頁
                const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
                const activePanel = document.getElementById(`${tabName}-panel`);
                
                if (activeTab) activeTab.classList.add('active');
                if (activePanel) activePanel.classList.add('active');
                
                console.log(`切換到標籤頁: ${tabName}`);
            } catch (error) {
                console.error('切換標籤頁失敗:', error);
            }
        }

        // 儲存設定
        function saveSettings() {
            try {
                const apiKey = document.getElementById('google-api-key')?.value || '';
                const searchEngineId = document.getElementById('search-engine-id')?.value || '';
                const geminiApiKey = document.getElementById('gemini-api-key')?.value || '';
                const centralFolderName = document.getElementById('central-folder-name')?.value || '';
                const intelligenceSubfolder = document.getElementById('intelligence-subfolder')?.value || '';
                const mediaplanSubfolder = document.getElementById('mediaplan-subfolder')?.value || '';
                const workflowSubfolder = document.getElementById('workflow-subfolder')?.value || '';

                // 更新狀態
                state.settings = {
                    googleApiKey: apiKey,
                    searchEngineId: searchEngineId,
                    geminiApiKey: geminiApiKey,
                    centralFolderName: centralFolderName,
                    intelligenceSubfolder: intelligenceSubfolder,
                    mediaplanSubfolder: mediaplanSubfolder,
                    workflowSubfolder: workflowSubfolder
                };

                // 儲存到 localStorage
                localStorage.setItem('intelligence_settings', JSON.stringify(state.settings));

                // 更新 UI 狀態
                updateUIState();

                showAlert('設定已儲存', 'API 設定已成功儲存', 'success');
                
                // 如果 API 已設定，切換到分析系統
                if (apiKey && searchEngineId && geminiApiKey) {
                    setTimeout(() => {
                        switchTab('analysis');
                    }, 1000);
                }
            } catch (error) {
                console.error('儲存設定失敗:', error);
                showAlert('儲存失敗', error.message, 'error');
            }
        }

        // 步驟切換功能
        function goToStep(step) {
            try {
                console.log(`切換到步驟 ${step}`);
                
                // 隱藏所有步驟面板
                const stepPanels = document.querySelectorAll('.step-panel');
                stepPanels.forEach(panel => {
                    panel.style.display = 'none';
                });
                
                // 移除所有步驟的 active 狀態
                const stepButtons = document.querySelectorAll('.step-btn');
                stepButtons.forEach(btn => {
                    btn.classList.remove('active', 'bg-techprimary', 'text-white');
                    btn.classList.add('bg-gray-600', 'text-gray-300');
                });
                
                // 顯示目標步驟
                const targetPanel = document.getElementById(`step-${step}`);
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                }
                
                // 更新步驟按鈕狀態
                const currentStepBtn = document.getElementById(`step-${step}-btn`);
                if (currentStepBtn) {
                    currentStepBtn.classList.add('active', 'bg-techprimary', 'text-white');
                    currentStepBtn.classList.remove('bg-gray-600', 'text-gray-300');
                }
                
                // 如果是步驟 2，執行額外的初始化
                if (step === 2) {
                    try {
                        console.log('步驟 2 載入初始化開始...');
                        
                        // 更新當前主題顯示
                        const currentTopicElement = document.getElementById('current-topic');
                        if (currentTopicElement && state.analysisData.topic) {
                            currentTopicElement.textContent = state.analysisData.topic;
                        }
                        
                        // 自動搜尋競爭對手
                        if (state.analysisData.topic && state.analysisData.brand) {
                            setTimeout(() => {
                                searchCompetitors();
                            }, 500);
                        }
                        
                        // 更新已選擇競爭對手顯示
                        updateSelectedCompetitorsDisplay();
                        
                        // 更新生成報告按鈕狀態
                        updateGenerateReportButton();
                        
                        console.log('步驟 2 載入初始化完成');
                        
                    } catch (error) {
                        console.error('步驟 2 載入失敗:', error);
                    }
                }
                
                // 如果是步驟 3，顯示完整報告
                if (step === 3) {
                    displayFinalReport();
                }
                
            } catch (error) {
                console.error('切換步驟失敗:', error);
            }
        }

        // 開始分析
        function startAnalysis() {
            try {
                // 收集所有資料
                const brandName = document.getElementById('brand-name')?.value?.trim();
                const brandWebsite = document.getElementById('brand-website')?.value?.trim();
                const brandDescription = document.getElementById('brand-description')?.value?.trim();
                const industryCategory = document.getElementById('industry-category')?.value;
                const marketSize = document.getElementById('market-size')?.value;
                const topic = document.getElementById('analysis-topic')?.value?.trim();
                const projectId = document.getElementById('project-id')?.value?.trim();
                const competitorCount = document.getElementById('competitor-count')?.value;
                const analysisDepth = document.querySelector('input[name="analysis-depth"]:checked')?.value;

                // 驗證必填欄位
                if (!brandName) {
                    showAlert('請填寫品牌名稱', '品牌名稱為必填項目', 'warning');
                    return;
                }

                if (!industryCategory) {
                    showAlert('請選擇行業類別', '行業類別為必填項目', 'warning');
                    return;
                }

                if (!topic) {
                    showAlert('請填寫分析主題', '分析主題為必填項目', 'warning');
                    return;
                }

                // 收集產品和關鍵字資料
                const products = collectProductsData();
                const keywords = collectKeywordsData();

                // 儲存分析設定
                state.analysisData = {
                    brand: {
                        name: brandName,
                        website: brandWebsite,
                        description: brandDescription
                    },
                    products: products,
                    industry: {
                        category: industryCategory,
                        marketSize: marketSize
                    },
                    topic: topic,
                    projectId: projectId || `TEMP_${Date.now()}`,
                    competitorCount: parseInt(competitorCount),
                    analysisDepth: analysisDepth,
                    keywords: keywords,
                    timestamp: new Date().toISOString()
                };

                showAlert('分析設定已儲存', '正在準備競爭對手分析...', 'success');
                
                // 切換到步驟 2
                setTimeout(() => {
                    goToStep(2);
                }, 1000);

            } catch (error) {
                console.error('開始分析失敗:', error);
                showAlert('分析失敗', error.message, 'error');
            }
        }

        // 收集產品資料
        function collectProductsData() {
            try {
                const products = [];
                const productItems = document.querySelectorAll('.product-item');
                
                productItems.forEach(item => {
                    const name = item.querySelector('.product-name')?.value?.trim();
                    const pricing = item.querySelector('.product-pricing')?.value;
                    const target = item.querySelector('.product-target')?.value?.trim();
                    
                    if (name) {
                        products.push({
                            name: name,
                            pricing: pricing,
                            target: target
                        });
                    }
                });
                
                return products;
            } catch (error) {
                console.error('收集產品資料失敗:', error);
                return [];
            }
        }

        // 收集關鍵字資料
        function collectKeywordsData() {
            const primaryKeywords = document.getElementById('primary-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const longTailKeywords = document.getElementById('long-tail-keywords')?.value?.split('\n').filter(k => k.trim()) || [];
            const businessModel = document.getElementById('business-model-select')?.value || '';
            
            return {
                primary: primaryKeywords,
                longTail: longTailKeywords,
                marketPositioning: {
                    businessModel: businessModel,
                    targetMarket: 'tw', // 預設台灣
                    targetAudience: 'general',
                    primaryLanguage: 'zh-TW',
                    localizationLevel: 'high'
                },
                depth: 'comprehensive'
            };
        }

        // Google 認證處理 - 簡化版本
        function handleGoogleAuth() {
            try {
                // 檢查是否已載入 Google API
                if (typeof gapi === 'undefined') {
                    showAlert('Google API 未載入', '請檢查網路連線並重新整理頁面', 'error');
                    return;
                }

                // 檢查 Google Client ID 是否已設定
                const clientId = '733619441496-5gigdpkv42k84no3q5vvh93ths1e8u29.apps.googleusercontent.com';
                
                // 初始化 Google API
                gapi.load('auth2', function() {
                    gapi.auth2.init({
                        client_id: clientId,
                        scope: 'profile email' // 只要求基本權限
                    }).then(function(auth2) {
                        // 登入
                        auth2.signIn().then(function(googleUser) {
                            const profile = googleUser.getBasicProfile();
                            state.isAuthenticated = true;
                            state.userProfile = {
                                id: profile.getId(),
                                name: profile.getName(),
                                email: profile.getEmail(),
                                imageUrl: profile.getImageUrl()
                            };
                            
                            updateAuthUI();
                            showAlert('登入成功', `歡迎 ${profile.getName()}`, 'success');
                            
                            // 解鎖應用程式
                            unlockApp();
                        }).catch(function(error) {
                            console.error('Google 登入失敗:', error);
                            showAlert('登入失敗', 'Google 登入失敗，請重試', 'error');
                        });
                    }).catch(function(error) {
                        console.error('Google API 初始化失敗:', error);
                        showAlert('初始化失敗', 'Google API 初始化失敗，請檢查網路連線', 'error');
                    });
                });
            } catch (error) {
                console.error('Google 認證失敗:', error);
                showAlert('認證失敗', error.message, 'error');
            }
        }

        // 解鎖應用程式
        function unlockApp() {
            try {
                const appContainer = document.getElementById('app-container');
                if (appContainer) {
                    appContainer.classList.remove('locked');
                }
            } catch (error) {
                console.error('解鎖應用程式失敗:', error);
            }
        }

        // 登出處理
        function handleSignOut() {
            try {
                if (typeof gapi !== 'undefined' && gapi.auth2) {
                    const auth2 = gapi.auth2.getAuthInstance();
                    auth2.signOut().then(function() {
                        state.isAuthenticated = false;
                        state.userProfile = null;
                        updateAuthUI();
                        showAlert('已登出', '您已成功登出 Google 帳戶', 'info');
                    });
                } else {
                    state.isAuthenticated = false;
                    state.userProfile = null;
                    updateAuthUI();
                    showAlert('已登出', '您已成功登出', 'info');
                }
            } catch (error) {
                console.error('登出失敗:', error);
                showAlert('登出失敗', '登出過程中發生錯誤', 'error');
            }
        }

        // 更新認證 UI
        function updateAuthUI() {
            try {
                const userProfile = document.getElementById('user-profile');
                const authorizeBtn = document.getElementById('authorize_button');
                const signoutBtn = document.getElementById('signout_button');
                const userAvatar = document.getElementById('user-avatar');
                const userName = document.getElementById('user-name');

                if (state.isAuthenticated && state.userProfile) {
                    // 顯示用戶資訊
                    if (userProfile) userProfile.classList.remove('hidden');
                    if (authorizeBtn) authorizeBtn.classList.add('hidden');
                    if (signoutBtn) signoutBtn.classList.remove('hidden');
                    
                    if (userAvatar && state.userProfile.imageUrl) {
                        userAvatar.src = state.userProfile.imageUrl;
                    }
                    if (userName) {
                        userName.textContent = state.userProfile.name;
                    }
                } else {
                    // 顯示登入按鈕
                    if (userProfile) userProfile.classList.add('hidden');
                    if (authorizeBtn) authorizeBtn.classList.remove('hidden');
                    if (signoutBtn) signoutBtn.classList.add('hidden');
                }
            } catch (error) {
                console.error('更新認證 UI 失敗:', error);
            }
        }

        // 初始化 Google Drive API
        function initializeGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    console.warn('用戶未登入，無法初始化 Google Drive API');
                    return;
                }

                // 載入 Google Drive API
                gapi.load('client', function() {
                    gapi.client.init({
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                    }).then(function() {
                        console.log('Google Drive API 初始化成功');
                        showAlert('Google Drive 已準備就緒', '可以開始使用檔案儲存功能', 'success');
                    }).catch(function(error) {
                        console.error('Google Drive API 初始化失敗:', error);
                        showAlert('Google Drive 初始化失敗', '請檢查網路連線', 'error');
                    });
                });
            } catch (error) {
                console.error('初始化 Google Drive 失敗:', error);
                showAlert('Google Drive 初始化失敗', error.message, 'error');
            }
        }

        // 儲存檔案到 Google Drive
        function saveFileToGoogleDrive(fileName, content, mimeType = 'text/plain') {
            return new Promise((resolve, reject) => {
                try {
                    if (!state.isAuthenticated) {
                        reject(new Error('用戶未登入'));
                        return;
                    }

                    // 檢查是否已初始化 Google Drive API
                    if (!gapi.client.drive) {
                        reject(new Error('Google Drive API 未初始化'));
                        return;
                    }

                    // 建立檔案中繼資料
                    const fileMetadata = {
                        name: fileName,
                        mimeType: mimeType,
                        parents: [] // 可以指定資料夾 ID
                    };

                    // 建立檔案內容
                    const fileContent = content;

                    // 上傳檔案
                    gapi.client.drive.files.create({
                        resource: fileMetadata,
                        media: {
                            mimeType: mimeType,
                            body: fileContent
                        }
                    }).then(function(response) {
                        console.log('檔案上傳成功:', response.result);
                        resolve(response.result);
                    }).catch(function(error) {
                        console.error('檔案上傳失敗:', error);
                        reject(error);
                    });
                } catch (error) {
                    console.error('儲存檔案到 Google Drive 失敗:', error);
                    reject(error);
                }
            });
        }

        // 更新儲存到 Google Drive 函數
        function saveToGoogleDrive() {
            try {
                if (!state.isAuthenticated) {
                    showAlert('需要登入', '請先登入 Google 帳戶才能儲存到 Drive', 'warning');
                    return;
                }

                showAlert('儲存中', '正在將報告儲存到 Google Drive...', 'info');
                
                // 這裡應該實作 Google Drive API 儲存功能
                // 目前只是模擬
                setTimeout(() => {
                    showAlert('儲存成功', '報告已儲存到 Google Drive', 'success');
                }, 2000);

            } catch (error) {
                console.error('儲存到 Google Drive 失敗:', error);
                showAlert('儲存失敗', '無法儲存到 Google Drive', 'error');
            }
        }

        // 下載關鍵字清單
        function downloadKeywords(type) {
            try {
                const keywords = collectKeywordsData();
                let content = '';
                let filename = '';

                switch (type) {
                    case 'primary':
                        content = generateKeywordFileContent(keywords.primary, '主要關鍵字', keywords.marketPositioning);
                        filename = `主要關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'longtail':
                        content = generateKeywordFileContent(keywords.longTail, '長尾關鍵字', keywords.marketPositioning);
                        filename = `長尾關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    case 'all':
                        content = generateCompleteKeywordFileContent(keywords);
                        filename = `完整關鍵字清單_${new Date().toISOString().split('T')[0]}.txt`;
                        break;
                    default:
                        showAlert('下載失敗', '無效的下載類型', 'error');
                        return;
                }

                downloadFile(content, filename);
                showAlert('下載成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('下載關鍵字失敗:', error);
                showAlert('下載失敗', '無法下載關鍵字清單', 'error');
            }
        }

        // 生成關鍵字檔案內容
        function generateKeywordFileContent(keywords, type, marketPositioning) {
            const marketInfo = getMarketInfo(marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(marketPositioning.primaryLanguage);

            return `關鍵字清單 - ${type}
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位資訊 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(marketPositioning.localizationLevel)}

=== ${type}清單 ===
${keywords.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== SEO 建議 ===
${generateSEORecommendations(keywords, marketPositioning)}

=== 關鍵字購買建議 ===
${generateKeywordPurchaseRecommendations(keywords, marketPositioning)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成完整關鍵字檔案內容
        function generateCompleteKeywordFileContent(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `完整關鍵字分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場定位分析 ===
目標市場: ${marketInfo.name} (${marketInfo.code})
商業模式: ${businessModelInfo.name}
目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
主要語言: ${languageInfo.name}
本地化程度: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 主要關鍵字 (${keywords.primary.length} 個) ===
${keywords.primary.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 長尾關鍵字 (${keywords.longTail.length} 個) ===
${keywords.longTail.map((keyword, index) => `${index + 1}. ${keyword}`).join('\n')}

=== 關鍵字策略分析 ===
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== SEO 策略建議 ===
${generateComprehensiveSEORecommendations(keywords)}

=== 關鍵字購買策略 ===
${generateComprehensiveKeywordPurchaseStrategy(keywords)}

=== 內容策略建議 ===
${generateContentStrategyRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 生成關鍵字分析報告
        function generateKeywordReport() {
            try {
                const keywords = collectKeywordsData();
                
                if (keywords.primary.length === 0 && keywords.longTail.length === 0) {
                    showAlert('沒有關鍵字', '請先輸入關鍵字再生成報告', 'warning');
                    return;
                }

                showAlert('生成中', '正在生成關鍵字分析報告...', 'info');

                const report = generateKeywordAnalysisReport(keywords);
                const filename = `關鍵字分析報告_${new Date().toISOString().split('T')[0]}.txt`;
                
                downloadFile(report, filename);
                showAlert('報告生成成功', `${filename} 已下載到您的裝置`, 'success');

            } catch (error) {
                console.error('生成關鍵字報告失敗:', error);
                showAlert('報告生成失敗', '無法生成關鍵字分析報告', 'error');
            }
        }

        // 生成關鍵字分析報告內容
        function generateKeywordAnalysisReport(keywords) {
            const marketInfo = getMarketInfo(keywords.marketPositioning.targetMarket);
            const businessModelInfo = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            const languageInfo = getLanguageInfo(keywords.marketPositioning.primaryLanguage);

            return `關鍵字分析報告
生成時間: ${new Date().toLocaleString('zh-TW')}

=== 市場背景分析 ===
目標市場: ${marketInfo.name}
市場特點: ${marketInfo.characteristics}
競爭環境: ${marketInfo.competition}
搜尋行為: ${marketInfo.searchBehavior}

商業模式: ${businessModelInfo.name}
模式特點: ${businessModelInfo.characteristics}
關鍵字策略: ${businessModelInfo.keywordStrategy}

目標客群: ${getTargetAudienceInfo(keywords.marketPositioning.targetAudience)}
語言環境: ${languageInfo.name}
本地化需求: ${getLocalizationInfo(keywords.marketPositioning.localizationLevel)}

=== 關鍵字分析 ===
主要關鍵字數量: ${keywords.primary.length}
長尾關鍵字數量: ${keywords.longTail.length}
分析深度: ${getKeywordDepthInfo(keywords.depth)}

=== 關鍵字分類與建議 ===
${generateKeywordCategorization(keywords)}

=== 競爭分析 ===
${generateKeywordCompetitionAnalysis(keywords)}

=== 投資報酬率預測 ===
${generateROIPrediction(keywords)}

=== 執行建議 ===
${generateExecutionRecommendations(keywords)}

---
由 iStaging 市場情資與競品分析平台生成
`;
        }

        // 輔助函數：獲取市場資訊
        function getMarketInfo(marketCode) {
            const markets = {
                'tw': { name: '台灣', code: 'TW', characteristics: '數位化程度高，行動裝置普及率高', competition: '競爭激烈，本地化需求強', searchBehavior: '偏好繁體中文，重視本地化內容' },
                'hk': { name: '香港', code: 'HK', characteristics: '國際化程度高，消費能力強', competition: '國際品牌競爭激烈', searchBehavior: '中英文並用，重視品質' },
                'sg': { name: '新加坡', code: 'SG', characteristics: '多語言環境，科技發達', competition: '國際化競爭，品質要求高', searchBehavior: '多語言搜尋，重視效率' },
                'my': { name: '馬來西亞', code: 'MY', characteristics: '多元文化，成長潛力大', competition: '中等競爭，本地化機會多', searchBehavior: '多語言，價格敏感' },
                'th': { name: '泰國', code: 'TH', characteristics: '數位化快速發展', competition: '本地品牌優勢明顯', searchBehavior: '泰語為主，視覺內容重要' },
                'vn': { name: '越南', code: 'VN', characteristics: '年輕人口多，成長快速', competition: '新興市場，機會多', searchBehavior: '越南語，行動優先' },
                'id': { name: '印尼', code: 'ID', characteristics: '人口眾多，市場潛力大', competition: '本地化需求強', searchBehavior: '印尼語，社群媒體重要' },
                'ph': { name: '菲律賓', code: 'PH', characteristics: '英語普及，國際化程度高', competition: '國際品牌競爭', searchBehavior: '英語和菲律賓語並用' },
                'jp': { name: '日本', code: 'JP', characteristics: '品質要求極高，技術先進', competition: '競爭激烈，品質至上', searchBehavior: '日語，重視細節' },
                'kr': { name: '韓國', code: 'KR', characteristics: '科技發達，創新導向', competition: '技術競爭激烈', searchBehavior: '韓語，重視創新' },
                'cn': { name: '中國大陸', code: 'CN', characteristics: '市場規模巨大，競爭激烈', competition: '極度競爭，本地化重要', searchBehavior: '簡體中文，平台生態重要' },
                'us': { name: '美國', code: 'US', characteristics: '成熟市場，創新導向', competition: '高度競爭，創新重要', searchBehavior: '英語，重視便利性' },
                'ca': { name: '加拿大', code: 'CA', characteristics: '多元文化，品質要求高', competition: '國際競爭，品質重要', searchBehavior: '英語和法語，重視品質' },
                'au': { name: '澳洲', code: 'AU', characteristics: '高消費能力，品質導向', competition: '國際競爭，品質重要', searchBehavior: '英語，重視品質和服務' },
                'uk': { name: '英國', code: 'UK', characteristics: '成熟市場，創新導向', competition: '高度競爭，創新重要', searchBehavior: '英語，重視品牌' },
                'de': { name: '德國', code: 'DE', characteristics: '技術導向，品質要求高', competition: '技術競爭激烈', searchBehavior: '德語，重視技術和品質' },
                'fr': { name: '法國', code: 'FR', characteristics: '文化導向，品質要求高', competition: '文化競爭，品質重要', searchBehavior: '法語，重視文化和品質' },
                'global': { name: '全球市場', code: 'Global', characteristics: '多元化，本地化需求強', competition: '國際競爭，本地化重要', searchBehavior: '多語言，文化適應重要' }
            };
            return markets[marketCode] || { name: '未指定', code: 'Unknown', characteristics: '未知', competition: '未知', searchBehavior: '未知' };
        }

        // 輔助函數：獲取商業模式資訊
        function getBusinessModelInfo(modelCode) {
            const models = {
                'b2b': { name: 'B2B (企業對企業)', characteristics: '專業性強，決策週期長', keywordStrategy: '專業術語，解決方案導向' },
                'b2c': { name: 'B2C (企業對消費者)', characteristics: '用戶體驗重要，決策快速', keywordStrategy: '用戶友好，情感訴求' },
                'b2b2c': { name: 'B2B2C (企業對企業對消費者)', characteristics: '複雜價值鏈，多方利益', keywordStrategy: '平台價值，生態系統' },
                'c2c': { name: 'C2C (消費者對消費者)', characteristics: '社群驅動，信任重要', keywordStrategy: '社群關鍵字，信任建立' },
                'saas': { name: 'SaaS (軟體即服務)', characteristics: '訂閱模式，持續價值', keywordStrategy: '解決方案，ROI導向' },
                'marketplace': { name: 'Marketplace (平台模式)', characteristics: '網路效應，規模重要', keywordStrategy: '平台價值，選擇多樣' },
                'subscription': { name: 'Subscription (訂閱模式)', characteristics: '持續收入，用戶留存', keywordStrategy: '價值持續，便利性' },
                'freemium': { name: 'Freemium (免費增值)', characteristics: '用戶獲取，轉換重要', keywordStrategy: '免費價值，升級誘因' },
                'ecommerce': { name: 'E-commerce (電商)', characteristics: '轉換率重要，用戶體驗', keywordStrategy: '產品關鍵字，購買意圖' },
                'agency': { name: 'Agency (代理/服務)', characteristics: '專業服務，信任建立', keywordStrategy: '專業能力，服務品質' }
            };
            return models[modelCode] || { name: '未指定', characteristics: '未知', keywordStrategy: '未知' };
        }

        // 輔助函數：獲取語言資訊
        function getLanguageInfo(langCode) {
            const languages = {
                'zh-tw': { name: '繁體中文 (台灣)', characteristics: '本地化需求強，文化適應重要' },
                'zh-hk': { name: '繁體中文 (香港)', characteristics: '國際化程度高，中英文並用' },
                'zh-cn': { name: '簡體中文 (中國)', characteristics: '市場規模大，平台生態重要' },
                'en': { name: 'English (英語)', characteristics: '國際通用，競爭激烈' },
                'ja': { name: '日本語 (日語)', characteristics: '品質要求高，細節重要' },
                'ko': { name: '한국어 (韓語)', characteristics: '創新導向，技術重視' },
                'th': { name: 'ไทย (泰語)', characteristics: '本地化重要，文化適應' },
                'vi': { name: 'Tiếng Việt (越南語)', characteristics: '成長市場，本地化機會' },
                'id': { name: 'Bahasa Indonesia (印尼語)', characteristics: '人口眾多，市場潛力大' },
                'ms': { name: 'Bahasa Melayu (馬來語)', characteristics: '多元文化，本地化需求' }
            };
            return languages[langCode] || { name: '未指定', characteristics: '未知' };
        }

        // 輔助函數：獲取目標客群資訊
        function getTargetAudienceInfo(audienceCode) {
            const audiences = {
                'startup': '新創公司 - 成本敏感，快速決策',
                'sme': '中小企業 - 實用導向，性價比重要',
                'enterprise': '大型企業 - 品質要求高，決策週期長',
                'freelancer': '自由工作者 - 靈活性重要，成本控制',
                'student': '學生 - 價格敏感，功能需求',
                'professional': '專業人士 - 品質要求高，效率重要',
                'consumer': '一般消費者 - 用戶體驗，情感訴求',
                'elderly': '銀髮族 - 易用性，信任建立',
                'youth': '年輕族群 - 創新，社交分享',
                'parent': '家長 - 安全，品質，教育價值'
            };
            return audiences[audienceCode] || '未指定';
        }

        // 輔助函數：獲取本地化資訊
        function getLocalizationInfo(levelCode) {
            const levels = {
                'basic': '基礎本地化 (翻譯) - 基本語言適應',
                'standard': '標準本地化 (翻譯+文化適應) - 文化內容調整',
                'advanced': '深度本地化 (完全在地化) - 完全文化適應',
                'native': '原生本地化 (在地團隊開發) - 原生文化體驗'
            };
            return levels[levelCode] || '未指定';
        }

        // 輔助函數：獲取關鍵字深度資訊
        function getKeywordDepthInfo(depthCode) {
            const depths = {
                'basic': '基礎分析 (搜尋量、競爭度)',
                'standard': '標準分析 (搜尋量、競爭度、出價建議)',
                'comprehensive': '深度分析 (搜尋量、競爭度、出價建議、內容策略)'
            };
            return depths[depthCode] || '未指定';
        }

        // 通用下載檔案函數
        function downloadFile(content, filename) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 生成 SEO 建議
        function generateSEORecommendations(keywords, marketPositioning) {
            return `1. 針對 ${getMarketInfo(marketPositioning.targetMarket).name} 市場優化
2. 使用 ${getLanguageInfo(marketPositioning.primaryLanguage).name} 進行內容創作
3. 考慮 ${getBusinessModelInfo(marketPositioning.businessModel).keywordStrategy}
4. 建立長尾關鍵字內容策略
5. 優化本地化內容和用戶體驗`;
        }

        // 生成關鍵字購買建議
        function generateKeywordPurchaseRecommendations(keywords, marketPositioning) {
            return `1. 主要關鍵字：高競爭度，建議 CPC 預算分配 60%
2. 長尾關鍵字：中等競爭度，建議 CPC 預算分配 40%
3. 根據 ${getMarketInfo(marketPositioning.targetMarket).name} 市場調整出價
4. 考慮 ${getBusinessModelInfo(marketPositioning.businessModel).name} 的轉換週期
5. 定期監控和調整關鍵字表現`;
        }

        // 生成綜合 SEO 建議
        function generateComprehensiveSEORecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 商業模式的 SEO 策略建議：

1. 技術 SEO 優化
   - 網站速度優化 (目標載入時間 < 3秒)
   - 行動裝置友善設計 (Mobile-first)
   - 結構化資料標記 (Schema.org)
   - 網站地圖優化 (XML Sitemap)
   - 內部連結結構優化

2. 內容 SEO 策略
   - 主要關鍵字：${keywords.primary.slice(0, 3).join(', ')}
   - 長尾關鍵字：${keywords.longTail.slice(0, 5).join(', ')}
   - 內容深度：每篇文章至少 1500 字
   - 更新頻率：每週 2-3 篇新內容
   - 內容類型：部落格文章、案例研究、白皮書

3. 頁面 SEO 優化
   - 標題標籤 (Title Tag) 包含主要關鍵字
   - Meta 描述優化 (150-160 字元)
   - H1-H6 標籤層級結構
   - 圖片 Alt 標籤優化
   - URL 結構優化

4. 外部 SEO 策略
   - 高品質反向連結建立
   - 行業相關網站合作
   - 社群媒體內容分享
   - 影響者行銷合作
   - 客座文章發布

5. 本地 SEO (適用於實體業務)
   - Google My Business 優化
   - 本地關鍵字優化
   - 客戶評價管理
   - 本地目錄提交
   - 本地內容策略`;
        }

        // 生成綜合關鍵字購買策略
        function generateComprehensiveKeywordPurchaseStrategy(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 的關鍵字購買策略：

1. 主要關鍵字策略 (${keywords.primary.length} 個)
   - 預算分配：總預算的 40%
   - 出價策略：競爭性出價，爭取前三名
   - 匹配類型：廣泛匹配 + 否定關鍵字
   - 目標：品牌知名度、流量建立

2. 長尾關鍵字策略 (${keywords.longTail.length} 個)
   - 預算分配：總預算的 35%
   - 出價策略：精準出價，控制成本
   - 匹配類型：詞組匹配 + 完全匹配
   - 目標：轉換率提升、ROI 優化

3. 商業意圖關鍵字
   - 預算分配：總預算的 15%
   - 出價策略：高競爭出價
   - 匹配類型：完全匹配為主
   - 目標：直接轉換、銷售線索

4. 資訊型關鍵字
   - 預算分配：總預算的 10%
   - 出價策略：中等出價
   - 匹配類型：廣泛匹配
   - 目標：內容行銷、教育客戶

5. 出價建議
   - 主要關鍵字：$$$ (高競爭)
   - 長尾關鍵字：$$ (中等競爭)
   - 商業意圖：$$$ (高價值)
   - 資訊型：$ (低競爭)

6. 預算分配建議
   - 每日預算：根據市場競爭度調整
   - 週期性調整：每週檢視一次
   - 季節性調整：重要節日增加預算
   - A/B 測試：持續優化出價策略`;
        }

        // 生成內容策略建議
        function generateContentStrategyRecommendations(keywords) {
            const businessModel = getBusinessModelInfo(keywords.marketPositioning.businessModel);
            
            return `基於 ${businessModel.name} 的內容策略建議：

1. 內容類型規劃
   - 教育型內容：${keywords.primary.slice(0, 2).join(', ')} 相關指南
   - 案例研究：客戶成功故事、ROI 展示
   - 行業洞察：趨勢分析、市場報告
   - 產品展示：功能介紹、使用教學
   - 客戶服務：FAQ、故障排除

2. 內容主題建議
   - 主要關鍵字主題：${keywords.primary.map(k => `"${k} 完整指南"`).join(', ')}
   - 長尾關鍵字主題：${keywords.longTail.slice(0, 3).map(k => `"${k} 最佳實踐"`).join(', ')}
   - 商業模式主題：${businessModel.focus} 相關內容
   - 客戶痛點主題：解決方案、最佳實踐

3. 內容發布策略
   - 發布頻率：每週 2-3 篇
   - 最佳時間：週二至週四 9:00-11:00
   - 內容長度：1500-3000 字
   - 多媒體內容：影片、資訊圖表、播客

4. 內容推廣策略
   - 社群媒體：LinkedIn、Facebook、Twitter
   - 電子郵件行銷：訂閱者分享
   - 影響者合作：行業專家背書
   - 付費推廣：Facebook Ads、LinkedIn Ads

5. 內容優化建議
   - SEO 優化：關鍵字密度 1-2%
   - 可讀性：Flesch Reading Ease > 60
   - 視覺元素：圖片、影片、圖表
   - 行動優化：響應式設計
   - 互動元素：評論、分享按鈕`;
        }

        // 生成關鍵字分類
        function generateKeywordCategorization(keywords) {
            return `主要關鍵字分類：
- 品牌關鍵字：建立品牌知名度
- 產品關鍵字：直接轉換導向
- 解決方案關鍵字：問題解決導向

長尾關鍵字分類：
- 問題解決型：回答具體問題
- 比較型：產品比較和選擇
- 教程型：教學和指南內容`;
        }

        // 生成競爭分析
        function generateKeywordCompetitionAnalysis(keywords) {
            return `競爭分析：
- 主要關鍵字競爭度：高，需要持續優化
- 長尾關鍵字競爭度：中等，機會較多
- 建議：專注於長尾關鍵字建立優勢
- 監控競爭對手關鍵字策略`;
        }

        // 生成 ROI 預測
        function generateROIPrediction(keywords) {
            return `ROI 預測：
- 短期 (1-3個月)：建立關鍵字排名基礎
- 中期 (3-6個月)：開始看到有機流量增長
- 長期 (6-12個月)：實現穩定的轉換和收入
- 建議：持續投資內容和技術優化`;
        }

        // 生成執行建議
        function generateExecutionRecommendations(keywords) {
            return `執行建議：
1. 立即行動：開始建立關鍵字內容
2. 短期目標：優化主要關鍵字排名
3. 中期目標：建立長尾關鍵字優勢
4. 長期目標：建立品牌權威性
5. 持續優化：定期監控和調整策略`;
        }

        // 搜尋競爭對手
        function searchCompetitors() {
            try {
                const topic = state.analysisData.topic;
                const brandName = state.analysisData.brand?.name;
                const industry = state.analysisData.industry?.category;
                const products = state.analysisData.products || [];

                if (!topic || !brandName || !industry) {
                    showAlert('資料不完整', '請確保填寫了分析主題、品牌名稱和行業類別', 'warning');
                    return;
                }

                console.log('開始搜尋競爭對手...', { topic, brandName, industry, products });
                
                // 顯示載入狀態
                const resultsContainer = document.getElementById('auto-search-results');
                if (resultsContainer) {
                    resultsContainer.innerHTML = `
                        <div class="flex items-center justify-center py-8">
                            <div class="spinner"></div>
                            <span class="ml-3 text-gray-400">正在分析 ${industry} 行業競爭對手...</span>
                        </div>
                    `;
                }

                // 基於行業和產品進行真實競爭對手分析
                setTimeout(async () => {
                    try {
                        const realCompetitors = await analyzeIndustryCompetitors(topic, brandName, industry, products);
                        
                        console.log('競爭對手分析完成，結果:', realCompetitors);
                        
                        if (realCompetitors && realCompetitors.length > 0) {
                            displaySearchResults(realCompetitors);
                            showAlert('分析完成', `成功找到 ${realCompetitors.length} 個競爭對手`, 'success');
                        } else {
                            console.error('競爭對手分析未返回有效資料');
                            showAlert('分析失敗', '未找到相關競爭對手', 'warning');
                            
                            if (resultsContainer) {
                                resultsContainer.innerHTML = `
                                    <div class="text-center py-8">
                                        <p class="text-yellow-400 mb-4">未找到相關競爭對手</p>
                                        <button onclick="searchCompetitors()" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">重新嘗試</button>
                                    </div>
                                `;
                            }
                        }
                    } catch (error) {
                        console.error('競爭對手分析失敗:', error);
                        showAlert('分析失敗', '競爭對手分析過程中發生錯誤', 'error');
                        
                        // 顯示錯誤狀態
                        if (resultsContainer) {
                            resultsContainer.innerHTML = `
                                <div class="text-center py-8">
                                    <p class="text-red-400 mb-4">競爭對手分析失敗</p>
                                    <p class="text-gray-400 text-sm mb-4">錯誤訊息: ${error.message}</p>
                                    <button onclick="searchCompetitors()" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">重新嘗試</button>
                                </div>
                            `;
                        }
                    }
                }, 2000);

            } catch (error) {
                console.error('搜尋競爭對手失敗:', error);
                showAlert('搜尋失敗', '無法搜尋競爭對手', 'error');
            }
        }

        // 基於行業和產品分析真實競爭對手
        async function analyzeIndustryCompetitors(topic, brandName, industry, products) {
            try {
                console.log('開始分析競爭對手:', { topic, brandName, industry, products });
                
                // 檢查是否有 API 設定
                const googleApiKey = document.getElementById('google-api-key')?.value?.trim();
                const searchEngineId = document.getElementById('search-engine-id')?.value?.trim();
                const geminiApiKey = document.getElementById('gemini-api-key')?.value?.trim();
                
                // 如果有完整的 API 設定，嘗試使用智能分析
                if (googleApiKey && searchEngineId && geminiApiKey) {
                    try {
                        console.log('嘗試智能競爭對手分析...');
                        const smartAnalysis = await performSmartCompetitorAnalysis(brandName, industry, products, topic);
                        
                        if (smartAnalysis && smartAnalysis.competitors && smartAnalysis.competitors.length > 0) {
                            console.log('智能分析成功，找到競爭對手:', smartAnalysis.competitors.length);
                            
                            // 轉換為系統格式
                            const competitors = smartAnalysis.competitors.map((comp, index) => ({
                                id: `smart_comp_${Date.now()}_${index}`,
                                name: comp.name,
                                website: comp.website,
                                linkedin: `https://www.linkedin.com/search/results/companies/?keywords=${encodeURIComponent(comp.name)}`,
                                description: comp.description,
                                industry: industry,
                                marketShare: comp.marketShare || 10,
                                strength: comp.strength || 50,
                                weakness: comp.weakness || 50,
                                opportunity: comp.opportunity || 50,
                                threat: comp.threat || 50,
                                productComparison: comp.productComparison || '智能分析結果',
                                selected: false
                            }));
                            
                            // 儲存智能分析結果
                            state.analysisData.smartCompetitorAnalysis = {
                                competitors: competitors,
                                marketInsights: smartAnalysis.marketInsights,
                                competitiveAdvantages: smartAnalysis.competitiveAdvantages,
                                threats: smartAnalysis.threats,
                                recommendations: smartAnalysis.recommendations,
                                searchData: smartAnalysis.searchData
                            };
                            
                            return competitors;
                        } else {
                            console.log('智能分析未返回有效競爭對手資料，回退到模板分析');
                        }
                        
                    } catch (error) {
                        console.error('智能競爭對手分析失敗，回退到模板分析:', error);
                        showAlert('智能分析失敗', '智能分析失敗，已回退到模板分析', 'warning');
                    }
                } else {
                    console.log('API 設定不完整，使用模板分析');
                }
                
                // 回退到模板分析
                console.log('開始模板競爭對手分析...');
                const competitors = [];
                const competitorCount = state.analysisData.competitorCount || 8;
                
                // 根據行業類別生成相關的競爭對手
                const industryCompetitors = getIndustryCompetitors(industry, products);
                console.log('找到行業競爭對手:', industryCompetitors.length);
                
                // 選擇指定數量的競爭對手
                const selectedCompetitors = industryCompetitors.slice(0, competitorCount);
                
                selectedCompetitors.forEach((competitor, index) => {
                    try {
                        const analysis = analyzeCompetitorStrength(competitor, products, industry);
                        competitors.push({
                            id: `comp_${Date.now()}_${index}`,
                            name: competitor.name,
                            website: competitor.website,
                            linkedin: competitor.linkedin,
                            description: competitor.description,
                            industry: industry,
                            marketShare: analysis.marketShare,
                            strength: analysis.strength,
                            weakness: analysis.weakness,
                            opportunity: analysis.opportunity,
                            threat: analysis.threat,
                            productComparison: analysis.productComparison,
                            selected: false
                        });
                    } catch (error) {
                        console.error(`分析競爭對手 ${competitor.name} 失敗:`, error);
                        // 添加預設資料
                        competitors.push({
                            id: `comp_${Date.now()}_${index}`,
                            name: competitor.name,
                            website: competitor.website,
                            linkedin: competitor.linkedin,
                            description: competitor.description,
                            industry: industry,
                            marketShare: 10 + Math.floor(Math.random() * 20),
                            strength: 50 + Math.floor(Math.random() * 30),
                            weakness: 30 + Math.floor(Math.random() * 40),
                            opportunity: 40 + Math.floor(Math.random() * 40),
                            threat: 30 + Math.floor(Math.random() * 40),
                            productComparison: '需要進一步分析',
                            selected: false
                        });
                    }
                });
                
                console.log('模板分析完成，返回競爭對手:', competitors.length);
                return competitors;
                
            } catch (error) {
                console.error('分析行業競爭對手失敗:', error);
                showAlert('分析失敗', '競爭對手分析失敗，請重試', 'error');
                
                // 返回預設競爭對手
                return getDefaultCompetitors(industry);
            }
        }

        // 獲取預設競爭對手
        function getDefaultCompetitors(industry) {
            const defaultCompetitors = [
                {
                    id: `default_comp_${Date.now()}_1`,
                    name: `${industry}競爭對手1`,
                    website: 'https://example.com',
                    linkedin: 'https://www.linkedin.com',
                    description: `${industry}行業的知名競爭對手`,
                    industry: industry,
                    marketShare: 15,
                    strength: 70,
                    weakness: 40,
                    opportunity: 60,
                    threat: 35,
                    productComparison: '需要進一步分析',
                    selected: false
                },
                {
                    id: `default_comp_${Date.now()}_2`,
                    name: `${industry}競爭對手2`,
                    website: 'https://example.com',
                    linkedin: 'https://www.linkedin.com',
                    description: `${industry}行業的重要競爭對手`,
                    industry: industry,
                    marketShare: 12,
                    strength: 65,
                    weakness: 45,
                    opportunity: 55,
                    threat: 40,
                    productComparison: '需要進一步分析',
                    selected: false
                }
            ];
            
            return defaultCompetitors;
        }

        // 根據行業獲取競爭對手資料
        function getIndustryCompetitors(industry, products) {
            const industryMap = {
                'technology': [
                    {
                        name: '鴻海精密工業',
                        website: 'https://www.foxconn.com',
                        linkedin: 'https://www.linkedin.com/company/foxconn',
                        description: '全球最大的電子製造服務商，專注於消費電子產品製造'
                    },
                    {
                        name: '台積電',
                        website: 'https://www.tsmc.com',
                        linkedin: 'https://www.linkedin.com/company/tsmc',
                        description: '全球最大的晶圓代工廠，專注於半導體製造'
                    },
                    {
                        name: '聯發科技',
                        website: 'https://www.mediatek.com',
                        linkedin: 'https://www.linkedin.com/company/mediatek',
                        description: '全球領先的晶片設計公司，專注於行動通訊技術'
                    },
                    {
                        name: '華碩電腦',
                        website: 'https://www.asus.com',
                        linkedin: 'https://www.linkedin.com/company/asus',
                        description: '全球知名電腦硬體製造商，專注於筆電和主機板'
                    },
                    {
                        name: '宏碁',
                        website: 'https://www.acer.com',
                        linkedin: 'https://www.linkedin.com/company/acer',
                        description: '全球知名電腦品牌，專注於個人電腦和顯示器'
                    }
                ],
                'finance': [
                    {
                        name: '國泰世華銀行',
                        website: 'https://www.cathaybk.com.tw',
                        linkedin: 'https://www.linkedin.com/company/cathay-bank',
                        description: '台灣最大的民營銀行，提供全方位的金融服務'
                    },
                    {
                        name: '中國信託商業銀行',
                        website: 'https://www.ctbcbank.com',
                        linkedin: 'https://www.linkedin.com/company/ctbc-bank',
                        description: '台灣領先的民營銀行，專注於消費金融和企業金融'
                    },
                    {
                        name: '富邦金控',
                        website: 'https://www.fubon.com',
                        linkedin: 'https://www.linkedin.com/company/fubon-financial',
                        description: '台灣最大的民營金控公司，提供多元化的金融服務'
                    }
                ],
                'healthcare': [
                    {
                        name: '長庚醫療財團法人',
                        website: 'https://www.cgmh.org.tw',
                        linkedin: 'https://www.linkedin.com/company/chang-gung-memorial-hospital',
                        description: '台灣最大的醫療體系，提供全方位的醫療服務'
                    },
                    {
                        name: '台大醫院',
                        website: 'https://www.ntuh.gov.tw',
                        linkedin: 'https://www.linkedin.com/company/national-taiwan-university-hospital',
                        description: '台灣最具權威的醫學中心，專注於醫學研究和教學'
                    },
                    {
                        name: '奇美醫院',
                        website: 'https://www.chimei.org.tw',
                        linkedin: 'https://www.linkedin.com/company/chimei-medical-center',
                        description: '南台灣重要的醫學中心，專注於急重症醫療'
                    }
                ],
                'retail': [
                    {
                        name: '統一超商',
                        website: 'https://www.7-11.com.tw',
                        linkedin: 'https://www.linkedin.com/company/7-eleven-taiwan',
                        description: '台灣最大的便利商店連鎖，提供便利的零售服務'
                    },
                    {
                        name: '全家便利商店',
                        website: 'https://www.family.com.tw',
                        linkedin: 'https://www.linkedin.com/company/family-mart-taiwan',
                        description: '台灣第二大便利商店連鎖，專注於社區服務'
                    },
                    {
                        name: '家樂福',
                        website: 'https://www.carrefour.com.tw',
                        linkedin: 'https://www.linkedin.com/company/carrefour-taiwan',
                        description: '法國大型零售集團，在台灣提供大賣場服務'
                    }
                ],
                'manufacturing': [
                    {
                        name: '台塑企業',
                        website: 'https://www.fpg.com.tw',
                        linkedin: 'https://www.linkedin.com/company/formosa-plastics-group',
                        description: '台灣最大的民營製造業集團，專注於石化產業'
                    },
                    {
                        name: '中鋼公司',
                        website: 'https://www.csc.com.tw',
                        linkedin: 'https://www.linkedin.com/company/china-steel-corporation',
                        description: '台灣最大的鋼鐵製造商，提供各種鋼鐵產品'
                    },
                    {
                        name: '裕隆汽車',
                        website: 'https://www.yulon-motor.com.tw',
                        linkedin: 'https://www.linkedin.com/company/yulon-motor',
                        description: '台灣重要的汽車製造商，專注於汽車研發和製造'
                    }
                ]
            };
            
            return industryMap[industry] || industryMap['technology'];
        }

        // 分析競爭對手強度
        function analyzeCompetitorStrength(competitor, products, industry) {
            try {
                // 基於產品相似度和行業地位進行分析
                const productSimilarity = calculateProductSimilarity(products, competitor);
                const industryPosition = getIndustryPosition(competitor.name, industry);
                
                return {
                    marketShare: industryPosition.marketShare,
                    strength: Math.min(100, industryPosition.strength + productSimilarity.score * 20),
                    weakness: Math.max(20, 100 - industryPosition.strength - productSimilarity.score * 15),
                    opportunity: Math.min(100, 80 - industryPosition.marketShare + productSimilarity.opportunity * 30),
                    threat: Math.min(100, industryPosition.marketShare + (100 - productSimilarity.score) * 0.5),
                    productComparison: productSimilarity.details
                };
            } catch (error) {
                console.error('分析競爭對手強度失敗:', error);
                // 返回預設值
                return {
                    marketShare: 10 + Math.floor(Math.random() * 20),
                    strength: 50 + Math.floor(Math.random() * 30),
                    weakness: 30 + Math.floor(Math.random() * 40),
                    opportunity: 40 + Math.floor(Math.random() * 40),
                    threat: 30 + Math.floor(Math.random() * 40),
                    productComparison: '需要進一步分析'
                };
            }
        }

        // 計算產品相似度
        function calculateProductSimilarity(products, competitor) {
            try {
                if (!products || products.length === 0) {
                    return { score: 0.5, opportunity: 0.5, details: '無法比較產品相似度' };
                }
                
                let totalScore = 0;
                let totalOpportunity = 0;
                const details = [];
                
                products.forEach(product => {
                    try {
                        const similarity = analyzeProductSimilarity(product, competitor);
                        totalScore += similarity.score;
                        totalOpportunity += similarity.opportunity;
                        details.push(`${product.name || product}: ${similarity.description}`);
                    } catch (error) {
                        console.error('分析產品相似度失敗:', error);
                        totalScore += 0.5;
                        totalOpportunity += 0.5;
                        details.push(`${product.name || product}: 相似度分析失敗`);
                    }
                });
                
                return {
                    score: totalScore / products.length,
                    opportunity: totalOpportunity / products.length,
                    details: details.join('; ')
                };
            } catch (error) {
                console.error('計算產品相似度失敗:', error);
                return { score: 0.5, opportunity: 0.5, details: '相似度計算失敗' };
            }
        }

        // 分析單一產品相似度
        function analyzeProductSimilarity(product, competitor) {
            try {
                const productName = (product.name || product || '').toLowerCase();
                const competitorName = (competitor.name || '').toLowerCase();
                const competitorDesc = (competitor.description || '').toLowerCase();
                
                // 簡單的關鍵字匹配分析
                const keywords = productName.split(' ').filter(k => k.length > 0);
                let matchCount = 0;
                
                if (keywords.length === 0) {
                    return {
                        score: 0.5,
                        opportunity: 0.5,
                        description: `相似度: 50%, 機會: 50%`
                    };
                }
                
                keywords.forEach(keyword => {
                    if (competitorName.includes(keyword) || competitorDesc.includes(keyword)) {
                        matchCount++;
                    }
                });
                
                const score = Math.min(1, matchCount / keywords.length);
                const opportunity = 1 - score; // 相似度越低，機會越大
                
                return {
                    score: score,
                    opportunity: opportunity,
                    description: `相似度: ${Math.round(score * 100)}%, 機會: ${Math.round(opportunity * 100)}%`
                };
            } catch (error) {
                console.error('分析單一產品相似度失敗:', error);
                return {
                    score: 0.5,
                    opportunity: 0.5,
                    description: `相似度: 50%, 機會: 50%`
                };
            }
        }

        // 獲取行業地位
        function getIndustryPosition(competitorName, industry) {
            const positions = {
                '鴻海精密工業': { marketShare: 25, strength: 90 },
                '台積電': { marketShare: 55, strength: 95 },
                '聯發科技': { marketShare: 35, strength: 85 },
                '華碩電腦': { marketShare: 15, strength: 80 },
                '宏碁': { marketShare: 12, strength: 75 },
                '國泰世華銀行': { marketShare: 18, strength: 85 },
                '中國信託商業銀行': { marketShare: 15, strength: 80 },
                '富邦金控': { marketShare: 20, strength: 88 },
                '長庚醫療財團法人': { marketShare: 22, strength: 90 },
                '台大醫院': { marketShare: 18, strength: 95 },
                '奇美醫院': { marketShare: 12, strength: 85 },
                '統一超商': { marketShare: 45, strength: 90 },
                '全家便利商店': { marketShare: 25, strength: 85 },
                '家樂福': { marketShare: 15, strength: 80 },
                '台塑企業': { marketShare: 30, strength: 88 },
                '中鋼公司': { marketShare: 40, strength: 85 },
                '裕隆汽車': { marketShare: 8, strength: 75 }
            };
            
            return positions[competitorName] || { marketShare: 10, strength: 70 };
        }

        // 生成模擬競爭對手資料
        function generateMockCompetitors(topic, brandName) {
            const competitors = [];
            const competitorCount = state.analysisData.competitorCount || 10;
            
            // 根據主題生成相關的競爭對手
            const baseNames = [
                'TechCorp', 'InnovateLab', 'DigitalFlow', 'SmartSolutions', 'FutureTech',
                'CloudWorks', 'DataDrive', 'NextGen', 'PrimeTech', 'EliteSystems',
                'GlobalTech', 'PeakSolutions', 'CoreTech', 'AdvanceWorks', 'MasterTech'
            ];
            
            for (let i = 0; i < competitorCount; i++) {
                const baseName = baseNames[i % baseNames.length];
                const competitor = {
                    id: `comp_${i + 1}`,
                    name: `${baseName} ${i + 1}`,
                    website: `https://www.${baseName.toLowerCase()}${i + 1}.com`,
                    description: `${topic} 相關的專業服務提供商`,
                    industry: state.analysisData.industry?.category || 'technology',
                    marketShare: Math.floor(Math.random() * 30) + 5,
                    strength: Math.floor(Math.random() * 100) + 20,
                    weakness: Math.floor(Math.random() * 100) + 20,
                    opportunity: Math.floor(Math.random() * 100) + 20,
                    threat: Math.floor(Math.random() * 100) + 20,
                    selected: false
                };
                competitors.push(competitor);
            }
            
            return competitors;
        }

        // 顯示搜尋結果
        function displaySearchResults(competitors) {
            try {
                const resultsContainer = document.getElementById('auto-search-results');
                if (!resultsContainer) return;

                if (competitors.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-gray-400">未找到相關競爭對手</p>';
                    return;
                }

                let html = '';
                competitors.forEach(competitor => {
                    html += `
                        <div class="competitor-item bg-gray-800 rounded-lg p-4 border border-gray-700">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="comp_${competitor.id}" class="competitor-checkbox" data-competitor='${JSON.stringify(competitor)}'>
                                    <h5 class="font-semibold text-gray-200">${competitor.name}</h5>
                                    <div class="flex gap-2">
                                        <a href="${competitor.website}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">官網</a>
                                        ${competitor.linkedin ? `<a href="${competitor.linkedin}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">LinkedIn</a>` : ''}
                                    </div>
                                </div>
                                <div class="text-sm text-gray-400">
                                    市場份額: ${competitor.marketShare}%
                                </div>
                            </div>
                            <p class="text-gray-300 text-sm mb-3">${competitor.description}</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs mb-3">
                                <div class="bg-green-900/20 p-2 rounded">
                                    <span class="text-green-400">優勢: ${competitor.strength}</span>
                                </div>
                                <div class="bg-red-900/20 p-2 rounded">
                                    <span class="text-red-400">劣勢: ${competitor.weakness}</span>
                                </div>
                                <div class="bg-blue-900/20 p-2 rounded">
                                    <span class="text-blue-400">機會: ${competitor.opportunity}</span>
                                </div>
                                <div class="bg-yellow-900/20 p-2 rounded">
                                    <span class="text-yellow-400">威脅: ${competitor.threat}</span>
                                </div>
                            </div>
                            ${competitor.productComparison ? `<p class="text-gray-400 text-xs">產品分析: ${competitor.productComparison}</p>` : ''}
                        </div>
                    `;
                });

                resultsContainer.innerHTML = html;

                // 綁定選擇事件
                const checkboxes = resultsContainer.querySelectorAll('.competitor-checkbox');
                checkboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const competitor = JSON.parse(this.dataset.competitor);
                        if (this.checked) {
                            addCompetitor(competitor);
                        } else {
                            removeCompetitor(competitor.id);
                        }
                    });
                });

            } catch (error) {
                console.error('顯示搜尋結果失敗:', error);
            }
        }

        // 添加競爭對手
        function addCompetitor(competitor) {
            try {
                if (!state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = [];
                }
                
                // 檢查是否已存在
                const exists = state.analysisData.selectedCompetitors.find(c => c.id === competitor.id);
                if (!exists) {
                    state.analysisData.selectedCompetitors.push(competitor);
                    updateSelectedCompetitorsDisplay();
                    updateGenerateReportButton();
                }
                
            } catch (error) {
                console.error('添加競爭對手失敗:', error);
            }
        }

        // 移除競爭對手
        function removeCompetitor(competitorId) {
            try {
                if (state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = state.analysisData.selectedCompetitors.filter(c => c.id !== competitorId);
                    updateSelectedCompetitorsDisplay();
                    updateGenerateReportButton();
                }
                
            } catch (error) {
                console.error('移除競爭對手失敗:', error);
            }
        }

        // 更新已選擇競爭對手顯示
        function updateSelectedCompetitorsDisplay() {
            try {
                const container = document.getElementById('selected-competitors');
                const countElement = document.getElementById('selected-count');
                
                if (!container || !countElement) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                countElement.textContent = selectedCompetitors.length;

                if (selectedCompetitors.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">尚未選擇任何競爭對手</p>';
                    return;
                }

                let html = '';
                selectedCompetitors.forEach(competitor => {
                    const websiteText = competitor.website ? competitor.website.replace(/^https?:\/\//, '') : '無網站';
                    html += `
                        <div class="selected-competitor bg-gray-700 rounded-lg p-3 flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3 flex-1">
                                <span class="font-semibold text-gray-200 min-w-0 flex-1">${competitor.name}</span>
                                ${competitor.website ? `<a href="${competitor.website}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">${websiteText}</a>` : ''}
                                <span class="text-gray-400 text-sm">市場份額: ${competitor.marketShare}%</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="editCompetitor('${competitor.id}')" class="text-blue-400 hover:text-blue-300 text-sm px-2 py-1">
                                    ✏️ 編輯
                                </button>
                                <button onclick="removeCompetitor('${competitor.id}')" class="text-red-400 hover:text-red-300 text-sm px-2 py-1">
                                    ✕ 刪除
                                </button>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
                
            } catch (error) {
                console.error('更新已選擇競爭對手顯示失敗:', error);
            }
        }

        // 更新生成報告按鈕狀態
        function updateGenerateReportButton() {
            try {
                const generateBtn = document.getElementById('generate-report-btn');
                if (!generateBtn) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                
                if (selectedCompetitors.length > 0) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = `生成完整報告 (${selectedCompetitors.length} 個競爭對手)`;
                } else {
                    generateBtn.disabled = true;
                    generateBtn.textContent = '生成完整報告';
                }
                
            } catch (error) {
                console.error('更新生成報告按鈕狀態失敗:', error);
            }
        }

        // 顯示完整報告
        function displayFinalReport() {
            try {
                const reportContainer = document.getElementById('final-report-content');
                if (!reportContainer) return;

                const selectedCompetitors = state.analysisData.selectedCompetitors || [];
                
                if (selectedCompetitors.length === 0) {
                    reportContainer.innerHTML = '<p class="text-gray-400">請先完成步驟 2 的對手篩選</p>';
                    return;
                }

                // 生成報告內容
                const report = generateFinalReport(selectedCompetitors);
                reportContainer.innerHTML = report;
                
            } catch (error) {
                console.error('顯示完整報告失敗:', error);
            }
        }

        // 生成完整報告
        function generateFinalReport(competitors) {
            const brand = state.analysisData.brand?.name || '未指定';
            const topic = state.analysisData.topic || '未指定';
            const industry = state.analysisData.industry?.category || '未指定';
            const keywords = state.analysisData.keywords || {};
            
            // 檢查是否有智能分析結果
            const smartAnalysis = state.analysisData.smartCompetitorAnalysis;
            const isSmartAnalysis = smartAnalysis && smartAnalysis.marketInsights;
            
            return `
                <div class="space-y-6">
                    <!-- 競爭對手分析報告 -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">
                            📊 ${brand} - ${topic} 競爭對手分析報告
                            ${isSmartAnalysis ? '<span class="text-green-400 text-sm ml-2">🤖 AI 智能分析</span>' : '<span class="text-yellow-400 text-sm ml-2">📋 模板分析</span>'}
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">📈 分析概況</h4>
                                <p class="text-gray-300 text-sm">分析了 ${competitors.length} 個競爭對手</p>
                                <p class="text-gray-300 text-sm">分析主題: ${topic}</p>
                                <p class="text-gray-300 text-sm">所屬產業: ${industry}</p>
                                <p class="text-gray-300 text-sm">生成時間: ${new Date().toLocaleString('zh-TW')}</p>
                                <p class="text-gray-300 text-sm">分析方式: ${isSmartAnalysis ? 'Google Search API + Gemini AI' : '靜態模板'}</p>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-2">🎯 競爭對手清單</h4>
                                <div class="space-y-2">
                                    ${competitors.map(comp => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-300 text-sm">${comp.name}</span>
                                            <span class="text-blue-400 text-sm">${comp.marketShare}%</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        ${isSmartAnalysis ? `
                        <!-- AI 智能分析結果 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-3">🧠 AI 市場洞察</h4>
                                <div class="space-y-2">
                                    ${smartAnalysis.marketInsights.map(insight => `
                                        <p class="text-gray-300 text-sm">• ${insight}</p>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-3">💡 競爭優勢</h4>
                                <div class="space-y-2">
                                    ${smartAnalysis.competitiveAdvantages.map(advantage => `
                                        <p class="text-gray-300 text-sm">• ${advantage}</p>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-3">⚠️ 潛在威脅</h4>
                                <div class="space-y-2">
                                    ${smartAnalysis.threats.map(threat => `
                                        <p class="text-gray-300 text-sm">• ${threat}</p>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="bg-gray-700 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-200 mb-3">🎯 AI 策略建議</h4>
                                <div class="space-y-2">
                                    ${smartAnalysis.recommendations.map(recommendation => `
                                        <p class="text-gray-300 text-sm">• ${recommendation}</p>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-700 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">🔍 搜尋資料摘要</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-400">發現公司:</span>
                                    <span class="text-gray-300 ml-2">${smartAnalysis.searchData.companies.length} 個</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">相關網站:</span>
                                    <span class="text-gray-300 ml-2">${smartAnalysis.searchData.websites.length} 個</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">關鍵字:</span>
                                    <span class="text-gray-300 ml-2">${smartAnalysis.searchData.keywords.length} 個</span>
                                </div>
                                <div>
                                    <span class="text-gray-400">市場指標:</span>
                                    <span class="text-gray-300 ml-2">${smartAnalysis.searchData.marketIndicators.length} 個</span>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="bg-gray-700 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-200 mb-3">📋 詳細分析</h4>
                            <p class="text-gray-300 text-sm">完整分析報告已準備就緒，請使用下方的關鍵字和文案產出工具。</p>
                            <p class="text-gray-400 text-sm mt-2">💡 提示：設定 Google API Key、Search Engine ID 和 Gemini API Key 可啟用 AI 智能分析功能</p>
                        </div>
                        `}
                    </div>

                    <!-- 關鍵字建議清單 -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">🔍 關鍵字建議清單</h3>
                        
                        <!-- 商業模式選擇 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">📊 商業模式選擇</h4>
                            <select id="business-model-select-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                <option value="">請選擇商業模式</option>
                                <option value="b2b">B2B (企業對企業)</option>
                                <option value="b2c">B2C (企業對消費者)</option>
                                <option value="b2b2c">B2B2C (企業對企業對消費者)</option>
                                <option value="c2c">C2C (消費者對消費者)</option>
                                <option value="saas">SaaS (軟體即服務)</option>
                                <option value="marketplace">Marketplace (平台模式)</option>
                                <option value="subscription">Subscription (訂閱模式)</option>
                                <option value="freemium">Freemium (免費增值)</option>
                                <option value="ecommerce">E-commerce (電商)</option>
                                <option value="agency">Agency (代理/服務)</option>
                            </select>
                        </div>

                        <!-- 關鍵字類型選擇 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">🎯 關鍵字類型選擇</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-primary" class="form-checkbox mr-2">
                                    <span class="text-gray-300">主要關鍵字</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-longtail" class="form-checkbox mr-2">
                                    <span class="text-gray-300">長尾關鍵字</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-commercial" class="form-checkbox mr-2">
                                    <span class="text-gray-300">商業意圖</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-informational" class="form-checkbox mr-2">
                                    <span class="text-gray-300">資訊查詢</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-navigational" class="form-checkbox mr-2">
                                    <span class="text-gray-300">導航查詢</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="keyword-transactional" class="form-checkbox mr-2">
                                    <span class="text-gray-300">交易意圖</span>
                                </label>
                            </div>
                        </div>

                        <!-- 關鍵字內容顯示 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">📝 關鍵字內容</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">主要關鍵字</label>
                                    <textarea id="primary-keywords-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="4" placeholder="主要關鍵字，每行一個" readonly>${(keywords.primary || []).join('\n')}</textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">長尾關鍵字</label>
                                    <textarea id="long-tail-keywords-step3" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="4" placeholder="長尾關鍵字，每行一個" readonly>${(keywords.longTail || []).join('\n')}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- 操作按鈕 -->
                        <div class="flex gap-4 flex-wrap">
                            <button onclick="performSmartKeywordSearch()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">
                                🔍 智能搜尋關鍵字
                            </button>
                            <button onclick="generateKeywordSuggestions()" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">
                                📋 生成完整關鍵字建議書
                            </button>
                        </div>
                    </div>

                    <!-- 智能關鍵字建議書 -->
                    <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                        <h3 class="text-xl font-semibold text-techaccent mb-4">📊 智能關鍵字建議書</h3>
                        
                        <!-- SEO分類規則 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">🏷️ SEO分類規則</h4>
                            <div id="seo-categories-display" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-200 mb-2">主要關鍵字 (Head Terms)</h5>
                                    <p class="text-gray-300 text-sm">搜尋量大，競爭度高，適合品牌建立</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-200 mb-2">長尾關鍵字 (Long Tail)</h5>
                                    <p class="text-gray-300 text-sm">搜尋量小，競爭度低，轉換率高</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-200 mb-2">品牌關鍵字 (Branded)</h5>
                                    <p class="text-gray-300 text-sm">品牌相關搜尋，高轉換率</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3">
                                    <h5 class="font-semibold text-gray-200 mb-2">產品關鍵字 (Product)</h5>
                                    <p class="text-gray-300 text-sm">具體產品搜尋，商業意圖強</p>
                                </div>
                            </div>
                        </div>

                        <!-- 出價策略 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">💰 出價策略建議</h4>
                            <div id="bidding-strategy-display" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-green-900/20 rounded-lg p-3 border border-green-500/20">
                                    <h5 class="font-semibold text-green-400 mb-2">高搜尋量高競爭度</h5>
                                    <p class="text-gray-300 text-sm">建議出價 NT$ 25-40，專注於高轉換率</p>
                                </div>
                                <div class="bg-blue-900/20 rounded-lg p-3 border border-blue-500/20">
                                    <h5 class="font-semibold text-blue-400 mb-2">高搜尋量低競爭度</h5>
                                    <p class="text-gray-300 text-sm">建議出價 NT$ 15-25，擴大市場份額</p>
                                </div>
                                <div class="bg-yellow-900/20 rounded-lg p-3 border border-yellow-500/20">
                                    <h5 class="font-semibold text-yellow-400 mb-2">低搜尋量高競爭度</h5>
                                    <p class="text-gray-300 text-sm">建議出價 NT$ 8-15，精準定位</p>
                                </div>
                                <div class="bg-purple-900/20 rounded-lg p-3 border border-purple-500/20">
                                    <h5 class="font-semibold text-purple-400 mb-2">低搜尋量低競爭度</h5>
                                    <p class="text-gray-300 text-sm">建議出價 NT$ 5-12，低成本測試</p>
                                </div>
                            </div>
                        </div>

                        <!-- 市場洞察 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">📈 市場洞察</h4>
                            <div id="market-insights-display" class="bg-gray-700 rounded-lg p-4">
                                <p class="text-gray-300 text-sm">智能分析完成後將顯示市場洞察</p>
                            </div>
                        </div>

                        <!-- 語言版本對應 -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-200 mb-3">🌍 語言版本對應</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="bg-gray-700 rounded-lg p-3 text-center">
                                    <h5 class="font-semibold text-gray-200 mb-1">繁體中文</h5>
                                    <p class="text-gray-300 text-sm">台灣市場</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3 text-center">
                                    <h5 class="font-semibold text-gray-200 mb-1">English</h5>
                                    <p class="text-gray-300 text-sm">國際市場</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3 text-center">
                                    <h5 class="font-semibold text-gray-200 mb-1">日本語</h5>
                                    <p class="text-gray-300 text-sm">日本市場</p>
                                </div>
                                <div class="bg-gray-700 rounded-lg p-3 text-center">
                                    <h5 class="font-semibold text-gray-200 mb-1">한국어</h5>
                                    <p class="text-gray-300 text-sm">韓國市場</p>
                                </div>
                            </div>
                        </div>

                        <!-- 下載按鈕 -->
                        <div class="flex gap-4">
                            <button onclick="downloadKeywordReport()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                                💾 下載完整關鍵字建議書
                            </button>
                            <button onclick="downloadKeywordCSV()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                                📊 下載關鍵字 CSV
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 手動添加競爭對手
        function addManualCompetitor() {
            try {
                const input = document.getElementById('manual-competitor');
                const competitorNames = input?.value?.trim();
                
                if (!competitorNames) {
                    showAlert('請輸入競爭對手名稱', '競爭對手名稱不能為空', 'warning');
                    return;
                }

                // 分割逗號分隔的競爭對手名稱
                const competitors = competitorNames.split(',').map(name => name.trim()).filter(name => name.length > 0);
                
                if (competitors.length === 0) {
                    showAlert('請輸入有效的競爭對手名稱', '競爭對手名稱不能為空', 'warning');
                    return;
                }

                // 初始化選擇清單
                if (!state.analysisData.selectedCompetitors) {
                    state.analysisData.selectedCompetitors = [];
                }

                let addedCount = 0;
                let skippedCount = 0;

                competitors.forEach((competitorName, index) => {
                    // 為手動添加的競爭對手創建唯一ID
                    const manualId = `manual_${Date.now()}_${index}`;
                    
                    // 檢查是否已經選擇（基於名稱）
                    const exists = state.analysisData.selectedCompetitors.find(c => c.name === competitorName);
                    if (exists) {
                        skippedCount++;
                        return;
                    }

                    // 創建競爭對手物件
                    const competitor = {
                        id: manualId,
                        name: competitorName,
                        website: `https://www.google.com/search?q=${encodeURIComponent(competitorName)}`,
                        linkedin: null,
                        description: `${competitorName} - 手動添加的競爭對手`,
                        industry: state.analysisData.industry?.category || 'other',
                        marketShare: Math.floor(Math.random() * 20) + 5, // 隨機市場份額
                        strength: Math.floor(Math.random() * 60) + 40,
                        weakness: Math.floor(Math.random() * 60) + 40,
                        opportunity: Math.floor(Math.random() * 60) + 40,
                        threat: Math.floor(Math.random() * 60) + 40,
                        productComparison: '手動添加，需要進一步分析',
                        selected: true
                    };

                    // 添加到選擇清單
                    state.analysisData.selectedCompetitors.push(competitor);
                    addedCount++;
                });
                
                // 更新顯示
                updateSelectedCompetitorsDisplay();
                
                // 清空輸入框
                input.value = '';
                
                // 顯示結果
                if (addedCount > 0) {
                    const message = skippedCount > 0 
                        ? `已添加 ${addedCount} 個競爭對手，跳過 ${skippedCount} 個重複項目`
                        : `已添加 ${addedCount} 個競爭對手`;
                    showAlert('添加成功', message, 'success');
                } else {
                    showAlert('沒有新增', '所有競爭對手都已存在於選擇清單中', 'warning');
                }
                
            } catch (error) {
                console.error('手動添加競爭對手失敗:', error);
                showAlert('添加失敗', '無法添加競爭對手', 'error');
            }
        }

        // 設定步驟 1 的事件監聽器
        function setupStep1EventListeners() {
            try {
                // 添加產品按鈕
                const addProductBtn = document.getElementById('add-product-btn');
                if (addProductBtn) {
                    addProductBtn.addEventListener('click', function() {
                        const productsContainer = document.getElementById('products-container');
                        if (productsContainer) {
                            const productItem = document.createElement('div');
                            productItem.className = 'product-item bg-gray-800 rounded-lg p-4 mb-3';
                            productItem.innerHTML = `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">產品/服務名稱</label>
                                        <input type="text" class="product-name w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="主要產品名稱">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">價格定位</label>
                                        <select class="product-pricing w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                                            <option value="">選擇價格定位</option>
                                            <option value="premium">高價位 (Premium)</option>
                                            <option value="mid-high">中高價位</option>
                                            <option value="mid">中價位</option>
                                            <option value="mid-low">中低價位</option>
                                            <option value="budget">平價 (Budget)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300 mb-2">目標客群</label>
                                        <input type="text" class="product-target w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="目標客群描述">
                                    </div>
                                </div>
                                <button class="remove-product-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs mt-2">移除</button>
                            `;
                            
                            // 添加移除功能
                            const removeBtn = productItem.querySelector('.remove-product-btn');
                            removeBtn.addEventListener('click', function() {
                                productItem.remove();
                            });
                            
                            productsContainer.appendChild(productItem);
                        }
                    });
                }

                // 開始分析按鈕
                const startAnalysisBtn = document.getElementById('start-analysis-btn');
                if (startAnalysisBtn) {
                    startAnalysisBtn.addEventListener('click', startAnalysis);
                }

                // 手動添加競爭對手按鈕
                const addCompetitorBtn = document.getElementById('add-competitor-btn');
                if (addCompetitorBtn) {
                    addCompetitorBtn.addEventListener('click', addManualCompetitor);
                }

                // 生成報告按鈕
                const generateReportBtn = document.getElementById('generate-report-btn');
                if (generateReportBtn) {
                    generateReportBtn.addEventListener('click', generateFinalReport);
                }

                // 返回步驟 1 按鈕
                const backToStep1Btn = document.getElementById('back-to-step1-btn');
                if (backToStep1Btn) {
                    backToStep1Btn.addEventListener('click', function() {
                        goToStep(1);
                    });
                }

                console.log('步驟 1 事件監聽器設定完成');
            } catch (error) {
                console.error('設定步驟 1 事件監聽器失敗:', error);
            }
        }

        // 生成 Google Ads 文案
        async function generateAdsCopy() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                const targetAudience = document.getElementById('target-audience-ads')?.value;
                const copyStyle = document.getElementById('copy-style')?.value;
                
                if (!businessModel) {
                    showAlert('請選擇商業模式', '商業模式是生成廣告文案的必要條件', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || '未指定';
                const industry = state.analysisData.industry?.category || '未指定';

                // 使用智能文案生成
                const smartCopy = await performSmartCopyGeneration(brand, industry, businessModel, targetAudience, copyStyle);
                
                // 更新預覽區域
                const previewArea = document.getElementById('ads-copy-preview');
                if (previewArea) {
                    const formattedCopy = formatSmartCopyForDisplay(smartCopy, brand, businessModel, targetAudience, copyStyle);
                    previewArea.innerHTML = formattedCopy.replace(/\n/g, '<br>');
                }

                // 儲存生成的文案到狀態
                state.analysisData.generatedAdsCopy = smartCopy;

                showAlert('智能文案生成成功', '使用 Google Search API 和 AI 分析生成的文案已準備就緒', 'success');
                
            } catch (error) {
                console.error('生成 Google Ads 文案失敗:', error);
                showAlert('生成失敗', `無法生成 Google Ads 文案: ${error.message}`, 'error');
            }
        }

        // 格式化智能文案用於顯示
        function formatSmartCopyForDisplay(smartCopy, brand, businessModel, targetAudience, copyStyle) {
            let content = `智能生成 Google Ads 廣告文案\n`;
            content += `================================\n\n`;
            content += `品牌名稱: ${brand}\n`;
            content += `商業模式: ${businessModel}\n`;
            content += `目標受眾: ${targetAudience}\n`;
            content += `文案風格: ${copyStyle}\n`;
            content += `生成時間: ${new Date().toLocaleString('zh-TW')}\n`;
            content += `生成方式: Google Search API + AI 智能分析\n\n`;
            
            content += `標題建議:\n`;
            smartCopy.headlines.forEach(headline => {
                content += `- ${headline}\n`;
            });
            
            content += `\n描述建議:\n`;
            smartCopy.descriptions.forEach(desc => {
                content += `- ${desc}\n`;
            });
            
            content += `\n行動呼籲:\n`;
            smartCopy.cta.forEach(cta => {
                content += `- ${cta}\n`;
            });
            
            return content;
        }

        // 生成廣告文案內容
        function generateAdsCopyContent(businessModel, targetAudience, copyStyle) {
            const brand = state.analysisData.brand?.name || '未指定';
            const topic = state.analysisData.topic || '未指定';
            
            let content = `Google Ads 廣告文案\n`;
            content += `================================\n\n`;
            content += `品牌名稱: ${brand}\n`;
            content += `分析主題: ${topic}\n`;
            content += `商業模式: ${businessModel}\n`;
            content += `目標受眾: ${targetAudience}\n`;
            content += `文案風格: ${copyStyle}\n`;
            content += `生成時間: ${new Date().toLocaleString('zh-TW')}\n\n`;
            
            // 根據商業模式生成文案
            const copyTemplates = getCopyTemplates(businessModel, targetAudience, copyStyle);
            
            content += `標題建議:\n`;
            copyTemplates.headlines.forEach(headline => {
                content += `- ${headline}\n`;
            });
            
            content += `\n描述建議:\n`;
            copyTemplates.descriptions.forEach(desc => {
                content += `- ${desc}\n`;
            });
            
            content += `\n行動呼籲:\n`;
            copyTemplates.cta.forEach(cta => {
                content += `- ${cta}\n`;
            });
            
            return content;
        }

        // 獲取文案模板
        function getCopyTemplates(businessModel, targetAudience, copyStyle) {
            const brand = state.analysisData.brand?.name || '品牌';
            const topic = state.analysisData.topic || '產品';
            const industry = state.analysisData.industry?.category || '科技';
            const products = state.analysisData.products || [];
            
            // 從產品中提取關鍵詞
            const productKeywords = products.map(p => p.name || p).filter(p => p && p.trim());
            const primaryProduct = productKeywords[0] || topic;
            
            const templates = {
                b2b: {
                    headlines: [
                        `${brand} 專業企業解決方案`,
                        `${primaryProduct} 提升企業效率`,
                        `${brand} ${industry} 值得信賴`,
                        `${primaryProduct} 企業級服務`,
                        `${brand} 商業合作首選`
                    ],
                    descriptions: [
                        `${brand}為企業提供專業${primaryProduct}解決方案，提升營運效率，${industry}領域專家`,
                        `${primaryProduct}專家${brand}，多年企業服務經驗，客戶滿意度高，${industry}領導品牌`,
                        `${brand}${primaryProduct}服務，快速響應，專業團隊，${industry}解決方案專家`
                    ],
                    cta: [
                        '立即諮詢',
                        '免費評估',
                        '了解更多',
                        '預約演示',
                        '合作洽談'
                    ]
                },
                b2c: {
                    headlines: [
                        `${brand} 優質${primaryProduct}`,
                        `${primaryProduct} 首選${brand}`,
                        `${brand} ${industry} 生活品質`,
                        `${primaryProduct} ${brand} 推薦`,
                        `${brand} 消費者信賴`
                    ],
                    descriptions: [
                        `${brand}提供優質${primaryProduct}，${industry}品質保證，價格實惠，立即體驗`,
                        `${primaryProduct}首選${brand}，${industry}多年經驗，客戶好評如潮，限時優惠`,
                        `${brand}${primaryProduct}，${industry}快速配送，貼心服務，品質可靠`
                    ],
                    cta: [
                        '立即購買',
                        '限時優惠',
                        '馬上體驗',
                        '加入購物車',
                        '立即下單'
                    ]
                },
                saas: {
                    headlines: [
                        `${brand} 雲端${primaryProduct}`,
                        `${primaryProduct} SaaS平台`,
                        `${brand} ${industry} 線上工具`,
                        `${primaryProduct} 雲端服務`,
                        `${brand} 軟體平台`
                    ],
                    descriptions: [
                        `${brand}提供雲端${primaryProduct}解決方案，${industry}技術領先，提升效率，節省成本`,
                        `${primaryProduct}雲端服務${brand}，${industry}技術領先，穩定可靠，免費試用`,
                        `${brand}${primaryProduct}平台，${industry}功能強大，操作簡單，滿意再付費`
                    ],
                    cta: [
                        '免費試用',
                        '立即註冊',
                        '開始使用',
                        '免費體驗',
                        '立即開通'
                    ]
                }
            };
            
            // 根據目標受眾和文案風格調整
            const adjustedTemplates = adjustTemplatesByAudienceAndStyle(
                templates[businessModel] || templates.b2b,
                targetAudience,
                copyStyle,
                brand,
                primaryProduct,
                industry
            );
            
            return adjustedTemplates;
        }

        // 根據目標受眾和文案風格調整模板
        function adjustTemplatesByAudienceAndStyle(templates, targetAudience, copyStyle, brand, primaryProduct, industry) {
            const adjusted = { ...templates };
            
            // 根據目標受眾調整
            if (targetAudience === 'youth') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('專業', '創新').replace('值得信賴', '年輕首選'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('專業', '創新').replace('多年經驗', '年輕活力'));
            } else if (targetAudience === 'elderly') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('專業', '貼心').replace('值得信賴', '安心可靠'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('專業', '貼心').replace('快速響應', '耐心服務'));
            } else if (targetAudience === 'professional') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('專業', '頂尖').replace('值得信賴', '專業認證'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('專業', '頂尖').replace('多年經驗', '專業認證'));
            }
            
            // 根據文案風格調整
            if (copyStyle === 'urgent') {
                adjusted.headlines = adjusted.headlines.map(h => `限時！${h}`);
                adjusted.descriptions = adjusted.descriptions.map(d => `${d}，機會難得，立即行動！`);
                adjusted.cta = adjusted.cta.map(c => `立即${c}`);
            } else if (copyStyle === 'luxury') {
                adjusted.headlines = adjusted.headlines.map(h => `尊榮${h}`);
                adjusted.descriptions = adjusted.descriptions.map(d => `${d}，尊榮體驗，品質保證`);
                adjusted.cta = adjusted.cta.map(c => `尊榮${c}`);
            } else if (copyStyle === 'casual') {
                adjusted.headlines = adjusted.headlines.map(h => h.replace('專業', '輕鬆').replace('值得信賴', '簡單好用'));
                adjusted.descriptions = adjusted.descriptions.map(d => d.replace('專業', '輕鬆').replace('多年經驗', '簡單好用'));
            }
            
            return adjusted;
        }

        // 預覽廣告文案
        function previewAdsCopy() {
            const previewArea = document.getElementById('ads-copy-preview');
            if (previewArea && previewArea.innerHTML.includes('選擇關鍵字和設定後')) {
                showAlert('請先生成文案', '請先點擊「生成 Google Ads 文案」按鈕', 'warning');
                return;
            }
            
            showAlert('預覽功能', '文案已在預覽區域顯示', 'info');
        }

        // 下載廣告文案
        function downloadAdsCopy() {
            try {
                const previewArea = document.getElementById('ads-copy-preview');
                if (!previewArea || previewArea.innerHTML.includes('選擇關鍵字和設定後')) {
                    showAlert('請先生成文案', '請先點擊「生成 Google Ads 文案」按鈕', 'warning');
                    return;
                }
                
                // 獲取文案內容
                const content = previewArea.innerText || previewArea.textContent;
                
                // 獲取 project ID，如果有的話用於檔案名稱
                const projectId = state.analysisData.projectId;
                const fileName = projectId && projectId !== `TEMP_${Date.now()}` 
                    ? `Google_Ads_文案_${projectId}_${new Date().toISOString().split('T')[0]}.txt`
                    : `Google_Ads_文案_${new Date().toISOString().split('T')[0]}.txt`;
                
                // 創建下載連結
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showAlert('下載成功', 'Google Ads 文案已下載', 'success');
                
            } catch (error) {
                console.error('下載廣告文案失敗:', error);
                showAlert('下載失敗', '無法下載廣告文案', 'error');
            }
        }

        // 生成完整關鍵字建議書
async function generateKeywordSuggestions() {
    try {
        const businessModel = document.getElementById('business-model-select-step3')?.value;
        const selectedTypes = [];
        // 獲取選中的關鍵字類型
        const checkboxes = ['keyword-primary', 'keyword-longtail', 'keyword-commercial', 'keyword-informational', 'keyword-navigational', 'keyword-transactional'];
        checkboxes.forEach(id => {
            if (document.getElementById(id)?.checked) {
                selectedTypes.push(id.replace('keyword-', ''));
            }
        });
        if (!businessModel) {
            showAlert('請選擇商業模式', '商業模式是生成關鍵字建議的必要條件', 'warning');
            return;
        }
        if (selectedTypes.length === 0) {
            showAlert('請選擇關鍵字類型', '至少選擇一種關鍵字類型', 'warning');
            return;
        }
        const brand = state.analysisData.brand?.name || '未指定';
        const industry = state.analysisData.industry?.category || '未指定';
        // 使用完整關鍵字清單產生器
        const completeKeywordAnalysis = await generateCompleteKeywordList(brand, industry, businessModel, selectedTypes);
        // 生成完整關鍵字建議書內容
        const suggestions = generateCompleteKeywordSuggestionsContent(completeKeywordAnalysis, businessModel, selectedTypes);
        // 創建下載連結
        const blob = new Blob([suggestions], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        // 獲取 project ID，如果有的話用於檔案名稱
        const projectId = state.analysisData.projectId;
        const fileName = projectId && projectId !== `TEMP_${Date.now()}` 
            ? `完整關鍵字建議書_${projectId}_${businessModel}_${new Date().toISOString().split('T')[0]}.txt`
            : `完整關鍵字建議書_${businessModel}_${new Date().toISOString().split('T')[0]}.txt`;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        // 儲存完整分析結果到狀態
        state.analysisData.completeKeywordAnalysis = completeKeywordAnalysis;
        showAlert('完整關鍵字生成成功', '已生成40-50組關鍵字並按出價策略分類的完整建議書', 'success');
    } catch (error) {
        console.error('生成關鍵字建議書失敗:', error);
        showAlert('生成失敗', `無法生成關鍵字建議書: ${error.message}`, 'error');
    }
}

// 完整關鍵字清單產生器
async function generateCompleteKeywordList(brand, industry, businessModel, selectedTypes) {
    try {
        // 強制每種類型產生8-10組關鍵字
        const completeKeywords = {};
        const biddingStrategies = {
            highSearchHighCompetition: '高搜尋量高競爭',
            highSearchLowCompetition: '高搜尋量低競爭', 
            lowSearchHighCompetition: '低搜尋量高競爭',
            lowSearchLowCompetition: '低搜尋量低競爭'
        };
        selectedTypes.forEach(type => {
            const keywordsForType = generateExtendedKeywordsForType(brand, industry, businessModel, type, 10);
            completeKeywords[type] = keywordsForType;
        });
        // 按出價策略分類關鍵字
        const categorizedKeywords = categorizeKeywordsByBiddingStrategy(completeKeywords, brand, industry);
        // 生成競爭對手分析
        const competitors = generateCompetitorAnalysis(brand, industry);
        // 生成趨勢分析
        const trends = generateTrendAnalysis(brand, industry, businessModel);
        // 生成AI洞察
        const insights = generateAIInsights(brand, industry, businessModel, completeKeywords);
        // 生成策略建議
        const recommendations = generateStrategyRecommendations(completeKeywords, categorizedKeywords);
        return {
            keywords: completeKeywords,
            categorizedKeywords: categorizedKeywords,
            competitors: competitors,
            trends: trends,
            insights: insights,
            recommendations: recommendations,
            biddingStrategies: biddingStrategies,
            totalKeywords: Object.values(completeKeywords).flat().length
        };
    } catch (error) {
        console.error('完整關鍵字清單生成失敗:', error);
        throw error;
    }
}

// 為特定類型生成擴展關鍵字（8-10組）
function generateExtendedKeywordsForType(brand, industry, businessModel, type, count = 10) {
    const keywords = [];
    const baseKeywords = generateKeywordsByModel(businessModel, [type])[type] || [];
    // 基礎關鍵字模板
    const templates = {
        primary: [
            `${brand}`,
            `${brand} ${industry}`,
            `${industry} ${brand}`,
            `${brand} 評價`,
            `${brand} 推薦`,
            `${brand} 服務`,
            `${brand} 解決方案`,
            `${brand} 專業`,
            `${brand} 領導品牌`,
            `${brand} 最佳選擇`
        ],
        longtail: [
            `${brand} ${industry} 評價`,
            `${industry} ${brand} 比較`,
            `${brand} ${industry} 推薦`,
            `${brand} 服務 評價`,
            `${brand} 解決方案 比較`,
            `${brand} ${industry} 價格`,
            `${brand} 專業 服務`,
            `${brand} 領導品牌 ${industry}`,
            `${brand} 最佳選擇 ${industry}`,
            `${brand} ${industry} 特色`
        ],
        commercial: [
            `購買 ${brand}`,
            `${brand} 訂購`,
            `${brand} ${industry} 服務`,
            `${brand} 報價`,
            `${brand} 諮詢`,
            `${brand} 合作`,
            `${brand} 企業服務`,
            `${brand} 商業解決方案`,
            `${brand} 專業諮詢`,
            `${brand} 客製化服務`
        ],
        informational: [
            `${brand} 介紹`,
            `${brand} ${industry} 說明`,
            `${brand} 指南`,
            `${brand} 教學`,
            `${brand} 特色`,
            `${brand} 功能`,
            `${brand} 優勢`,
            `${brand} 技術`,
            `${brand} 創新`,
            `${brand} 發展`
        ],
        navigational: [
            `${brand} 官網`,
            `${brand} 官方網站`,
            `${brand} 網站`,
            `${brand} 首頁`,
            `${brand} 線上服務`,
            `${brand} 網路平台`,
            `${brand} 數位服務`,
            `${brand} 線上諮詢`,
            `${brand} 網路預約`,
            `${brand} 線上購買`
        ],
        transactional: [
            `${brand} 購買`,
            `${brand} 下單`,
            `${brand} 訂購`,
            `${brand} 立即購買`,
            `${brand} 馬上購買`,
            `${brand} 線上購買`,
            `${brand} 網路購買`,
            `${brand} 快速購買`,
            `${brand} 優惠購買`,
            `${brand} 限時購買`
        ]
    };
    // 根據商業模式調整關鍵字
    const modelSpecificTemplates = getModelSpecificTemplates(businessModel, type);
    // 合併所有關鍵字並去重
    const allKeywords = [...new Set([
        ...baseKeywords,
        ...templates[type] || [],
        ...modelSpecificTemplates
    ])];
    // 返回指定數量的關鍵字
    return allKeywords.slice(0, count);
}

// 獲取商業模式特定的關鍵字模板
function getModelSpecificTemplates(businessModel, type) {
    const templates = {
        b2b: {
            primary: ['企業解決方案', 'B2B服務', '企業版', '商業服務', '企業合作'],
            longtail: ['企業解決方案 比較', 'B2B服務 推薦', '企業版 評價', '商業服務 比較'],
            commercial: ['企業解決方案 報價', 'B2B服務 諮詢', '企業版 試用', '商業服務 合作'],
            informational: ['企業解決方案 介紹', 'B2B服務 說明', '企業版 指南', '商業服務 特色'],
            navigational: ['企業解決方案 官網', 'B2B服務 官網', '企業版 網站', '商業服務 官網'],
            transactional: ['企業解決方案 購買', 'B2B服務 簽約', '企業版 授權', '商業服務 合作']
        },
        b2c: {
            primary: ['消費者產品', '個人服務', '生活用品', '個人版', '消費服務'],
            longtail: ['消費者產品 評價', '個人服務 推薦', '生活用品 比較', '個人版 評價'],
            commercial: ['消費者產品 購買', '個人服務 預約', '生活用品 下單', '個人版 購買'],
            informational: ['消費者產品 介紹', '個人服務 說明', '生活用品 指南', '個人版 教學'],
            navigational: ['消費者產品 官網', '個人服務 官網', '生活用品 網站', '個人版 官網'],
            transactional: ['消費者產品 價格', '個人服務 費用', '生活用品 優惠', '個人版 價格']
        },
        saas: {
            primary: ['雲端軟體', 'SaaS平台', '線上工具', '雲端服務', '軟體平台'],
            longtail: ['雲端軟體 比較', 'SaaS平台 推薦', '線上工具 評價', '雲端服務 比較'],
            commercial: ['雲端軟體 試用', 'SaaS平台 註冊', '線上工具 購買', '雲端服務 訂閱'],
            informational: ['雲端軟體 介紹', 'SaaS平台 說明', '線上工具 指南', '雲端服務 教學'],
            navigational: ['雲端軟體 官網', 'SaaS平台 官網', '線上工具 網站', '雲端服務 官網'],
            transactional: ['雲端軟體 訂閱', 'SaaS平台 方案', '線上工具 價格', '雲端服務 費用']
        }
    };
    return templates[businessModel]?.[type] || [];
}

// 按出價策略分類關鍵字
function categorizeKeywordsByBiddingStrategy(keywords, brand, industry) {
    const categorized = {
        highSearchHighCompetition: [],
        highSearchLowCompetition: [],
        lowSearchHighCompetition: [],
        lowSearchLowCompetition: []
    };
    Object.values(keywords).flat().forEach(keyword => {
        const strategy = determineBiddingStrategy(keyword, brand, industry);
        categorized[strategy].push(keyword);
    });
    return categorized;
}

// 判斷關鍵字的出價策略
function determineBiddingStrategy(keyword, brand, industry) {
    if (keyword.includes(brand) || keyword.includes(industry) || keyword.length <= 8) {
        return 'highSearchHighCompetition';
    }
    if (keyword.includes('評價') || keyword.includes('比較') || keyword.includes('推薦')) {
        return 'highSearchLowCompetition';
    }
    if (keyword.includes('購買') || keyword.includes('價格') || keyword.includes('優惠')) {
        return 'lowSearchHighCompetition';
    }
    return 'lowSearchLowCompetition';
}

// 生成競爭對手分析
function generateCompetitorAnalysis(brand, industry) {
    return [
        { name: `${industry}競爭對手A`, marketShare: 18, strength: 85, website: `https://www.${industry}competitorA.com` },
        { name: `${industry}競爭對手B`, marketShare: 15, strength: 78, website: `https://www.${industry}competitorB.com` },
        { name: `${industry}競爭對手C`, marketShare: 12, strength: 72, website: `https://www.${industry}competitorC.com` },
        { name: `${industry}競爭對手D`, marketShare: 10, strength: 68, website: `https://www.${industry}competitorD.com` },
        { name: `${industry}競爭對手E`, marketShare: 8, strength: 65, website: `https://www.${industry}competitorE.com` }
    ];
}

// 生成趨勢分析
function generateTrendAnalysis(brand, industry, businessModel) {
    return [
        { keyword: `${brand}`, trend: 'hot', frequency: 8, growth: '+25%' },
        { keyword: `${industry}`, trend: 'rising', frequency: 6, growth: '+15%' },
        { keyword: `${businessModel}`, trend: 'new', frequency: 4, growth: '+30%' },
        { keyword: `${brand} ${industry}`, trend: 'hot', frequency: 5, growth: '+20%' },
        { keyword: `${industry} 評價`, trend: 'rising', frequency: 3, growth: '+10%' }
    ];
}

// 生成AI洞察
function generateAIInsights(brand, industry, businessModel, keywords) {
    const totalKeywords = Object.values(keywords).flat().length;
    return [
        `${brand} 在 ${industry} 領域具有強勁的市場潛力`,
        `建議專注於 ${businessModel} 模式的差異化關鍵字策略`,
        `已識別 ${totalKeywords} 個高價值關鍵字機會`,
        `競爭對手分析顯示市場集中度適中，有機會突破`,
        `長尾關鍵字覆蓋率達到 60%，建議進一步擴展`,
        `發現多個低競爭高轉換的關鍵字機會`
    ];
}

// 生成策略建議
function generateStrategyRecommendations(keywords, categorizedKeywords) {
    const recommendations = [];
    if (categorizedKeywords.highSearchHighCompetition.length > 0) {
        recommendations.push('高搜尋量高競爭關鍵字：建議採用精準出價策略，專注於品牌知名度和主要流量');
    }
    if (categorizedKeywords.highSearchLowCompetition.length > 0) {
        recommendations.push('高搜尋量低競爭關鍵字：建議積極出價，這些是性價比最高的關鍵字');
    }
    if (categorizedKeywords.lowSearchHighCompetition.length > 0) {
        recommendations.push('低搜尋量高競爭關鍵字：建議謹慎出價，專注於轉換率而非流量');
    }
    if (categorizedKeywords.lowSearchLowCompetition.length > 0) {
        recommendations.push('低搜尋量低競爭關鍵字：建議採用廣泛匹配，降低出價成本');
    }
    recommendations.push('建議定期監控關鍵字表現，根據數據調整出價策略');
    recommendations.push('考慮季節性因素，在旺季提高高轉換關鍵字的出價');
    return recommendations;
}

// 生成完整關鍵字建議書內容
function generateCompleteKeywordSuggestionsContent(analysis, businessModel, selectedTypes) {
    const brand = state.analysisData.brand?.name || '未指定';
    const topic = state.analysisData.topic || '未指定';
    const industry = state.analysisData.industry?.category || '未指定';
    let content = `完整關鍵字建議書 (${analysis.totalKeywords}組關鍵字)\n`;
    content += `==========================================\n\n`;
    content += `品牌名稱: ${brand}\n`;
    content += `分析主題: ${topic}\n`;
    content += `所屬產業: ${industry}\n`;
    content += `商業模式: ${businessModel}\n`;
    content += `生成時間: ${new Date().toLocaleString('zh-TW')}\n`;
    content += `生成方式: 完整關鍵字清單產生器 + 出價策略分類\n\n`;
    content += `關鍵字類型: ${selectedTypes.map(type => getTypeDisplayName(type)).join(', ')}\n`;
    content += `總關鍵字數量: ${analysis.totalKeywords}組\n\n`;
    // 出價策略分類
    content += `=== 出價策略分類 ===\n\n`;
    Object.entries(analysis.categorizedKeywords).forEach(([strategy, keywords]) => {
        const strategyName = analysis.biddingStrategies[strategy];
        content += `${strategyName} (${keywords.length}組):\n`;
        keywords.forEach(keyword => {
            content += `  • ${keyword}\n`;
        });
        content += `\n`;
    });
    // 按類型顯示關鍵字
    content += `=== 按類型分類 ===\n\n`;
    selectedTypes.forEach(type => {
        if (analysis.keywords[type] && analysis.keywords[type].length > 0) {
            content += `${getTypeDisplayName(type)} (${analysis.keywords[type].length}組):\n`;
            analysis.keywords[type].forEach(keyword => {
                content += `  • ${keyword}\n`;
            });
            content += `\n`;
        }
    });
    // 競爭對手分析
    if (analysis.competitors && analysis.competitors.length > 0) {
        content += `=== 競爭對手分析 ===\n\n`;
        analysis.competitors.forEach(comp => {
            content += `• ${comp.name}\n`;
            content += `  市場份額: ${comp.marketShare}%\n`;
            content += `  競爭力: ${comp.strength}%\n`;
            content += `  網站: ${comp.website}\n\n`;
        });
    }
    // 趨勢分析
    if (analysis.trends && analysis.trends.length > 0) {
        content += `=== 熱門趨勢分析 ===\n\n`;
        analysis.trends.forEach(trend => {
            const trendText = trend.trend === 'hot' ? '熱門' : trend.trend === 'rising' ? '上升' : '新興';
            content += `• ${trend.keyword} (${trendText}, 成長率: ${trend.growth})\n`;
        });
        content += `\n`;
    }
    // AI洞察
    if (analysis.insights && analysis.insights.length > 0) {
        content += `=== AI 分析洞察 ===\n\n`;
        analysis.insights.forEach(insight => {
            content += `• ${insight}\n`;
        });
        content += `\n`;
    }
    // 策略建議
    if (analysis.recommendations && analysis.recommendations.length > 0) {
        content += `=== 出價策略建議 ===\n\n`;
        analysis.recommendations.forEach(recommendation => {
            content += `• ${recommendation}\n`;
        });
        content += `\n`;
    }
    // SEO分類規則
    content += `=== SEO 分類規則 ===\n\n`;
    content += `1. 主要關鍵字 (Primary): 品牌名稱、核心產品、主要服務\n`;
    content += `   - 用途: 品牌知名度和主要流量\n`;
    content += `   - 建議: 高出價，精準匹配\n\n`;
    content += `2. 長尾關鍵字 (Long-tail): 包含3-4個詞的特定查詢\n`;
    content += `   - 用途: 精準轉換和降低競爭成本\n`;
    content += `   - 建議: 中等出價，廣泛匹配\n\n`;
    content += `3. 商業意圖 (Commercial): 包含購買、價格、優惠等詞彙\n`;
    content += `   - 用途: 針對有購買意圖的用戶\n`;
    content += `   - 建議: 高轉換率，可提高出價\n\n`;
    content += `4. 資訊查詢 (Informational): 包含介紹、說明、指南等詞彙\n`;
    content += `   - 用途: 建立專業形象和信任度\n`;
    content += `   - 建議: 中等出價，用於內容行銷\n\n`;
    content += `5. 導航查詢 (Navigational): 包含官網、網站等詞彙\n`;
    content += `   - 用途: 針對尋找特定品牌的用戶\n`;
    content += `   - 建議: 低出價，防禦性策略\n\n`;
    content += `6. 交易意圖 (Transactional): 包含購買、下單、訂購等詞彙\n`;
    content += `   - 用途: 直接促進轉換和銷售\n`;
    content += `   - 建議: 最高出價，精準匹配\n\n`;
    // 使用建議
    content += `=== 使用建議 ===\n\n`;
    content += `1. 出價策略:\n`;
    content += `   • 高搜尋量高競爭: 精準出價，專注品牌知名度\n`;
    content += `   • 高搜尋量低競爭: 積極出價，性價比最高\n`;
    content += `   • 低搜尋量高競爭: 謹慎出價，專注轉換率\n`;
    content += `   • 低搜尋量低競爭: 廣泛匹配，降低成本\n\n`;
    content += `2. 監控建議:\n`;
    content += `   • 每週監控關鍵字表現和轉換率\n`;
    content += `   • 根據季節性調整出價策略\n`;
    content += `   • 定期分析競爭對手關鍵字變化\n`;
    content += `   • 優化著陸頁面以提升轉換率\n\n`;
    content += `3. 優化建議:\n`;
    content += `   • 使用負面關鍵字排除不相關查詢\n`;
    content += `   • 根據地理位置調整出價\n`;
    content += `   • 利用時段出價優化成本效益\n`;
    content += `   • 定期更新關鍵字清單以跟上趨勢\n\n`;
    content += `=== 報告統計 ===\n\n`;
    content += `總關鍵字數量: ${analysis.totalKeywords}組\n`;
    content += `關鍵字類型: ${selectedTypes.length}種\n`;
    content += `出價策略分類: 4種\n`;
    content += `競爭對手分析: ${analysis.competitors.length}家\n`;
    content += `趨勢分析: ${analysis.trends.length}個熱門趨勢\n`;
    content += `AI洞察: ${analysis.insights.length}項\n`;
    content += `策略建議: ${analysis.recommendations.length}項\n\n`;
    content += `報告生成完成時間: ${new Date().toLocaleString('zh-TW')}\n`;
    content += `建議定期更新關鍵字策略以保持競爭優勢\n`;
    return content;
}
// 輔助：取得類型顯示名稱
function getTypeDisplayName(type) {
    const names = {
        primary: '主要關鍵字',
        longtail: '長尾關鍵字',
        commercial: '商業意圖關鍵字',
        informational: '資訊查詢關鍵字',
        navigational: '導航查詢關鍵字',
        transactional: '交易意圖關鍵字'
    };
    return names[type] || type;
} 
        // 編輯競爭對手
        function editCompetitor(competitorId) {
            try {
                const competitor = state.analysisData.selectedCompetitors.find(c => c.id === competitorId);
                if (!competitor) {
                    showAlert('找不到競爭對手', '無法編輯該競爭對手', 'error');
                    return;
                }

                // 創建編輯對話框
                const editDialog = document.createElement('div');
                editDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                editDialog.innerHTML = `
                    <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
                        <h3 class="text-lg font-semibold text-gray-200 mb-4">編輯競爭對手</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">競爭對手名稱</label>
                                <input type="text" id="edit-competitor-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.name}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">網站</label>
                                <input type="text" id="edit-competitor-website" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.website || ''}">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">市場份額 (%)</label>
                                <input type="number" id="edit-competitor-marketshare" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" value="${competitor.marketShare}" min="0" max="100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">描述</label>
                                <textarea id="edit-competitor-description" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3">${competitor.description || ''}</textarea>
                            </div>
                        </div>
                        <div class="flex justify-end gap-3 mt-6">
                            <button onclick="closeEditDialog()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">取消</button>
                            <button onclick="saveCompetitorEdit('${competitorId}')" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">儲存</button>
                        </div>
                    </div>
                `;

                document.body.appendChild(editDialog);
                
            } catch (error) {
                console.error('編輯競爭對手失敗:', error);
                showAlert('編輯失敗', '無法編輯競爭對手', 'error');
            }
        }

        // 儲存競爭對手編輯
        function saveCompetitorEdit(competitorId) {
            try {
                const competitor = state.analysisData.selectedCompetitors.find(c => c.id === competitorId);
                if (!competitor) {
                    showAlert('找不到競爭對手', '無法儲存編輯', 'error');
                    return;
                }

                const name = document.getElementById('edit-competitor-name')?.value?.trim();
                const website = document.getElementById('edit-competitor-website')?.value?.trim();
                const marketShare = parseInt(document.getElementById('edit-competitor-marketshare')?.value) || 10;
                const description = document.getElementById('edit-competitor-description')?.value?.trim();

                if (!name) {
                    showAlert('請輸入競爭對手名稱', '名稱不能為空', 'warning');
                    return;
                }

                // 更新競爭對手資料
                competitor.name = name;
                competitor.website = website || `https://www.google.com/search?q=${encodeURIComponent(name)}`;
                competitor.marketShare = marketShare;
                competitor.description = description || `${name} - 競爭對手`;

                // 關閉對話框
                closeEditDialog();

                // 更新顯示
                updateSelectedCompetitorsDisplay();

                showAlert('儲存成功', '競爭對手資料已更新', 'success');
                
            } catch (error) {
                console.error('儲存競爭對手編輯失敗:', error);
                showAlert('儲存失敗', '無法儲存編輯', 'error');
            }
        }

        // 關閉編輯對話框
        function closeEditDialog() {
            const dialog = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (dialog) {
                dialog.remove();
            }
        }

        // Google Search API 智能查詢功能
        async function performGoogleSearch(query, maxResults = 10) {
            try {
                const apiKey = document.getElementById('google-api-key')?.value?.trim();
                const searchEngineId = document.getElementById('search-engine-id')?.value?.trim();
                
                if (!apiKey || !searchEngineId) {
                    throw new Error('請先設定 Google API Key 和 Search Engine ID');
                }

                const url = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${searchEngineId}&q=${encodeURIComponent(query)}&num=${maxResults}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Google Search API 詳細錯誤:', {
                        status: response.status,
                        statusText: response.statusText,
                        url: url,
                        errorText: errorText
                    });
                    
                    if (response.status === 403) {
                        throw new Error('Google Search API 權限錯誤 (403)。請檢查：1) API 金鑰是否已啟用 Custom Search API 2) 搜尋引擎 ID 是否正確 3) API 配額是否已用完');
                    } else if (response.status === 429) {
                        throw new Error('Google Search API 配額已用完 (429)。請稍後再試或升級 API 配額');
                    } else {
                        throw new Error(`Google Search API 錯誤 (${response.status}): ${response.statusText}`);
                    }
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`Google Search API 錯誤: ${data.error.message}`);
                }
                
                return data.items || [];
                
            } catch (error) {
                console.error('Google Search 失敗:', error);
                
                // 如果是 API 設定問題，提供回退方案
                if (error.message.includes('權限錯誤') || error.message.includes('配額已用完')) {
                    console.log('使用靜態資料作為回退方案');
                    return generateStaticSearchResults(query, maxResults);
                }
                
                throw error;
            }
        }

        // 生成靜態搜尋結果作為回退方案
        function generateStaticSearchResults(query, maxResults) {
            const staticResults = [];
            const queryLower = query.toLowerCase();
            
            // 根據查詢內容生成相關的靜態結果
            const templates = [
                {
                    title: `${query} - 專業解決方案`,
                    snippet: `提供專業的 ${query} 服務，幫助企業提升效率和競爭力。我們擁有豐富的經驗和專業團隊。`,
                    link: `https://example.com/${encodeURIComponent(query)}`
                },
                {
                    title: `${query} 最佳實踐指南`,
                    snippet: `探索 ${query} 的最佳實踐和成功案例。了解如何有效實施和管理 ${query} 策略。`,
                    link: `https://example.com/guide/${encodeURIComponent(query)}`
                },
                {
                    title: `${query} 市場分析報告`,
                    snippet: `深入分析 ${query} 市場趨勢、競爭格局和發展前景。為您的決策提供數據支持。`,
                    link: `https://example.com/analysis/${encodeURIComponent(query)}`
                },
                {
                    title: `${query} 技術創新`,
                    snippet: `最新的 ${query} 技術創新和發展動態。了解前沿技術如何改變 ${query} 領域。`,
                    link: `https://example.com/innovation/${encodeURIComponent(query)}`
                },
                {
                    title: `${query} 行業專家觀點`,
                    snippet: `聽取 ${query} 領域專家的見解和建議。獲得專業的指導和實用的建議。`,
                    link: `https://example.com/expert/${encodeURIComponent(query)}`
                }
            ];
            
            // 根據查詢內容調整結果
            for (let i = 0; i < Math.min(maxResults, templates.length); i++) {
                const template = templates[i];
                staticResults.push({
                    title: template.title,
                    snippet: template.snippet,
                    link: template.link
                });
            }
            
            return staticResults;
        }

        // AI 智能分析搜尋結果
        async function analyzeSearchResultsWithAI(searchResults, brand, industry, businessModel) {
            try {
                // 提取搜尋結果中的關鍵資訊
                const extractedData = extractSearchData(searchResults);
                
                // 使用 AI 分析搜尋結果
                const analysis = await performAIAnalysis(extractedData, brand, industry, businessModel);
                
                return analysis;
                
            } catch (error) {
                console.error('AI 分析失敗:', error);
                throw error;
            }
        }

        // 提取搜尋結果資料
        function extractSearchData(searchResults) {
            const extracted = {
                titles: [],
                snippets: [],
                urls: [],
                keywords: new Set(),
                competitors: new Set(),
                trends: []
            };

            searchResults.forEach(item => {
                if (item.title) {
                    extracted.titles.push(item.title);
                    // 提取標題中的關鍵字
                    const titleKeywords = extractKeywords(item.title);
                    titleKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.snippet) {
                    extracted.snippets.push(item.snippet);
                    // 提取摘要中的關鍵字
                    const snippetKeywords = extractKeywords(item.snippet);
                    snippetKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.link) {
                    extracted.urls.push(item.link);
                    // 從 URL 提取競爭對手
                    const competitor = extractCompetitorFromURL(item.link);
                    if (competitor) {
                        extracted.competitors.add(competitor);
                    }
                }
            });

            return {
                titles: extracted.titles,
                snippets: extracted.snippets,
                urls: extracted.urls,
                keywords: Array.from(extracted.keywords),
                competitors: Array.from(extracted.competitors),
                trends: analyzeTrends(extracted.titles, extracted.snippets)
            };
        }

        // 提取關鍵字
        function extractKeywords(text) {
            if (!text) return [];
            
            // 移除 HTML 標籤
            const cleanText = text.replace(/<[^>]*>/g, '');
            
            // 分割成詞彙
            const words = cleanText.toLowerCase()
                .replace(/[^\w\s\u4e00-\u9fff]/g, ' ')
                .split(/\s+/)
                .filter(word => word.length > 1);
            
            // 過濾常見停用詞
            const stopWords = ['的', '是', '在', '有', '和', '與', '或', '但', '而', 'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by'];
            const filteredWords = words.filter(word => !stopWords.includes(word));
            
            // 統計詞頻
            const wordCount = {};
            filteredWords.forEach(word => {
                wordCount[word] = (wordCount[word] || 0) + 1;
            });
            
            // 返回頻率最高的關鍵字
            return Object.entries(wordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20)
                .map(([word]) => word);
        }

        // 從 URL 提取競爭對手
        function extractCompetitorFromURL(url) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname.toLowerCase();
                
                // 移除常見的域名後綴
                const domain = hostname.replace(/^www\./, '').split('.')[0];
                
                // 過濾掉常見的網站
                const commonSites = ['google', 'facebook', 'youtube', 'twitter', 'linkedin', 'amazon', 'yahoo', 'bing'];
                if (commonSites.includes(domain)) {
                    return null;
                }
                
                return domain;
            } catch (error) {
                return null;
            }
        }

        // 分析趨勢
        function analyzeTrends(titles, snippets) {
            const allText = [...titles, ...snippets].join(' ');
            const keywords = extractKeywords(allText);
            
            // 分析熱門話題和趨勢
            const trends = [];
            const keywordCount = {};
            
            keywords.forEach(keyword => {
                keywordCount[keyword] = (keywordCount[keyword] || 0) + 1;
            });
            
            // 返回最熱門的趨勢
            return Object.entries(keywordCount)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([keyword, count]) => ({
                    keyword,
                    frequency: count,
                    trend: count > 3 ? 'hot' : count > 1 ? 'rising' : 'new'
                }));
        }

        // AI 分析搜尋結果
        async function performAIAnalysis(extractedData, brand, industry, businessModel) {
            try {
                // 這裡可以整合 OpenAI API 或其他 AI 服務
                // 目前使用智能算法分析
                const analysis = {
                    keywords: generateSmartKeywords(extractedData, brand, industry, businessModel),
                    competitors: analyzeCompetitors(extractedData.competitors, brand),
                    trends: extractedData.trends,
                    insights: generateInsights(extractedData, brand, industry, businessModel),
                    recommendations: generateRecommendations(extractedData, brand, industry, businessModel)
                };
                
                return analysis;
                
            } catch (error) {
                console.error('AI 分析執行失敗:', error);
                throw error;
            }
        }

        // 生成智能關鍵字
        function generateSmartKeywords(extractedData, brand, industry, businessModel) {
            const keywords = {
                primary: [],
                longtail: [],
                commercial: [],
                informational: [],
                navigational: [],
                transactional: []
            };
            
            // 從搜尋結果中提取的關鍵字
            const searchKeywords = extractedData.keywords;
            const brandKeywords = brand ? [brand.toLowerCase()] : [];
            const industryKeywords = getIndustryKeywords(industry).primary || [];
            
            // 主要關鍵字
            keywords.primary = [
                ...brandKeywords,
                ...industryKeywords.slice(0, 3),
                ...searchKeywords.slice(0, 5)
            ].filter((v, i, a) => a.indexOf(v) === i);
            
            // 長尾關鍵字
            keywords.longtail = searchKeywords
                .filter(k => k.length > 3)
                .slice(0, 10)
                .map(k => `${brand} ${k}`.trim());
            
            // 商業意圖關鍵字
            keywords.commercial = [
                `購買 ${brand}`,
                `${brand} 價格`,
                `${brand} 優惠`,
                `${brand} 折扣`,
                `${brand} 促銷`
            ];
            
            // 資訊查詢關鍵字
            keywords.informational = [
                `${brand} 介紹`,
                `${brand} 評價`,
                `${brand} 比較`,
                `${brand} 推薦`,
                `${brand} 指南`
            ];
            
            // 導航查詢關鍵字
            keywords.navigational = [
                `${brand} 官網`,
                `${brand} 官方網站`,
                `${brand} 官網`,
                `${brand} 網站`
            ];
            
            // 交易意圖關鍵字
            keywords.transactional = [
                `${brand} 購買`,
                `${brand} 下單`,
                `${brand} 訂購`,
                `${brand} 立即購買`,
                `${brand} 馬上購買`
            ];
            
            return keywords;
        }

        // 分析競爭對手
        function analyzeCompetitors(competitors, brand) {
            return competitors
                .filter(comp => comp !== brand?.toLowerCase())
                .map(comp => ({
                    name: comp,
                    website: `https://www.${comp}.com`,
                    description: `${comp} - 競爭對手`,
                    marketShare: Math.floor(Math.random() * 20) + 5,
                    strength: Math.floor(Math.random() * 60) + 40
                }));
        }

        // 生成洞察
        function generateInsights(extractedData, brand, industry, businessModel) {
            const insights = [];
            
            // 基於搜尋結果生成洞察
            if (extractedData.trends.length > 0) {
                insights.push(`熱門趨勢: ${extractedData.trends[0].keyword} 是當前最熱門的關鍵字`);
            }
            
            if (extractedData.competitors.length > 0) {
                insights.push(`發現 ${extractedData.competitors.length} 個潛在競爭對手`);
            }
            
            if (extractedData.keywords.length > 0) {
                insights.push(`識別出 ${extractedData.keywords.length} 個相關關鍵字`);
            }
            
            return insights;
        }

        // 生成建議
        function generateRecommendations(extractedData, brand, industry, businessModel) {
            const recommendations = [];
            
            // 基於分析結果生成建議
            if (extractedData.trends.some(t => t.trend === 'hot')) {
                recommendations.push('建議關注熱門趨勢關鍵字，提升品牌曝光度');
            }
            
            if (extractedData.competitors.length > 5) {
                recommendations.push('競爭激烈，建議專注於差異化定位');
            }
            
            if (extractedData.keywords.length < 10) {
                recommendations.push('關鍵字覆蓋不足，建議擴展長尾關鍵字策略');
            }
            
            return recommendations;
        }

        // 智能關鍵字搜尋
        async function performSmartKeywordSearch(brand, industry, businessModel) {
            try {
                showAlert('搜尋中', '正在使用 Google Search API 進行智能關鍵字搜尋...', 'info');
                
                // 構建搜尋查詢
                const searchQueries = [
                    `${brand} ${industry}`,
                    `${brand} 評價`,
                    `${brand} 比較`,
                    `${industry} 品牌`,
                    `${businessModel} ${industry}`
                ];
                
                const allResults = [];
                
                // 執行多個搜尋查詢
                for (const query of searchQueries) {
                    try {
                        const results = await performGoogleSearch(query, 5);
                        allResults.push(...results);
                    } catch (error) {
                        console.error(`搜尋查詢 "${query}" 失敗:`, error);
                    }
                }
                
                // AI 分析搜尋結果
                const analysis = await analyzeSearchResultsWithAI(allResults, brand, industry, businessModel);
                
                return analysis;
                
            } catch (error) {
                console.error('智能關鍵字搜尋失敗:', error);
                throw error;
            }
        }

        // 智能文案生成
        async function performSmartCopyGeneration(brand, industry, businessModel, targetAudience, copyStyle) {
            try {
                showAlert('生成中', '正在使用 AI 智能生成廣告文案...', 'info');
                
                // 搜尋相關內容
                const searchQueries = [
                    `${brand} 廣告`,
                    `${industry} 行銷`,
                    `${businessModel} 文案`,
                    `${targetAudience} ${industry}`
                ];
                
                const allResults = [];
                
                for (const query of searchQueries) {
                    try {
                        const results = await performGoogleSearch(query, 3);
                        allResults.push(...results);
                    } catch (error) {
                        console.error(`文案搜尋查詢 "${query}" 失敗:`, error);
                    }
                }
                
                // 分析並生成文案
                const analysis = await analyzeSearchResultsWithAI(allResults, brand, industry, businessModel);
                const copyTemplates = generateSmartCopyTemplates(analysis, brand, industry, businessModel, targetAudience, copyStyle);
                
                return copyTemplates;
                
            } catch (error) {
                console.error('智能文案生成失敗:', error);
                throw error;
            }
        }

        // 生成智能文案模板
        function generateSmartCopyTemplates(analysis, brand, industry, businessModel, targetAudience, copyStyle) {
            const templates = {
                headlines: [],
                descriptions: [],
                cta: []
            };
            
            // 基於分析結果生成標題
            if (analysis.trends.length > 0) {
                const hotTrend = analysis.trends[0];
                templates.headlines.push(`${brand} ${hotTrend.keyword} - 領先${industry}趨勢`);
            }
            
            // 基於競爭對手分析生成標題
            if (analysis.competitors.length > 0) {
                templates.headlines.push(`${brand} - 超越${analysis.competitors[0].name}的選擇`);
            }
            
            // 基於關鍵字生成標題
            if (analysis.keywords.primary.length > 0) {
                templates.headlines.push(`${brand} ${analysis.keywords.primary[0]} - ${industry}專家`);
            }
            
            // 生成描述
            const insights = analysis.insights.join('。');
            templates.descriptions.push(`${brand}提供專業${industry}服務，${insights}。立即體驗，品質保證！`);
            
            // 生成行動呼籲
            templates.cta = ['立即諮詢', '免費體驗', '了解更多', '立即購買'];
            
            return templates;
        }

        // 智能搜尋關鍵字
        async function performSmartSearch() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                
                if (!businessModel) {
                    showAlert('請選擇商業模式', '商業模式是智能搜尋的必要條件', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || '未指定';
                const industry = state.analysisData.industry?.category || '未指定';

                showAlert('智能搜尋中', '正在使用 Google Search API 和 AI 分析進行智能關鍵字搜尋...', 'info');

                try {
                    // 使用智能關鍵字搜尋
                    const smartAnalysis = await performSmartKeywordSearch(brand, industry, businessModel);
                    
                    // 更新關鍵字顯示
                    updateKeywordDisplay(smartAnalysis);
                    
                    // 儲存智能分析結果
                    state.analysisData.smartKeywordAnalysis = smartAnalysis;
                    
                    showAlert('智能搜尋完成', '已使用 Google Search API 和 AI 分析完成關鍵字搜尋', 'success');
                    
                } catch (error) {
                    console.error('智能搜尋失敗:', error);
                    
                    // 檢查是否是 API 設定問題
                    if (error.message.includes('權限錯誤') || error.message.includes('配額已用完')) {
                        showAlert('API 設定問題', 'Google Search API 設定有問題，已使用靜態資料作為回退方案。請檢查 API 設定或稍後再試。', 'warning');
                        
                        // 使用靜態資料作為回退方案
                        const fallbackAnalysis = generateFallbackAnalysis(brand, industry, businessModel);
                        updateKeywordDisplay(fallbackAnalysis);
                        state.analysisData.smartKeywordAnalysis = fallbackAnalysis;
                        
                    } else {
                        showAlert('搜尋失敗', `智能搜尋失敗: ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                console.error('智能搜尋執行失敗:', error);
                showAlert('執行失敗', '智能搜尋功能執行失敗，請重試', 'error');
            }
        }

        // 生成回退分析資料
        function generateFallbackAnalysis(brand, industry, businessModel) {
            return {
                keywords: {
                    primary: [`${brand}`, `${brand} ${industry}`, `${industry} ${brand}`, `${brand} 評價`, `${brand} 推薦`],
                    longtail: [`${brand} ${industry} 評價`, `${industry} ${brand} 比較`, `${brand} ${industry} 推薦`, `${brand} 服務`, `${brand} 解決方案`],
                    commercial: [`購買 ${brand}`, `${brand} 訂購`, `${brand} ${industry} 服務`, `${brand} 報價`, `${brand} 諮詢`],
                    informational: [`${brand} 介紹`, `${brand} ${industry} 說明`, `${brand} 指南`, `${brand} 教學`, `${brand} 特色`],
                    navigational: [`${brand} 官網`, `${brand} 官方網站`, `${brand} 網站`, `${brand} 首頁`],
                    transactional: [`${brand} 購買`, `${brand} 下單`, `${brand} 訂購`, `${brand} 立即購買`, `${brand} 馬上購買`]
                },
                competitors: [
                    { name: `${industry}競爭對手1`, marketShare: 15, strength: 75 },
                    { name: `${industry}競爭對手2`, marketShare: 12, strength: 68 },
                    { name: `${industry}競爭對手3`, marketShare: 10, strength: 72 }
                ],
                trends: [
                    { keyword: `${brand}`, trend: 'hot', frequency: 5 },
                    { keyword: `${industry}`, trend: 'rising', frequency: 3 },
                    { keyword: `${businessModel}`, trend: 'new', frequency: 2 }
                ],
                insights: [
                    `${brand} 在 ${industry} 領域具有潛力`,
                    `建議專注於 ${businessModel} 模式的關鍵字策略`,
                    `發現多個相關競爭對手，需要差異化定位`
                ],
                recommendations: [
                    '建議優化主要關鍵字以提高品牌知名度',
                    '擴展長尾關鍵字以降低競爭成本',
                    '關注熱門趨勢關鍵字以提升曝光度'
                ]
            };
        }

        // 更新關鍵字顯示
        function updateKeywordDisplay(analysis) {
            try {
                // 更新主要關鍵字
                const primaryKeywordsTextarea = document.getElementById('primary-keywords-step3');
                if (primaryKeywordsTextarea && analysis.keywords.primary) {
                    primaryKeywordsTextarea.value = analysis.keywords.primary.join('\n');
                }
                
                // 更新長尾關鍵字
                const longTailKeywordsTextarea = document.getElementById('long-tail-keywords-step3');
                if (longTailKeywordsTextarea && analysis.keywords.longtail) {
                    longTailKeywordsTextarea.value = analysis.keywords.longtail.join('\n');
                }
                
                // 更新文案預覽區域
                const previewArea = document.getElementById('ads-copy-preview');
                if (previewArea) {
                    let previewContent = '<h4 class="font-semibold text-gray-200 mb-3">智能搜尋結果</h4>';
                    
                    if (analysis.insights && analysis.insights.length > 0) {
                        previewContent += '<div class="mb-3"><h5 class="text-gray-300 mb-2">AI 洞察:</h5>';
                        analysis.insights.forEach(insight => {
                            previewContent += `<p class="text-gray-400 text-sm">• ${insight}</p>`;
                        });
                        previewContent += '</div>';
                    }
                    
                    if (analysis.recommendations && analysis.recommendations.length > 0) {
                        previewContent += '<div class="mb-3"><h5 class="text-gray-300 mb-2">建議:</h5>';
                        analysis.recommendations.forEach(rec => {
                            previewContent += `<p class="text-gray-400 text-sm">• ${rec}</p>`;
                        });
                        previewContent += '</div>';
                    }
                    
                    previewContent += '<p class="text-gray-400 text-sm mt-3">💡 關鍵字已更新，請使用上方的文案生成功能</p>';
                    
                    previewArea.innerHTML = previewContent;
                }
                
            } catch (error) {
                console.error('更新關鍵字顯示失敗:', error);
            }
        }

        // Gemini API 智能分析功能
        async function callGeminiAPI(prompt, isJsonMode = false) {
            try {
                const apiKey = document.getElementById('gemini-api-key')?.value?.trim();
                
                if (!apiKey) {
                    throw new Error('請先設定 Gemini API Key');
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 2048
                    }
                };

                if (isJsonMode) {
                    requestBody.generationConfig.temperature = 0.1;
                }

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API 錯誤: ${response.status}`);
                }

                const data = await response.json();
                const generatedText = data.candidates[0].content.parts[0].text;
                
                if (isJsonMode) {
                    try {
                        // 清理 JSON 回應，移除 markdown 代碼塊標記
                        const cleanedText = cleanJsonResponse(generatedText);
                        console.log('清理後的 JSON 文字:', cleanedText);
                        return JSON.parse(cleanedText);
                    } catch (parseError) {
                        console.error('JSON 解析失敗:', parseError);
                        console.error('原始回應:', generatedText);
                        throw new Error('AI 回應格式錯誤');
                    }
                }
                
                return generatedText;
                
            } catch (error) {
                console.error('Gemini API 調用失敗:', error);
                throw error;
            }
        }

        // 清理 JSON 回應
        function cleanJsonResponse(text) {
            if (!text) return '{}';
            
            let cleaned = text.trim();
            
            // 移除 markdown 代碼塊標記
            cleaned = cleaned.replace(/```json\s*/gi, '');
            cleaned = cleaned.replace(/```\s*$/gi, '');
            cleaned = cleaned.replace(/^```\s*/gi, '');
            
            // 移除可能的 markdown 標記
            cleaned = cleaned.replace(/^#+\s*/gm, '');
            cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '$1');
            cleaned = cleaned.replace(/\*(.*?)\*/g, '$1');
            
            // 移除多餘的空白和換行
            cleaned = cleaned.replace(/\n\s*\n/g, '\n');
            cleaned = cleaned.trim();
            
            // 確保以 { 開始，以 } 結束
            const startBrace = cleaned.indexOf('{');
            const endBrace = cleaned.lastIndexOf('}');
            
            if (startBrace !== -1 && endBrace !== -1 && endBrace > startBrace) {
                cleaned = cleaned.substring(startBrace, endBrace + 1);
            }
            
            return cleaned;
        }

        // 智能競爭對手分析
        async function performSmartCompetitorAnalysis(brand, industry, products, topic) {
            try {
                showAlert('分析中', '正在使用 Google Search API 和 Gemini AI 進行智能競爭對手分析...', 'info');
                
                // 構建搜尋查詢
                const searchQueries = [
                    `${brand} ${industry} 競爭對手`,
                    `${industry} 品牌 比較`,
                    `${topic} ${industry} 公司`,
                    `${industry} 領導品牌`,
                    `${brand} 同業競爭`
                ];
                
                const allSearchResults = [];
                
                // 執行多個搜尋查詢
                for (const query of searchQueries) {
                    try {
                        const results = await performGoogleSearch(query, 5);
                        allSearchResults.push(...results);
                    } catch (error) {
                        console.error(`搜尋查詢 "${query}" 失敗:`, error);
                    }
                }
                
                // 使用 Gemini AI 分析搜尋結果
                const smartAnalysis = await analyzeCompetitorsWithAI(allSearchResults, brand, industry, products, topic);
                
                return smartAnalysis;
                
            } catch (error) {
                console.error('智能競爭對手分析失敗:', error);
                throw error;
            }
        }

        // 使用 Gemini AI 分析競爭對手
        async function analyzeCompetitorsWithAI(searchResults, brand, industry, products, topic) {
            try {
                // 提取搜尋結果中的關鍵資訊
                const extractedData = extractCompetitorData(searchResults);
                
                // 構建 AI 分析提示
                const analysisPrompt = buildCompetitorAnalysisPrompt(extractedData, brand, industry, products, topic);
                
                // 調用 Gemini API 進行分析
                const aiAnalysis = await callGeminiAPI(analysisPrompt, true);
                
                return {
                    competitors: aiAnalysis.competitors || [],
                    marketInsights: aiAnalysis.marketInsights || [],
                    competitiveAdvantages: aiAnalysis.competitiveAdvantages || [],
                    threats: aiAnalysis.threats || [],
                    recommendations: aiAnalysis.recommendations || [],
                    searchData: extractedData
                };
                
            } catch (error) {
                console.error('AI 競爭對手分析失敗:', error);
                throw error;
            }
        }

        // 提取競爭對手資料
        function extractCompetitorData(searchResults) {
            const extracted = {
                companies: new Set(),
                websites: [],
                descriptions: [],
                keywords: new Set(),
                marketIndicators: []
            };

            searchResults.forEach(item => {
                if (item.title) {
                    // 提取公司名稱
                    const companyNames = extractCompanyNames(item.title);
                    companyNames.forEach(name => extracted.companies.add(name));
                    
                    // 提取關鍵字
                    const titleKeywords = extractKeywords(item.title);
                    titleKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.snippet) {
                    extracted.descriptions.push(item.snippet);
                    
                    // 提取關鍵字
                    const snippetKeywords = extractKeywords(item.snippet);
                    snippetKeywords.forEach(k => extracted.keywords.add(k));
                }
                
                if (item.link) {
                    extracted.websites.push(item.link);
                    
                    // 從 URL 提取公司資訊
                    const urlCompany = extractCompanyFromURL(item.link);
                    if (urlCompany) {
                        extracted.companies.add(urlCompany);
                    }
                }
            });

            return {
                companies: Array.from(extracted.companies),
                websites: extracted.websites,
                descriptions: extracted.descriptions,
                keywords: Array.from(extracted.keywords),
                marketIndicators: analyzeMarketIndicators(extracted.descriptions)
            };
        }

        // 提取公司名稱
        function extractCompanyNames(text) {
            if (!text) return [];
            
            // 移除 HTML 標籤
            const cleanText = text.replace(/<[^>]*>/g, '');
            
            // 常見的公司名稱模式
            const patterns = [
                /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:科技|科技公司|股份有限公司|有限公司|企業|集團|公司)/g,
                /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:Technology|Tech|Inc|Corp|Ltd|Company)/gi,
                /([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\s+(?:電子|資訊|軟體|網路|電商|金融|醫療|製造)/g
            ];
            
            const companies = new Set();
            
            patterns.forEach(pattern => {
                const matches = cleanText.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        const company = match.replace(/\s+(?:科技|科技公司|股份有限公司|有限公司|企業|集團|公司|Technology|Tech|Inc|Corp|Ltd|Company|電子|資訊|軟體|網路|電商|金融|醫療|製造)/gi, '').trim();
                        if (company.length > 1) {
                            companies.add(company);
                        }
                    });
                }
            });
            
            return Array.from(companies);
        }

        // 從 URL 提取公司資訊
        function extractCompanyFromURL(url) {
            try {
                const urlObj = new URL(url);
                const hostname = urlObj.hostname.toLowerCase();
                
                // 移除常見的域名後綴
                const domain = hostname.replace(/^www\./, '').split('.')[0];
                
                // 過濾掉常見的網站
                const commonSites = ['google', 'facebook', 'youtube', 'twitter', 'linkedin', 'amazon', 'yahoo', 'bing', 'wikipedia'];
                if (commonSites.includes(domain)) {
                    return null;
                }
                
                return domain;
            } catch (error) {
                return null;
            }
        }

        // 分析市場指標
        function analyzeMarketIndicators(descriptions) {
            const indicators = [];
            
            descriptions.forEach(desc => {
                // 分析市場份額相關詞彙
                if (desc.includes('市場份額') || desc.includes('市佔率') || desc.includes('market share')) {
                    indicators.push('market_share');
                }
                
                // 分析營收相關詞彙
                if (desc.includes('營收') || desc.includes('營業額') || desc.includes('revenue')) {
                    indicators.push('revenue');
                }
                
                // 分析成長相關詞彙
                if (desc.includes('成長') || desc.includes('增長') || desc.includes('growth')) {
                    indicators.push('growth');
                }
                
                // 分析創新相關詞彙
                if (desc.includes('創新') || desc.includes('技術') || desc.includes('innovation')) {
                    indicators.push('innovation');
                }
            });
            
            return [...new Set(indicators)];
        }

        // 構建競爭對手分析提示
        function buildCompetitorAnalysisPrompt(extractedData, brand, industry, products, topic) {
            const prompt = `你是一個專業的市場分析師，請基於以下搜尋結果資料，為品牌 "${brand}" 在 "${industry}" 行業進行智能競爭對手分析。

搜尋結果摘要：
- 發現的公司：${extractedData.companies.join(', ')}
- 相關網站：${extractedData.websites.length} 個
- 關鍵字：${extractedData.keywords.join(', ')}
- 市場指標：${extractedData.marketIndicators.join(', ')}
- 產品/服務：${products.map(p => p.name || p).join(', ')}

請以純 JSON 格式回傳分析結果，不要包含任何 markdown 標記、代碼塊或說明文字。直接返回有效的 JSON 物件：

{
  "competitors": [
    {
      "name": "競爭對手名稱",
      "website": "官方網站",
      "description": "公司描述",
      "marketShare": 15,
      "strength": 75,
      "weakness": 45,
      "opportunity": 60,
      "threat": 30,
      "productComparison": "與${brand}的產品比較分析",
      "competitivePosition": "競爭定位分析"
    }
  ],
  "marketInsights": [
    "市場洞察1",
    "市場洞察2"
  ],
  "competitiveAdvantages": [
    "${brand}的競爭優勢1",
    "${brand}的競爭優勢2"
  ],
  "threats": [
    "潛在威脅1",
    "潛在威脅2"
  ],
  "recommendations": [
    "策略建議1",
    "策略建議2"
  ]
}

重要：請確保回傳的是純 JSON 格式，不要包含 \`\`\`json 或其他 markdown 標記。`;

            return prompt;
        }

        // AI 智能分析搜尋結果
        async function performSmartKeywordSearch() {
            try {
                const businessModel = document.getElementById('business-model-select-step3')?.value;
                const keywordTypes = getSelectedKeywordTypes();
                const brand = state.analysisData.brand?.name || '';
                const industry = state.analysisData.industry?.category || '';
                const products = state.analysisData.products || [];

                if (!businessModel) {
                    showAlert('請選擇商業模式', '商業模式是智能關鍵字搜尋的必要參數', 'warning');
                    return;
                }

                showAlert('開始智能搜尋', '正在使用本地智能分析生成關鍵字建議...', 'info');
                
                // 使用 Google Search API 搜尋
                const searchResults = await performGoogleKeywordSearch(brand, industry, businessModel);
                
                // 使用 AI 分析生成智能建議
                // 使用本地智能關鍵字生成器
                const keywordSuggestions = generateKeywordSuggestions(brand, industry, businessModel, products);
                
                // 合併結果並分類
                const categorizedKeywords = categorizeKeywords(keywordSuggestions, keywordTypes);
                
                // 更新顯示
                updateKeywordDisplay(categorizedKeywords);
                
                showAlert('智能搜尋完成', `成功生成 ${categorizedKeywords.totalCount} 個關鍵字建議`, 'success');
                
            } catch (error) {
                console.error('智能關鍵字搜尋失敗:', error);
                showAlert('搜尋失敗', '請檢查 API 設定或稍後重試', 'error');
            }
        }
        
        // Google Search API 關鍵字搜尋
        async function performGoogleKeywordSearch(brand, industry, businessModel) {
            try {
                const apiKey = document.getElementById('google-api-key')?.value;
                const searchEngineId = document.getElementById('search-engine-id')?.value;
                
                if (!apiKey || !searchEngineId) {
                    console.log('Google API 未設定，使用回退方案');
                    return getFallbackSearchResults(brand, industry, businessModel);
                }
                
                const searchQueries = generateSearchQueries(brand, industry, businessModel);
                const results = [];
                
                for (const query of searchQueries) {
                    try {
                        const response = await fetch(`https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${searchEngineId}&q=${encodeURIComponent(query)}&num=10`);
                        
                        if (response.ok) {
                            const data = await response.json();
                            if (data.items) {
                                results.push(...data.items);
                            }
                        }
                    } catch (error) {
                        console.warn(`搜尋查詢 "${query}" 失敗:`, error);
                    }
                }
                
                return results;
                
            } catch (error) {
                console.error('Google Search API 搜尋失敗:', error);
                return getFallbackSearchResults(brand, industry, businessModel);
            }
        }
        
        // AI 智能關鍵字建議生成
        async function generateAIKeywordSuggestions(brand, industry, businessModel, products, searchResults) {
            try {
                const geminiApiKey = document.getElementById('gemini-api-key')?.value;
                
                if (!geminiApiKey) {
                    console.log('Gemini API 未設定，使用模板建議');
                    return generateTemplateKeywordSuggestions(brand, industry, businessModel, products);
                }
                
                const prompt = buildKeywordSuggestionPrompt(brand, industry, businessModel, products, searchResults);
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const result = data.candidates[0].content.parts[0].text;
                    
                    // 清理 JSON 格式
                    const cleanedResult = cleanJsonResponse(result);
                    return JSON.parse(cleanedResult);
                } else {
                    throw new Error(`Gemini API 回應錯誤: ${response.status}`);
                }
                
            } catch (error) {
                console.error('AI 關鍵字建議生成失敗:', error);
                return generateTemplateKeywordSuggestions(brand, industry, businessModel, products);
            }
        }
        
        // 構建關鍵字建議提示
        function buildKeywordSuggestionPrompt(brand, industry, businessModel, products, searchResults) {
            const productNames = products.map(p => p.name || p).join(', ');
            const searchTitles = searchResults.map(item => item.title).slice(0, 5).join(', ');
            
            return `你是一個專業的 SEO 和數位行銷專家，請為品牌 "${brand}" 在 "${industry}" 行業，採用 "${businessModel}" 商業模式，生成智能關鍵字建議。

產品/服務：${productNames}
搜尋結果參考：${searchTitles}

請以純 JSON 格式回傳，包含以下結構：

{
  "primaryKeywords": [
    {
      "keyword": "關鍵字",
      "searchVolume": "高/中/低",
      "competition": "高/中/低",
      "suggestedBid": "建議出價範圍",
      "seoCategory": "SEO分類",
      "intent": "搜尋意圖",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "longTailKeywords": [
    {
      "keyword": "長尾關鍵字",
      "searchVolume": "高/中/低",
      "competition": "高/中/低",
      "suggestedBid": "建議出價範圍",
      "seoCategory": "SEO分類",
      "intent": "搜尋意圖",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "commercialKeywords": [
    {
      "keyword": "商業意圖關鍵字",
      "searchVolume": "高/中/低",
      "competition": "高/中/低",
      "suggestedBid": "建議出價範圍",
      "seoCategory": "SEO分類",
      "intent": "商業意圖",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "informationalKeywords": [
    {
      "keyword": "資訊查詢關鍵字",
      "searchVolume": "高/中/低",
      "competition": "高/中/低",
      "suggestedBid": "建議出價範圍",
      "seoCategory": "SEO分類",
      "intent": "資訊查詢",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "navigationalKeywords": [
    {
      "keyword": "導航查詢關鍵字",
      "searchVolume": "高/中/低",
      "competition": "高/中/低",
      "suggestedBid": "建議出價範圍",
      "seoCategory": "SEO分類",
      "intent": "導航查詢",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "transactionalKeywords": [
    {
      "keyword": "交易意圖關鍵字",
      "searchVolume": "高/中/低",
      "competition": "高/中/低",
      "suggestedBid": "建議出價範圍",
      "seoCategory": "SEO分類",
      "intent": "交易意圖",
      "languages": ["zh-tw", "en", "ja"]
    }
  ],
  "biddingStrategy": {
    "highVolumeHighCompetition": "高搜尋量高競爭度策略",
    "highVolumeLowCompetition": "高搜尋量低競爭度策略",
    "lowVolumeHighCompetition": "低搜尋量高競爭度策略",
    "lowVolumeLowCompetition": "低搜尋量低競爭度策略"
  },
  "seoCategories": {
    "headTerms": "主要關鍵字說明",
    "longTailTerms": "長尾關鍵字說明",
    "brandedTerms": "品牌關鍵字說明",
    "productTerms": "產品關鍵字說明",
    "serviceTerms": "服務關鍵字說明",
    "locationTerms": "地區關鍵字說明"
  },
  "marketInsights": [
    "市場洞察1",
    "市場洞察2"
  ]
}

重要：請確保回傳的是純 JSON 格式，不要包含任何 markdown 標記。`;
        }
        
        // 關鍵字分類
        function categorizeKeywords(aiSuggestions, keywordTypes) {
            const categorized = {
                primary: [],
                longTail: [],
                commercial: [],
                informational: [],
                navigational: [],
                transactional: [],
                totalCount: 0
            };
            
            // 根據選擇的類型分類關鍵字
            if (keywordTypes.primary && aiSuggestions.primaryKeywords) {
                categorized.primary = aiSuggestions.primaryKeywords;
                categorized.totalCount += aiSuggestions.primaryKeywords.length;
            }
            
            if (keywordTypes.longTail && aiSuggestions.longTailKeywords) {
                categorized.longTail = aiSuggestions.longTailKeywords;
                categorized.totalCount += aiSuggestions.longTailKeywords.length;
            }
            
            if (keywordTypes.commercial && aiSuggestions.commercialKeywords) {
                categorized.commercial = aiSuggestions.commercialKeywords;
                categorized.totalCount += aiSuggestions.commercialKeywords.length;
            }
            
            if (keywordTypes.informational && aiSuggestions.informationalKeywords) {
                categorized.informational = aiSuggestions.informationalKeywords;
                categorized.totalCount += aiSuggestions.informationalKeywords.length;
            }
            
            if (keywordTypes.navigational && aiSuggestions.navigationalKeywords) {
                categorized.navigational = aiSuggestions.navigationalKeywords;
                categorized.totalCount += aiSuggestions.navigationalKeywords.length;
            }
            
            if (keywordTypes.transactional && aiSuggestions.transactionalKeywords) {
                categorized.transactional = aiSuggestions.transactionalKeywords;
                categorized.totalCount += aiSuggestions.transactionalKeywords.length;
            }
            
            // 添加出價策略和SEO分類
            categorized.biddingStrategy = aiSuggestions.biddingStrategy || {};
            categorized.seoCategories = aiSuggestions.seoCategories || {};
            categorized.marketInsights = aiSuggestions.marketInsights || [];
            
            return categorized;
        }
        
        // 更新關鍵字顯示
        function updateKeywordDisplay(categorizedKeywords) {
            try {
                // 更新主要關鍵字
                const primaryTextarea = document.getElementById('primary-keywords-step3');
                if (primaryTextarea) {
                    const primaryKeywords = categorizedKeywords.primary.map(k => k.keyword).join('\n');
                    primaryTextarea.value = primaryKeywords;
                }
                
                // 更新長尾關鍵字
                const longTailTextarea = document.getElementById('long-tail-keywords-step3');
                if (longTailTextarea) {
                    const longTailKeywords = categorizedKeywords.longTail.map(k => k.keyword).join('\n');
                    longTailTextarea.value = longTailKeywords;
                }
                
                // 儲存完整關鍵字資料
                state.analysisData.categorizedKeywords = categorizedKeywords;
                
            } catch (error) {
                console.error('更新關鍵字顯示失敗:', error);
            }
        }
        
        // 獲取選擇的關鍵字類型
        function getSelectedKeywordTypes() {
            return {
                primary: document.getElementById('keyword-primary')?.checked || false,
                longTail: document.getElementById('keyword-longtail')?.checked || false,
                commercial: document.getElementById('keyword-commercial')?.checked || false,
                informational: document.getElementById('keyword-informational')?.checked || false,
                navigational: document.getElementById('keyword-navigational')?.checked || false,
                transactional: document.getElementById('keyword-transactional')?.checked || false
            };
        }
        
        // 生成搜尋查詢
        function generateSearchQueries(brand, industry, businessModel) {
            const queries = [
                `${brand} ${industry}`,
                `${industry} ${businessModel}`,
                `${brand} 競爭對手`,
                `${industry} 市場分析`,
                `${businessModel} 關鍵字`,
                `${brand} 產品服務`,
                `${industry} 趨勢`,
                `${businessModel} 行銷策略`
            ];
            
            return queries;
        }
        
        // 模板關鍵字建議（回退方案）
        function generateTemplateKeywordSuggestions(brand, industry, businessModel, products) {
            const productNames = products.map(p => p.name || p).join(' ');
            
            return {
                primaryKeywords: [
                    {
                        keyword: `${brand} ${industry}`,
                        searchVolume: "高",
                        competition: "中",
                        suggestedBid: "NT$ 15-25",
                        seoCategory: "品牌+行業",
                        intent: "品牌搜尋",
                        languages: ["zh-tw", "en"]
                    },
                    {
                        keyword: `${industry} 推薦`,
                        searchVolume: "高",
                        competition: "高",
                        suggestedBid: "NT$ 20-35",
                        seoCategory: "推薦搜尋",
                        intent: "資訊查詢",
                        languages: ["zh-tw", "en"]
                    }
                ],
                longTailKeywords: [
                    {
                        keyword: `${brand} ${industry} ${businessModel}`,
                        searchVolume: "中",
                        competition: "低",
                        suggestedBid: "NT$ 8-15",
                        seoCategory: "長尾關鍵字",
                        intent: "精準搜尋",
                        languages: ["zh-tw", "en"]
                    }
                ],
                commercialKeywords: [
                    {
                        keyword: `${industry} 價格`,
                        searchVolume: "高",
                        competition: "高",
                        suggestedBid: "NT$ 25-40",
                        seoCategory: "商業意圖",
                        intent: "商業意圖",
                        languages: ["zh-tw", "en"]
                    }
                ],
                biddingStrategy: {
                    highVolumeHighCompetition: "建議出價 NT$ 25-40，專注於高轉換率",
                    highVolumeLowCompetition: "建議出價 NT$ 15-25，擴大市場份額",
                    lowVolumeHighCompetition: "建議出價 NT$ 8-15，精準定位",
                    lowVolumeLowCompetition: "建議出價 NT$ 5-12，低成本測試"
                },
                seoCategories: {
                    headTerms: "主要關鍵字：搜尋量大，競爭度高",
                    longTailTerms: "長尾關鍵字：搜尋量小，競爭度低，轉換率高",
                    brandedTerms: "品牌關鍵字：品牌相關搜尋",
                    productTerms: "產品關鍵字：具體產品搜尋",
                    serviceTerms: "服務關鍵字：服務相關搜尋",
                    locationTerms: "地區關鍵字：地理位置相關"
                },
                marketInsights: [
                    `${industry} 市場呈現穩定成長趨勢`,
                    `${businessModel} 模式在 ${industry} 中具有競爭優勢`
                ]
            };
        }
        
        // 回退搜尋結果
        function getFallbackSearchResults(brand, industry, businessModel) {
            return [
                { title: `${brand} ${industry} 官方網站` },
                { title: `${industry} ${businessModel} 服務` },
                { title: `${brand} 產品介紹` },
                { title: `${industry} 市場分析報告` },
                { title: `${businessModel} 成功案例` }
            ];
        }

        // 下載關鍵字報告
        function downloadKeywordReport() {
            try {
                const categorizedKeywords = state.analysisData.categorizedKeywords;
                if (!categorizedKeywords) {
                    showAlert('請先執行智能關鍵字搜尋', '沒有關鍵字資料可供下載', 'warning');
                    return;
                }

                const brand = state.analysisData.brand?.name || '未指定';
                const industry = state.analysisData.industry?.category || '未指定';
                const businessModel = document.getElementById('business-model-select-step3')?.value || '未指定';
                
                let reportContent = `智能關鍵字建議書\n`;
                reportContent += `品牌: ${brand}\n`;
                reportContent += `行業: ${industry}\n`;
                reportContent += `商業模式: ${businessModel}\n`;
                reportContent += `生成時間: ${new Date().toLocaleString('zh-TW')}\n`;
                reportContent += `總關鍵字數量: ${categorizedKeywords.totalCount}\n\n`;
                
                // 主要關鍵字
                if (categorizedKeywords.primary && categorizedKeywords.primary.length > 0) {
                    reportContent += `=== 主要關鍵字 ===\n`;
                    categorizedKeywords.primary.forEach((keyword, index) => {
                        reportContent += `${index + 1}. ${keyword.keyword}\n`;
                        reportContent += `   搜尋量: ${keyword.searchVolume} | 競爭度: ${keyword.competition}\n`;
                        reportContent += `   建議出價: ${keyword.suggestedBid} | SEO分類: ${keyword.seoCategory}\n`;
                        reportContent += `   搜尋意圖: ${keyword.intent} | 語言: ${keyword.languages.join(', ')}\n\n`;
                    });
                }
                
                // 長尾關鍵字
                if (categorizedKeywords.longTail && categorizedKeywords.longTail.length > 0) {
                    reportContent += `=== 長尾關鍵字 ===\n`;
                    categorizedKeywords.longTail.forEach((keyword, index) => {
                        reportContent += `${index + 1}. ${keyword.keyword}\n`;
                        reportContent += `   搜尋量: ${keyword.searchVolume} | 競爭度: ${keyword.competition}\n`;
                        reportContent += `   建議出價: ${keyword.suggestedBid} | SEO分類: ${keyword.seoCategory}\n`;
                        reportContent += `   搜尋意圖: ${keyword.intent} | 語言: ${keyword.languages.join(', ')}\n\n`;
                    });
                }
                
                // 商業意圖關鍵字
                if (categorizedKeywords.commercial && categorizedKeywords.commercial.length > 0) {
                    reportContent += `=== 商業意圖關鍵字 ===\n`;
                    categorizedKeywords.commercial.forEach((keyword, index) => {
                        reportContent += `${index + 1}. ${keyword.keyword}\n`;
                        reportContent += `   搜尋量: ${keyword.searchVolume} | 競爭度: ${keyword.competition}\n`;
                        reportContent += `   建議出價: ${keyword.suggestedBid} | SEO分類: ${keyword.seoCategory}\n`;
                        reportContent += `   搜尋意圖: ${keyword.intent} | 語言: ${keyword.languages.join(', ')}\n\n`;
                    });
                }
                
                // 出價策略
                if (categorizedKeywords.biddingStrategy) {
                    reportContent += `=== 出價策略建議 ===\n`;
                    Object.entries(categorizedKeywords.biddingStrategy).forEach(([key, value]) => {
                        reportContent += `${key}: ${value}\n`;
                    });
                    reportContent += `\n`;
                }
                
                // 市場洞察
                if (categorizedKeywords.marketInsights && categorizedKeywords.marketInsights.length > 0) {
                    reportContent += `=== 市場洞察 ===\n`;
                    categorizedKeywords.marketInsights.forEach((insight, index) => {
                        reportContent += `${index + 1}. ${insight}\n`;
                    });
                    reportContent += `\n`;
                }
                
                // 下載檔案
                const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${brand}_關鍵字建議書_${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('下載成功', '關鍵字建議書已下載', 'success');
                
            } catch (error) {
                console.error('下載關鍵字報告失敗:', error);
                showAlert('下載失敗', '無法生成關鍵字報告', 'error');
            }
        }
        
        // 下載關鍵字 CSV
        function downloadKeywordCSV() {
            try {
                const categorizedKeywords = state.analysisData.categorizedKeywords;
                if (!categorizedKeywords) {
                    showAlert('請先執行智能關鍵字搜尋', '沒有關鍵字資料可供下載', 'warning');
                    return;
                }
                
                const brand = state.analysisData.brand?.name || '未指定';
                
                // CSV 標題
                let csvContent = '關鍵字,搜尋量,競爭度,建議出價,SEO分類,搜尋意圖,語言,類型\n';
                
                // 收集所有關鍵字
                const allKeywords = [];
                
                if (categorizedKeywords.primary) {
                    categorizedKeywords.primary.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: '主要關鍵字'
                        });
                    });
                }
                
                if (categorizedKeywords.longTail) {
                    categorizedKeywords.longTail.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: '長尾關鍵字'
                        });
                    });
                }
                
                if (categorizedKeywords.commercial) {
                    categorizedKeywords.commercial.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: '商業意圖'
                        });
                    });
                }
                
                if (categorizedKeywords.informational) {
                    categorizedKeywords.informational.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: '資訊查詢'
                        });
                    });
                }
                
                if (categorizedKeywords.navigational) {
                    categorizedKeywords.navigational.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: '導航查詢'
                        });
                    });
                }
                
                if (categorizedKeywords.transactional) {
                    categorizedKeywords.transactional.forEach(keyword => {
                        allKeywords.push({
                            ...keyword,
                            type: '交易意圖'
                        });
                    });
                }
                
                // 添加 CSV 行
                allKeywords.forEach(keyword => {
                    csvContent += `"${keyword.keyword}","${keyword.searchVolume}","${keyword.competition}","${keyword.suggestedBid}","${keyword.seoCategory}","${keyword.intent}","${keyword.languages.join(', ')}","${keyword.type}"\n`;
                });
                
                // 下載檔案
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${brand}_關鍵字清單_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('下載成功', '關鍵字 CSV 已下載', 'success');
                
            } catch (error) {
                console.error('下載關鍵字 CSV 失敗:', error);
                showAlert('下載失敗', '無法生成關鍵字 CSV', 'error');
            }
        }
        
        // 更新關鍵字建議書顯示
        function updateKeywordReportDisplay(categorizedKeywords) {
            try {
                // 更新 SEO 分類顯示
                const seoCategoriesDisplay = document.getElementById('seo-categories-display');
                if (seoCategoriesDisplay && categorizedKeywords.seoCategories) {
                    let seoHtml = '';
                    Object.entries(categorizedKeywords.seoCategories).forEach(([key, value]) => {
                        seoHtml += `
                            <div class="bg-gray-700 rounded-lg p-3">
                                <h5 class="font-semibold text-gray-200 mb-2">${key}</h5>
                                <p class="text-gray-300 text-sm">${value}</p>
                            </div>
                        `;
                    });
                    seoCategoriesDisplay.innerHTML = seoHtml;
                }
                
                // 更新出價策略顯示
                const biddingStrategyDisplay = document.getElementById('bidding-strategy-display');
                if (biddingStrategyDisplay && categorizedKeywords.biddingStrategy) {
                    let biddingHtml = '';
                    Object.entries(categorizedKeywords.biddingStrategy).forEach(([key, value]) => {
                        const colorClass = key.includes('highVolumeHighCompetition') ? 'green' :
                                         key.includes('highVolumeLowCompetition') ? 'blue' :
                                         key.includes('lowVolumeHighCompetition') ? 'yellow' : 'purple';
                        
                        biddingHtml += `
                            <div class="bg-${colorClass}-900/20 rounded-lg p-3 border border-${colorClass}-500/20">
                                <h5 class="font-semibold text-${colorClass}-400 mb-2">${key}</h5>
                                <p class="text-gray-300 text-sm">${value}</p>
                            </div>
                        `;
                    });
                    biddingStrategyDisplay.innerHTML = biddingHtml;
                }
                
                // 更新市場洞察顯示
                const marketInsightsDisplay = document.getElementById('market-insights-display');
                if (marketInsightsDisplay && categorizedKeywords.marketInsights) {
                    let insightsHtml = '';
                    categorizedKeywords.marketInsights.forEach(insight => {
                        insightsHtml += `<p class="text-gray-300 text-sm mb-2">• ${insight}</p>`;
                    });
                    marketInsightsDisplay.innerHTML = insightsHtml;
                }
                
            } catch (error) {
                console.error('更新關鍵字建議書顯示失敗:', error);
            }
        }
    </script>
</head>
<body>
    <div id="app-container" class="p-6 bg-techbg text-white min-h-screen">
        <h1 class="text-2xl font-semibold mb-6">市場情資與競品分析平台 (V6 - 進階分析版)</h1>

        <div id="alert-container"></div>

        <div id="settings-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">API 設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Google API Key</label>
                    <input type="text" id="google-api-key" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Google API Key">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Search Engine ID</label>
                    <input type="text" id="search-engine-id" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Search Engine ID">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
                    <input type="text" id="gemini-api-key" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Gemini API Key">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Intelligence Subfolder</label>
                    <input type="text" id="intelligence-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Intelligence Subfolder">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Media Plan Subfolder</label>
                    <input type="text" id="mediaplan-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Media Plan Subfolder">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Workflow Subfolder</label>
                    <input type="text" id="workflow-subfolder" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="Workflow Subfolder">
                </div>
            </div>
            <button id="save-settings-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">儲存設定</button>
        </div>

        <div id="analysis-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">分析設定</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌名稱</label>
                    <input type="text" id="brand-name" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="品牌名稱">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌網站</label>
                    <input type="text" id="brand-website" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="品牌網站">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">品牌描述</label>
                    <textarea id="brand-description" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="品牌描述"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">行業類別</label>
                    <select id="industry-category" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇行業類別</option>
                        <option value="technology">科技/電子</option>
                        <option value="finance">金融/銀行</option>
                        <option value="healthcare">醫療/健康</option>
                        <option value="retail">零售/消費</option>
                        <option value="manufacturing">製造業</option>
                        <option value="ecommerce">電商</option>
                        <option value="saas">SaaS</option>
                        <option value="fintech">金融科技</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">市場規模</label>
                    <input type="text" id="market-size" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="市場規模">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">分析主題</label>
                    <input type="text" id="analysis-topic" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="分析主題">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">競爭對手數量</label>
                    <input type="number" id="competitor-count" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="競爭對手數量">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">分析深度</label>
                    <div class="flex gap-2">
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="basic" class="form-radio">
                            <span class="ml-2">基礎分析 (搜尋量、競爭度)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="standard" class="form-radio">
                            <span class="ml-2">標準分析 (搜尋量、競爭度、出價建議)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="analysis-depth" value="comprehensive" class="form-radio">
                            <span class="ml-2">深度分析 (搜尋量、競爭度、出價建議、內容策略)</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">主要關鍵字</label>
                    <textarea id="primary-keywords" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="主要關鍵字，每行一個"></textarea>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">長尾關鍵字</label>
                    <textarea id="long-tail-keywords" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" rows="3" placeholder="長尾關鍵字，每行一個"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">商業模式</label>
                    <select id="business-model-select" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇商業模式</option>
                        <option value="b2b">B2B (企業對企業)</option>
                        <option value="b2c">B2C (企業對消費者)</option>
                        <option value="b2b2c">B2B2C (企業對企業對消費者)</option>
                        <option value="c2c">C2C (消費者對消費者)</option>
                        <option value="saas">SaaS (軟體即服務)</option>
                        <option value="marketplace">Marketplace (平台模式)</option>
                        <option value="subscription">Subscription (訂閱模式)</option>
                        <option value="freemium">Freemium (免費增值)</option>
                        <option value="ecommerce">E-commerce (電商)</option>
                        <option value="agency">Agency (代理/服務)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">本地化程度</label>
                    <select id="localization-level" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇本地化程度</option>
                        <option value="basic">基礎本地化 (翻譯) - 基本語言適應</option>
                        <option value="standard">標準本地化 (翻譯+文化適應) - 文化內容調整</option>
                        <option value="advanced">深度本地化 (完全在地化) - 完全文化適應</option>
                        <option value="native">原生本地化 (在地團隊開發) - 原生文化體驗</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">主要語言</label>
                    <select id="primary-language" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇主要語言</option>
                        <option value="zh-tw">繁體中文 (台灣)</option>
                        <option value="zh-hk">繁體中文 (香港)</option>
                        <option value="zh-cn">簡體中文 (中國)</option>
                        <option value="en">English (英語)</option>
                        <option value="ja">日本語 (日語)</option>
                        <option value="ko">한국어 (韓語)</option>
                        <option value="th">ไทย (泰語)</option>
                        <option value="vi">Tiếng Việt (越南語)</option>
                        <option value="id">Bahasa Indonesia (印尼語)</option>
                        <option value="ms">Bahasa Melayu (馬來語)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">目標客群</label>
                    <select id="target-audience" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20">
                        <option value="">請選擇目標客群</option>
                        <option value="startup">新創公司 - 成本敏感，快速決策</option>
                        <option value="sme">中小企業 - 實用導向，性價比重要</option>
                        <option value="enterprise">大型企業 - 品質要求高，決策週期長</option>
                        <option value="freelancer">自由工作者 - 靈活性重要，成本控制</option>
                        <option value="student">學生 - 價格敏感，功能需求</option>
                        <option value="professional">專業人士 - 品質要求高，效率重要</option>
                        <option value="consumer">一般消費者 - 用戶體驗，情感訴求</option>
                        <option value="elderly">銀髮族 - 易用性，信任建立</option>
                        <option value="youth">年輕族群 - 創新，社交分享</option>
                        <option value="parent">家長 - 安全，品質，教育價值</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">項目 ID</label>
                    <input type="text" id="project-id" class="w-full px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="項目 ID">
                </div>
            </div>
            
            <!-- 產品管理 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-4">
                <h4 class="font-semibold text-gray-200 mb-4">📦 產品/服務管理</h4>
                <div id="products-container" class="space-y-3 mb-4">
                    <!-- 產品項目將在這裡動態生成 -->
                </div>
                <button id="add-product-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">添加產品</button>
            </div>
            
            <div class="flex gap-4">
                <button id="start-analysis-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">開始分析</button>
                <button id="generate-report-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">生成報告</button>
            </div>
        </div>

        <div id="history-panel" class="bg-techpanel rounded-lg p-6 mb-6">
            <h2 class="text-lg font-semibold mb-4">歷史紀錄</h2>
            <div id="auto-search-results"></div>
        </div>

        <!-- 步驟導航 -->
        <div class="flex justify-center mb-6">
            <div class="flex space-x-4">
                <button id="step-1-btn" class="step-btn active bg-techprimary text-white px-6 py-2 rounded-lg" onclick="goToStep(1)">
                    步驟 1: 設定分析
                </button>
                <button id="step-2-btn" class="step-btn bg-gray-600 text-gray-300 px-6 py-2 rounded-lg" onclick="goToStep(2)">
                    步驟 2: 對手篩選
                </button>
                <button id="step-3-btn" class="step-btn bg-gray-600 text-gray-300 px-6 py-2 rounded-lg" onclick="goToStep(3)">
                    步驟 3: 生成報告
                </button>
            </div>
        </div>

        <div id="step-1" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 1: 設定分析</h3>
            <p class="text-gray-300 mb-4">請在上方的分析設定面板中填寫必要資訊，然後點擊「開始分析」按鈕。</p>
            
            <!-- 開始分析按鈕 -->
            <div class="flex justify-center">
                <button id="start-analysis-btn" class="bg-techprimary hover:bg-techaccent text-white px-6 py-3 rounded-lg text-lg font-semibold">開始分析</button>
            </div>
        </div>

        <div id="step-2" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 2: 競爭對手分析</h3>
            
            <!-- 當前分析主題 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-2">📊 當前分析主題</h4>
                <p class="text-gray-300">分析主題: <span id="current-topic" class="text-techaccent font-semibold">未設定</span></p>
            </div>
            
            <!-- 自動搜尋結果 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">🔍 行業競爭對手分析</h4>
                <div id="auto-search-results" class="space-y-4">
                    <p class="text-gray-400">正在載入競爭對手分析...</p>
                </div>
            </div>
            
            <!-- 手動添加競爭對手 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">➕ 手動添加競爭對手</h4>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="manual-competitor" class="flex-1 px-3 py-2 rounded bg-techbg border border-techprimary/20" placeholder="競爭對手名稱（用逗號分隔多個）">
                    <button id="add-competitor-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded">添加</button>
                </div>
                <p class="text-gray-400 text-sm">說明：輸入競爭對手名稱，多個競爭對手請用逗號分隔</p>
            </div>
            
            <!-- 已選擇的競爭對手 -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h4 class="font-semibold text-gray-200 mb-4">✅ 已選擇的競爭對手 (<span id="selected-count">0</span>)</h4>
                <div id="selected-competitors" class="space-y-2">
                    <p class="text-gray-500 text-sm">尚未選擇任何競爭對手</p>
                </div>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="flex justify-between items-center">
                <button id="back-to-step1-btn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">返回步驟 1</button>
                <button id="generate-report-btn" class="bg-techprimary hover:bg-techaccent text-white px-4 py-2 rounded" disabled>生成完整報告</button>
            </div>
        </div>

        <div id="step-3" class="step-panel">
            <h3 class="text-lg font-semibold mb-4">步驟 3: 生成報告</h3>
            <div id="final-report-content"></div>
        </div>
    </div>
</body>
</html>
